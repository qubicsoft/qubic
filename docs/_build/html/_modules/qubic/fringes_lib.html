<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>qubic.fringes_lib &mdash; Qubicsoft 5.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=ee801c84"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Qubicsoft
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Qubicsoft</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">qubic.fringes_lib</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for qubic.fringes_lib</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span> <span class="k">as</span> <span class="n">pyfits</span>
<span class="kn">from</span> <span class="nn">astropy.convolution</span> <span class="kn">import</span> <span class="n">convolve</span><span class="p">,</span> <span class="n">Gaussian2DKernel</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_pdf</span> <span class="kn">import</span> <span class="n">PdfPages</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">sop</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">resample</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="kn">import</span> <span class="n">sigma_clip</span>

<span class="kn">from</span> <span class="nn">qubicpack.qubicfp</span> <span class="kn">import</span> <span class="n">qubicfp</span>
<span class="kn">import</span> <span class="nn">qubic.fibtools</span> <span class="k">as</span> <span class="nn">ft</span>
<span class="kn">from</span> <span class="nn">qubic</span> <span class="kn">import</span> <span class="n">selfcal_lib</span> <span class="k">as</span> <span class="n">scal</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;FringesAnalysis&#39;</span><span class="p">,</span> <span class="s1">&#39;SaveFringesFitsPdf&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="FringesAnalysis">
<a class="viewcode-back" href="../../qubic.html#qubic.fringes_lib.FringesAnalysis">[docs]</a>
<span class="k">class</span> <span class="nc">FringesAnalysis</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datafolder</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">baseline</span><span class="p">,</span> <span class="n">ncycles</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">stable_time</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span>
                 <span class="n">asics</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">src_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">subtract_t0</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">refTESnum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refASICnum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allh</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span> <span class="n">nsp_per</span><span class="o">=</span><span class="mi">240</span><span class="p">,</span>
                 <span class="n">lowcut</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">highcut</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">notch</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.724</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">,</span> <span class="mi">10</span><span class="p">]]),</span>
                 <span class="n">fraction_bad_TES</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">sigma_conv_astropy</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">sort_TES</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        datafolder: str</span>
<span class="sd">            Folder containing the data.</span>
<span class="sd">        date: str</span>
<span class="sd">            Date of the measurement.</span>
<span class="sd">        q: a QubicInstrument</span>
<span class="sd">        baseline: list</span>
<span class="sd">            The 2 horns.</span>
<span class="sd">        ncycles: int</span>
<span class="sd">            Number of cycles run during the data taking.</span>
<span class="sd">        stable_time: float</span>
<span class="sd">            Waiting time [s] on each step.</span>
<span class="sd">        asics: list</span>
<span class="sd">            ASIC numbers.</span>
<span class="sd">        src_data: bool</span>
<span class="sd">            If True, will return the source data as well</span>
<span class="sd">        subtract_t0: bool,</span>
<span class="sd">            If True, will remove to the time the first time element when getting data.</span>
<span class="sd">        cut: bool</span>
<span class="sd">            If True, it will cut the data at t0cut, tfcut.</span>
<span class="sd">        t0cut, tfcut: float</span>
<span class="sd">            Start and end time to cut the TODs.</span>
<span class="sd">        refTESnum, refASICnum: int</span>
<span class="sd">            One reference TES to check the period.</span>
<span class="sd">        allh: list</span>
<span class="sd">            True on the steps where all horns are open, False elsewhere.</span>
<span class="sd">        nsp_per: int</span>
<span class="sd">            Number of sample per period for resampling.</span>
<span class="sd">        lowcut, highcut: float</span>
<span class="sd">            Low and high cut for filtering.</span>
<span class="sd">        nbins: int</span>
<span class="sd">            Number of bins for filtering.</span>
<span class="sd">        notch: array</span>
<span class="sd">            Define a notch filter.</span>
<span class="sd">        fraction_bad_TES: float</span>
<span class="sd">            Fraction between 0 and 1 to set a threshold for bad TES.</span>
<span class="sd">            For example, if fraction=0.75, 1/4 of the detectors will be masked.</span>
<span class="sd">        sigma_conv_astropy: float</span>
<span class="sd">            Sigma of the Gaussian for the Astropy convolution for plots, in numbers of detectors.</span>
<span class="sd">        sort_TES: bool</span>
<span class="sd">            If False, do not sort the TES from good to bad. It can be useful in some cases, for example,</span>
<span class="sd">            when you do not want to make the full analysis but simply look at some TOD.</span>
<span class="sd">        verbose: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datafolder</span> <span class="o">=</span> <span class="n">datafolder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="n">date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">q</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span> <span class="o">=</span> <span class="n">baseline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncycles</span> <span class="o">=</span> <span class="n">ncycles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asics</span> <span class="o">=</span> <span class="n">asics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_data</span> <span class="o">=</span> <span class="n">src_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subtract_t0</span> <span class="o">=</span> <span class="n">subtract_t0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stable_time</span> <span class="o">=</span> <span class="n">stable_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allh</span> <span class="o">=</span> <span class="n">allh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nsp_per</span> <span class="o">=</span> <span class="n">nsp_per</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lowcut</span> <span class="o">=</span> <span class="n">lowcut</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highcut</span> <span class="o">=</span> <span class="n">highcut</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span> <span class="o">=</span> <span class="n">nbins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notch</span> <span class="o">=</span> <span class="n">notch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fraction_bad_TES</span> <span class="o">=</span> <span class="n">fraction_bad_TES</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_conv_astropy</span> <span class="o">=</span> <span class="n">sigma_conv_astropy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>

        <span class="c1"># Get data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tdata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsrc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dsrc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nasics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndet_oneASIC</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ndet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nasics</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndet_oneASIC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expected_period</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stable_time</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span>

        <span class="k">if</span> <span class="n">sort_TES</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">detectors_sort</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctimes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_TES_good2bad</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask_bad_TES</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_mask_bad_tes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detectors_sort</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fraction_bad_TES</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;******** 10 best TES found:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">detectors_sort</span><span class="p">[:</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">detectors_sort</span><span class="p">[:</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

                <span class="n">nbad_TES</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndet</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction_bad_TES</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;******** With fraction_bad_TES = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fraction_bad_TES</span><span class="si">}</span><span class="s1">, &#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">nbad_TES</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="si">}</span><span class="s1"> are considered as bad.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">refTESnum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refTESnum</span> <span class="o">=</span> <span class="n">refTESnum</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refASICnum</span> <span class="o">=</span> <span class="n">refASICnum</span>
        <span class="k">elif</span> <span class="n">refTESnum</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sort_TES</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refTESnum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detectors_sort</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refASICnum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detectors_sort</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You should either give a reference TES and ASIC or set sort_TES to True.&#39;</span><span class="p">)</span>

        <span class="c1"># Reference period determine on reference TES</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refperiod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_right_period</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refTESnum</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refASICnum</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refstable_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refperiod</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span>

        <span class="c1"># Get coordinates for all TES, order as on the instrument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xTES</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yTES</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allindex_q</span> <span class="o">=</span> <span class="n">scal</span><span class="o">.</span><span class="n">get_TES_Instru_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;ONAFP&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the TODs for one ASIC.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Time and signal for all TES in one ASIC.</span>
<span class="sd">        If src_data is True: will also return the  source time and signal</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Qubicpack object</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">qubicfp</span><span class="p">()</span>
        <span class="n">a</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">a</span><span class="o">.</span><span class="n">read_qubicstudio_dataset</span><span class="p">(</span><span class="n">datadir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">datafolder</span><span class="p">)</span>

        <span class="c1"># TOD from all ASICS</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tdata</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ASIC</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">asics</span><span class="p">):</span>
            <span class="n">ASIC</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ASIC</span><span class="p">)</span>
            <span class="n">data_oneASIC</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">timeline_array</span><span class="p">(</span><span class="n">asic</span><span class="o">=</span><span class="n">ASIC</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_oneASIC</span><span class="p">)</span>
            <span class="n">tdata_oneASIC</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">timeaxis</span><span class="p">(</span><span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;science&#39;</span><span class="p">,</span> <span class="n">asic</span><span class="o">=</span><span class="n">ASIC</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subtract_t0</span><span class="p">:</span>
                <span class="n">tdata_oneASIC</span> <span class="o">-=</span> <span class="n">tdata_oneASIC</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">tdata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tdata_oneASIC</span><span class="p">)</span>
        <span class="n">tdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tdata</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># Minus because when the current goes down it means more power.</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_data</span><span class="p">:</span>  <span class="c1"># Get calibration source data</span>
            <span class="n">tsrc</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">calsource</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subtract_t0</span><span class="p">:</span>
                <span class="n">tsrc</span> <span class="o">-=</span> <span class="n">tsrc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dsrc</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">calsource</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tsrc</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">dsrc</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">tdata</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">tsrc</span><span class="p">,</span> <span class="n">dsrc</span>

<div class="viewcode-block" id="FringesAnalysis.plot_TOD">
<a class="viewcode-back" href="../../qubic.html#qubic.fringes_lib.FringesAnalysis.plot_TOD">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_TOD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ASIC</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">TES</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">)):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the TODs for a given TES. if TES is None, the plot is done for the reference TES.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ASIC: int</span>
<span class="sd">            ASIC number, 1 or 2 for the TD.</span>
<span class="sd">        TES: int</span>
<span class="sd">            TES index, between 1 and 128.</span>
<span class="sd">        xlim: float</span>
<span class="sd">            Upper abscissa limit.</span>
<span class="sd">        figsize: bytearray</span>
<span class="sd">            Size of the figure, as in matplotlib.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ASIC</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ASIC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refASICnum</span>
            <span class="n">TES</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refTESnum</span>
        <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tdata</span><span class="p">[</span><span class="n">ASIC</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">TOD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ASIC</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">TOD</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;TOD for TES </span><span class="si">{</span><span class="n">TES</span><span class="si">}</span><span class="s1"> - ASIC </span><span class="si">{</span><span class="n">ASIC</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xlim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xlim</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="FringesAnalysis.find_right_period">
<a class="viewcode-back" href="../../qubic.html#qubic.fringes_lib.FringesAnalysis.find_right_period">[docs]</a>
    <span class="k">def</span> <span class="nf">find_right_period</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">TES</span><span class="p">,</span> <span class="n">ASIC</span><span class="p">,</span> <span class="n">filtering</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">nb</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the true period of one cycle.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        TES, ASIC: int</span>
<span class="sd">            TES and ASIC numbers.</span>
<span class="sd">        filtering: bool</span>
<span class="sd">            If True, data are filtered.</span>
<span class="sd">        delta: float</span>
<span class="sd">        nb: int</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filtering</span><span class="p">:</span>
            <span class="n">thedata</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">filter_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tdata</span><span class="p">[</span><span class="n">ASIC</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ASIC</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">lowcut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">highcut</span><span class="p">,</span> <span class="n">notch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">notch</span><span class="p">,</span> <span class="n">rebin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">thedata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ASIC</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">ppp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expected_period</span> <span class="o">-</span> <span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_period</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span> <span class="n">nb</span><span class="p">)</span>
        <span class="n">rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ppp</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ppp</span><span class="p">)):</span>
            <span class="n">xin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tdata</span><span class="p">[</span><span class="n">ASIC</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">%</span> <span class="n">ppp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">o</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="n">xin</span><span class="p">,</span> <span class="n">thedata</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">rms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>
        <span class="n">period</span> <span class="o">=</span> <span class="n">ppp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">rms</span><span class="p">)]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found period </span><span class="si">{0:5.3f}</span><span class="s1">s on TES </span><span class="si">{1:}</span><span class="s1"> ASIC </span><span class="si">{2:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">TES</span><span class="p">,</span> <span class="n">ASIC</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expected : &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_period</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ppp</span><span class="p">,</span> <span class="n">rms</span><span class="p">,</span> <span class="n">period</span></div>


<div class="viewcode-block" id="FringesAnalysis.sort_TES_good2bad">
<a class="viewcode-back" href="../../qubic.html#qubic.fringes_lib.FringesAnalysis.sort_TES_good2bad">[docs]</a>
    <span class="k">def</span> <span class="nf">sort_TES_good2bad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">median</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make a fit on the TODs, fit the steps of the cycle with time constants.</span>
<span class="sd">        The residuals are used to order the TES from the best to the worst.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        median: bool</span>
<span class="sd">            If True, a median and not a mean is done when folding the data using a function from fibtools.</span>
<span class="sd">        doplot: bool</span>
<span class="sd">            If True, a plot is made for the 5 best TES.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Time, folded signal, the 8 parameters estimated with the fit,</span>
<span class="sd">        the combination of the amplitudes, the period and the residuals</span>
<span class="sd">        between the fit and the signal. They are computed for each TES.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ctimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nasics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndet_oneASIC</span><span class="p">))</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">err_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">datafold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">))</span>
        <span class="n">err_datafold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">datafold</span><span class="p">)</span>
        <span class="n">residuals_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">datafold</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;******** Start sort TES from good to bad.***********&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ASIC</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">asics</span><span class="p">):</span>
            <span class="c1"># Filter, fold and normalize the data</span>
            <span class="n">dfold</span><span class="p">,</span> <span class="n">tfold</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">errfold</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">fold_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tdata</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">expected_period</span><span class="p">,</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">lowcut</span><span class="p">,</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">highcut</span><span class="p">,</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span>
                                                          <span class="n">notch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">notch</span><span class="p">,</span>
                                                          <span class="n">median</span><span class="o">=</span><span class="n">median</span><span class="p">,</span>
                                                          <span class="n">return_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                          <span class="n">silent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
                                                          <span class="p">)</span>

            <span class="n">datafold</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ndet_oneASIC</span> <span class="o">*</span> <span class="n">i</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">ndet_oneASIC</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">dfold</span>
            <span class="n">err_datafold</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ndet_oneASIC</span> <span class="o">*</span> <span class="n">i</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">ndet_oneASIC</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">errfold</span>

            <span class="c1"># Fit</span>
            <span class="n">param_guess</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mf">1.</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndet_oneASIC</span><span class="p">):</span>
                <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndet_oneASIC</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span>
                <span class="c1"># With curve_fit, it is not possible to have &#39;args&#39; so we use a lambda function</span>
                <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">sop</span><span class="o">.</span><span class="n">curve_fit</span><span class="p">(</span><span class="k">lambda</span> <span class="n">tfold</span><span class="p">,</span> <span class="n">ctime</span><span class="p">,</span> <span class="n">tstart</span><span class="p">,</span> <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">a5</span><span class="p">:</span>
                                           <span class="n">ft</span><span class="o">.</span><span class="n">simsig_fringes</span><span class="p">(</span><span class="n">tfold</span><span class="p">,</span>
                                                             <span class="bp">self</span><span class="o">.</span><span class="n">stable_time</span><span class="p">,</span>
                                                             <span class="p">[</span><span class="n">ctime</span><span class="p">,</span> <span class="n">tstart</span><span class="p">,</span> <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">a5</span><span class="p">]),</span>
                                           <span class="n">tfold</span><span class="p">,</span>
                                           <span class="n">dfold</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:],</span>
                                           <span class="n">p0</span><span class="o">=</span><span class="n">param_guess</span><span class="p">,</span>
                                           <span class="n">sigma</span><span class="o">=</span><span class="n">errfold</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:],</span>
                                           <span class="n">absolute_sigma</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                           <span class="n">bounds</span><span class="o">=</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">],</span>
                                                   <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span>
                                           <span class="n">maxfev</span><span class="o">=</span><span class="mi">10000</span>
                                           <span class="p">)</span>
                <span class="n">params</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">popt</span>
                <span class="c1"># Take the time constant of the detectors</span>
                <span class="n">ctimes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">err_params</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">pcov</span><span class="p">))</span>

                <span class="n">residuals_time</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">dfold</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">ft</span><span class="o">.</span><span class="n">simsig_fringes</span><span class="p">(</span><span class="n">tfold</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stable_time</span><span class="p">,</span> <span class="n">popt</span><span class="p">)</span>

        <span class="c1"># Order the TES as function of the residual on the fit</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">residuals_time</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">std_argsort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">std</span><span class="p">)</span>
        <span class="n">detectors_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">detectors_sort</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">std_argsort</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndet_oneASIC</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># TES</span>
        <span class="n">detectors_sort</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">std_argsort</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndet_oneASIC</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># ASIC</span>

        <span class="c1"># Plot the 5 best TES</span>
        <span class="k">if</span> <span class="n">doplot</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_plot_folding_fit</span><span class="p">(</span><span class="n">detectors_sort</span><span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">detectors_sort</span><span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">tfold</span><span class="p">,</span> <span class="n">datafold</span><span class="p">,</span> <span class="n">residuals_time</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">expected_period</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">err_params</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">detectors_sort</span><span class="p">,</span> <span class="n">ctimes</span></div>


<div class="viewcode-block" id="FringesAnalysis.make_mask_bad_tes">
<a class="viewcode-back" href="../../qubic.html#qubic.fringes_lib.FringesAnalysis.make_mask_bad_tes">[docs]</a>
    <span class="k">def</span> <span class="nf">make_mask_bad_tes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detectors_sort</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.75</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        detectors_sort: array</span>
<span class="sd">            TES numbers ordered from the best to the worst.</span>
<span class="sd">            It is a 2D array containing the TES and the ASIC index.</span>
<span class="sd">        fraction: float</span>
<span class="sd">            Fraction between 0 and 1 to set a threshold for bad TES.</span>
<span class="sd">            For example, if fraction=0.75, 1/4 of the detectors will be masked.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mask: 1 for good TES and NAN for bad TES.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="p">)</span>
        <span class="c1"># All TES in a 1D array from 1 to 128*nasics</span>
        <span class="n">alldet</span> <span class="o">=</span> <span class="n">detectors_sort</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndet_oneASIC</span> <span class="o">*</span> <span class="p">(</span><span class="n">detectors_sort</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">alldet</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">fraction</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="p">):]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="n">mask</span></div>


<div class="viewcode-block" id="FringesAnalysis.find_high_derivative_clusters">
<a class="viewcode-back" href="../../qubic.html#qubic.fringes_lib.FringesAnalysis.find_high_derivative_clusters">[docs]</a>
    <span class="k">def</span> <span class="nf">find_high_derivative_clusters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tfold</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">period</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Find clusters of high derivatives: each time we take the first high derivative element.&quot;&quot;&quot;</span>

        <span class="n">t_change</span> <span class="o">=</span> <span class="n">tfold</span><span class="p">[</span><span class="n">thr</span><span class="p">]</span>
        <span class="n">expected_stable_time</span> <span class="o">=</span> <span class="n">period</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span>
        <span class="n">start_times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">incluster</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_change</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">incluster</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">start_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t_change</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">incluster</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">t_change</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_change</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">expected_stable_time</span> <span class="o">*</span> <span class="mf">0.6</span><span class="p">):</span>
                    <span class="n">incluster</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">start_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">start_times</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">start_times</span></div>


<div class="viewcode-block" id="FringesAnalysis.find_t0">
<a class="viewcode-back" href="../../qubic.html#qubic.fringes_lib.FringesAnalysis.find_t0">[docs]</a>
    <span class="k">def</span> <span class="nf">find_t0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find time where configuration change in the square modulation using the reference TES.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Resample and fold</span>
        <span class="n">timeTES</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tdata</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">refASICnum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dataTES</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">refASICnum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refTESnum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">tfold</span><span class="p">,</span> <span class="n">dfold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resample_fold_oneTES</span><span class="p">(</span><span class="n">timeTES</span><span class="p">,</span> <span class="n">dataTES</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Average the signal over all periods</span>
        <span class="n">msignal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dfold</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Calculate the derivative and find where it is high</span>
        <span class="n">dsignal</span><span class="p">,</span> <span class="n">thr</span> <span class="o">=</span> <span class="n">find_high_derivative</span><span class="p">(</span><span class="n">msignal</span><span class="p">)</span>

        <span class="c1"># Find clusters of high derivatives</span>
        <span class="n">start_times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_high_derivative_clusters</span><span class="p">(</span><span class="n">tfold</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>

        <span class="c1"># Now we take the median of all start_times modulo period/nsteps</span>
        <span class="n">expected_stable_time</span> <span class="o">=</span> <span class="n">period</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">start_times</span> <span class="o">%</span> <span class="n">expected_stable_time</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">doplot</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_finding_t0</span><span class="p">(</span><span class="n">tfold</span><span class="p">,</span> <span class="n">msignal</span><span class="p">,</span> <span class="n">dsignal</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">start_times</span><span class="p">,</span> <span class="n">t0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t0</span></div>


<div class="viewcode-block" id="FringesAnalysis.resample_fold_oneTES">
<a class="viewcode-back" href="../../qubic.html#qubic.fringes_lib.FringesAnalysis.resample_fold_oneTES">[docs]</a>
    <span class="k">def</span> <span class="nf">resample_fold_oneTES</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeTES</span><span class="p">,</span> <span class="n">dataTES</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="c1"># First Step: Data Filtering</span>
        <span class="n">dfilter</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">filter_data</span><span class="p">(</span><span class="n">timeTES</span><span class="p">,</span> <span class="n">dataTES</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowcut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">highcut</span><span class="p">,</span> <span class="n">notch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">notch</span><span class="p">,</span> <span class="n">rebin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Crop the data in order to have an integer number of periods</span>
        <span class="n">tcrop</span><span class="p">,</span> <span class="n">dcrop</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cut_data_Nperiods</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">timeTES</span><span class="p">,</span> <span class="n">dfilter</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>

        <span class="c1"># Resample the signal</span>
        <span class="n">newtime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">tcrop</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tcrop</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncycles</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsp_per</span><span class="p">)</span>
        <span class="n">newdata</span> <span class="o">=</span> <span class="n">resample</span><span class="p">(</span><span class="n">dcrop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncycles</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsp_per</span><span class="p">)</span>

        <span class="c1"># Fold the data</span>
        <span class="n">tfold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsp_per</span><span class="p">)</span>
        <span class="n">dfold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">newdata</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncycles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsp_per</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">doplot</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">newtime</span><span class="p">,</span> <span class="n">newdata</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;ADU&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;TODs crop and resample&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tfold</span><span class="p">,</span> <span class="n">dfold</span></div>


<div class="viewcode-block" id="FringesAnalysis.roll_oneTES">
<a class="viewcode-back" href="../../qubic.html#qubic.fringes_lib.FringesAnalysis.roll_oneTES">[docs]</a>
    <span class="k">def</span> <span class="nf">roll_oneTES</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dfold</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shift the folded data in order to have t0=0.&quot;&quot;&quot;</span>

        <span class="n">droll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">dfold</span><span class="p">,</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">t0</span> <span class="o">/</span> <span class="n">period</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsp_per</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">droll</span></div>


<div class="viewcode-block" id="FringesAnalysis.remove_median_allh">
<a class="viewcode-back" href="../../qubic.html#qubic.fringes_lib.FringesAnalysis.remove_median_allh">[docs]</a>
    <span class="k">def</span> <span class="nf">remove_median_allh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tfold</span><span class="p">,</span> <span class="n">droll</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">skip_rise</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">skip_fall</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
        <span class="c1"># Roughly remove the median of the all_h configurations</span>
        <span class="n">ok_all_horns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">tfold</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allh</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">tmini</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">period</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">+</span> <span class="n">skip_rise</span>
                <span class="n">tmaxi</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">period</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">-</span> <span class="n">skip_fall</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">tfold</span> <span class="o">&gt;=</span> <span class="n">tmini</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tfold</span> <span class="o">&lt;</span> <span class="n">tmaxi</span><span class="p">)</span>
                <span class="n">ok_all_horns</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">droll_rm_median</span> <span class="o">=</span> <span class="n">droll</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">droll</span><span class="p">[:,</span> <span class="n">ok_all_horns</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">droll_rm_median</span></div>


<div class="viewcode-block" id="FringesAnalysis.remove_slope_percycle">
<a class="viewcode-back" href="../../qubic.html#qubic.fringes_lib.FringesAnalysis.remove_slope_percycle">[docs]</a>
    <span class="k">def</span> <span class="nf">remove_slope_percycle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m_points</span><span class="p">,</span> <span class="n">err_m_points</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit a slope between the &quot;all horns open&quot; configurations (3 points) and remove it.</span>
<span class="sd">        Do it for each cycle.&quot;&quot;&quot;</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">)</span>
        <span class="n">m_points_rm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">m_points</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncycles</span><span class="p">):</span>

            <span class="c1"># Linear fit</span>
            <span class="n">pars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xx</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">allh</span><span class="p">],</span>
                              <span class="n">y</span><span class="o">=</span><span class="n">m_points</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allh</span><span class="p">],</span>
                              <span class="n">deg</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">w</span><span class="o">=</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">err_m_points</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allh</span><span class="p">],</span>
                              <span class="n">full</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">cov</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># Subtract the slope to the 6 points, the points with all horns open will be around 0 by construction</span>
            <span class="n">m_points_rm</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">m_points</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">xx</span> <span class="o">+</span> <span class="n">pars</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">doplot</span><span class="p">:</span>
                    <span class="n">ttt</span> <span class="o">=</span> <span class="n">xx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">stable_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stable_time</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Fit the slope on all horn open - Cycle </span><span class="si">{</span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ttt</span><span class="p">,</span> <span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">xx</span> <span class="o">+</span> <span class="n">pars</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Linear fit all open&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">ttt</span><span class="p">,</span> <span class="n">m_points</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original points&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">ttt</span><span class="p">,</span> <span class="n">m_points_rm</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;After correction&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time[s]&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Amplitude&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">m_points_rm</span></div>


<div class="viewcode-block" id="FringesAnalysis.remove_slope_allcycles">
<a class="viewcode-back" href="../../qubic.html#qubic.fringes_lib.FringesAnalysis.remove_slope_allcycles">[docs]</a>
    <span class="k">def</span> <span class="nf">remove_slope_allcycles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m_points</span><span class="p">,</span> <span class="n">err_m_points</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit a slope between the &quot;all horns open&quot; configurations and remove it.</span>
<span class="sd">        Finally this function is not used for the fringes analysis, I prefer removing the slope cycle by cycle. &quot;&quot;&quot;</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncycles</span><span class="p">)</span>

        <span class="c1"># Linear fit</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xx</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">allh</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncycles</span><span class="p">],</span>
                          <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">m_points</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allh</span><span class="p">]),</span>
                          <span class="n">deg</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">w</span><span class="o">=</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">err_m_points</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allh</span><span class="p">]),</span>
                          <span class="n">full</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">cov</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Subtract the slope to the points, take the first point as the reference</span>
        <span class="n">ref</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">meancut</span><span class="p">(</span><span class="n">m_points</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allh</span><span class="p">],</span> <span class="n">nsig</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">m_points_rm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">m_points</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">xx</span> <span class="o">+</span> <span class="n">pars</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">ref</span>

        <span class="n">m_points_rm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">m_points_rm</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncycles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">doplot</span><span class="p">:</span>
            <span class="n">ttt</span> <span class="o">=</span> <span class="n">xx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">stable_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stable_time</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Fit the slope on all horn open - All cycles&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ttt</span><span class="p">,</span> <span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">xx</span> <span class="o">+</span> <span class="n">pars</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;fit&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ttt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">m_points</span><span class="p">),</span> <span class="s1">&#39;bo&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original points&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ttt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">m_points_rm</span><span class="p">),</span> <span class="s1">&#39;ro&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;After correction&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time[s]&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Amplitude&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">m_points_rm</span></div>


<div class="viewcode-block" id="FringesAnalysis.average_over_points_oneTES">
<a class="viewcode-back" href="../../qubic.html#qubic.fringes_lib.FringesAnalysis.average_over_points_oneTES">[docs]</a>
    <span class="k">def</span> <span class="nf">average_over_points_oneTES</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tfold</span><span class="p">,</span> <span class="n">droll</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">skip_rise</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">skip_fall</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                                   <span class="n">median</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rm_slope_percycle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Average on each step in the cycle.&quot;&quot;&quot;</span>

        <span class="c1"># We assume that the array has been np.rolled so that the t0 is in time sample 0</span>
        <span class="n">stable_time</span> <span class="o">=</span> <span class="n">period</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span>

        <span class="c1"># Remove the average of each cycle</span>
        <span class="n">droll</span> <span class="o">=</span> <span class="p">(</span><span class="n">droll</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">droll</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># Perform first an average/median in each step of each cycle over the points</span>
        <span class="c1"># (possibly skipping beginning and end)</span>
        <span class="n">m_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ncycles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">))</span>
        <span class="n">err_m_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ncycles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">):</span>
            <span class="c1"># Cut the data</span>
            <span class="n">tstart</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">stable_time</span> <span class="o">+</span> <span class="n">skip_rise</span>
            <span class="n">tend</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">stable_time</span> <span class="o">-</span> <span class="n">skip_fall</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">tfold</span> <span class="o">&gt;=</span> <span class="n">tstart</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tfold</span> <span class="o">&lt;</span> <span class="n">tend</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncycles</span><span class="p">):</span>
                <span class="n">m_points</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">err_m_points</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">meancut</span><span class="p">(</span><span class="n">droll</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">ok</span><span class="p">],</span>
                                                                <span class="n">nsig</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                                                <span class="n">med</span><span class="o">=</span><span class="n">median</span><span class="p">,</span>
                                                                <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rm_slope_percycle</span><span class="p">:</span>
            <span class="n">m_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_slope_percycle</span><span class="p">(</span><span class="n">m_points</span><span class="p">,</span> <span class="n">err_m_points</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="n">doplot</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m_points</span><span class="p">,</span> <span class="n">err_m_points</span></div>


<div class="viewcode-block" id="FringesAnalysis.average_over_cycles_oneTES">
<a class="viewcode-back" href="../../qubic.html#qubic.fringes_lib.FringesAnalysis.average_over_cycles_oneTES">[docs]</a>
    <span class="k">def</span> <span class="nf">average_over_cycles_oneTES</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m_points</span><span class="p">,</span> <span class="n">err_m_points</span><span class="p">,</span> <span class="n">median</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">Ncycles_to_use</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">speak</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        m_points, err_m_points: float</span>
<span class="sd">            Mean and errors on each step for one TES.</span>
<span class="sd">        median: bool</span>
<span class="sd">            If True, takes the median and not the mean on each folded step.</span>
<span class="sd">        Ncycles_to_use: int</span>
<span class="sd">            Number of cycles to use. If None, all cycles will be used.</span>
<span class="sd">        speak: bool</span>
<span class="sd">        doplot: bool</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">Ncycles_to_use</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Ncycles_to_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncycles</span>

        <span class="c1"># Average or median over all cycles</span>
        <span class="n">Mcycles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">)</span>
        <span class="n">err_Mcycles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">):</span>
            <span class="n">Mcycles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">err_Mcycles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">meancut</span><span class="p">(</span><span class="n">m_points</span><span class="p">[:</span><span class="n">Ncycles_to_use</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">nsig</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">med</span><span class="o">=</span><span class="n">median</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">speak</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;############&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Step </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ncycles_to_use</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cycle </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1"> +/- </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">m_points</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">err_m_points</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;============&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Mean/Median: </span><span class="si">{}</span><span class="s1"> +/- </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Mcycles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">err_Mcycles</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;============&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">doplot</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_average_over_steps</span><span class="p">(</span><span class="n">m_points</span><span class="p">,</span> <span class="n">err_m_points</span><span class="p">,</span> <span class="n">Mcycles</span><span class="p">,</span> <span class="n">err_Mcycles</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Mcycles</span><span class="p">,</span> <span class="n">err_Mcycles</span></div>


<div class="viewcode-block" id="FringesAnalysis.analyse_fringes">
<a class="viewcode-back" href="../../qubic.html#qubic.fringes_lib.FringesAnalysis.analyse_fringes">[docs]</a>
    <span class="k">def</span> <span class="nf">analyse_fringes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">median</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">remove_median_allh</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">Ncycles_to_use</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">rm_slope_percycle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">force_period</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force_t0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">doplotTESsort</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Full analysis to get fringes from the TODs.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        median: bool</span>
<span class="sd">        remove_median_allh: bool</span>
<span class="sd">        Ncycles_to_use: int</span>
<span class="sd">            Number of cycles to use. If None, all cycles will be used.</span>
<span class="sd">        rm_slope_percycle: bool</span>
<span class="sd">            If True, for each cycle, a slope on the steps where all horns are open is fit</span>
<span class="sd">            and removed.</span>
<span class="sd">        force_period: float</span>
<span class="sd">            If None, the period is determined automatically but the period can be forced using this argument.</span>
<span class="sd">        force_t0: float</span>
<span class="sd">            If None, t0 is determined on the best TES but it can be given using this argument.</span>
<span class="sd">        doplotTESsort: int</span>
<span class="sd">            TES index once they are ordered from the best to the worst for which plots are made.</span>
<span class="sd">            By default, it is 0, so plots are made for the best TES.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># ================= Determine the correct period reference TES ========</span>
        <span class="k">if</span> <span class="n">force_period</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">period</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refperiod</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using reference period </span><span class="si">{0:5.3f}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refperiod</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">period</span> <span class="o">=</span> <span class="n">force_period</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using Forced period </span><span class="si">{0:5.3f}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">period</span><span class="p">))</span>

        <span class="c1"># =============== Determine t0 on reference TES ======================</span>
        <span class="k">if</span> <span class="n">force_t0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_t0</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found t0 </span><span class="si">{0:5.3f}</span><span class="s1">s on TES </span><span class="si">{1:}</span><span class="s1">, ASIC </span><span class="si">{2:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refTESnum</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refASICnum</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">force_t0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using forced t0 </span><span class="si">{0:5.3f}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t0</span><span class="p">))</span>

        <span class="c1"># =============== Loop on ASICs and TES ======================</span>
        <span class="n">m_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncycles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">))</span>
        <span class="n">err_m_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncycles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">))</span>
        <span class="n">Mcycles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">))</span>
        <span class="n">err_Mcycles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">))</span>
        <span class="n">fringes1D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="p">)</span>
        <span class="n">err_fringes1D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="p">)</span>
        <span class="n">fringes1D_percycle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncycles</span><span class="p">))</span>
        <span class="n">err_fringes1D_percycle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncycles</span><span class="p">))</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mi">3</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ASIC</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">asics</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;*********** Starting ASIC </span><span class="si">{</span><span class="n">ASIC</span><span class="si">}</span><span class="s1"> **************&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">TES</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">129</span><span class="p">)):</span>
                <span class="c1"># Use the time constant for skip rise if it is reasonable.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctimes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.6</span><span class="p">:</span>
                    <span class="n">skip_rise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctimes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="mf">5.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">skip_rise</span> <span class="o">=</span> <span class="mf">1.</span>
                <span class="n">skip_fall</span> <span class="o">=</span> <span class="mf">0.5</span>
                <span class="c1"># print(skip_rise, skip_fall)</span>

                <span class="c1"># If TES in doplotTESsort, active the plot option</span>
                <span class="n">want_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">detectors_sort</span><span class="p">[</span><span class="n">doplotTESsort</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">TES</span><span class="p">)</span> <span class="o">&amp;</span>
                                   <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detectors_sort</span><span class="p">[</span><span class="n">doplotTESsort</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">ASIC</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">want_plot</span><span class="p">:</span>
                    <span class="n">rank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">detectors_sort</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">TES</span><span class="p">)</span> <span class="o">&amp;</span>
                                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detectors_sort</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">ASIC</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> ===== Making plots for TES </span><span class="si">{</span><span class="n">TES</span><span class="si">}</span><span class="s1"> - ASIC </span><span class="si">{</span><span class="n">ASIC</span><span class="si">}</span><span class="s1"> - Goodness rank </span><span class="si">{</span><span class="n">rank</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">doplot</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">speak</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">doplot</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">speak</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="n">index</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndet_oneASIC</span> <span class="o">+</span> <span class="n">j</span>
                <span class="n">timeTES</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tdata</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">dataTES</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span>
                <span class="c1"># Fold, roll and remove the median of allh</span>
                <span class="n">tfold</span><span class="p">,</span> <span class="n">dfold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resample_fold_oneTES</span><span class="p">(</span><span class="n">timeTES</span><span class="p">,</span> <span class="n">dataTES</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="n">doplot</span><span class="p">)</span>
                <span class="n">droll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roll_oneTES</span><span class="p">(</span><span class="n">dfold</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">doplot</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_plot_folding</span><span class="p">(</span><span class="n">tfold</span><span class="p">,</span> <span class="n">droll</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">skip_rise</span><span class="o">=</span><span class="n">skip_rise</span><span class="p">,</span> <span class="n">skip_fall</span><span class="o">=</span><span class="n">skip_fall</span><span class="p">,</span>
                                       <span class="n">suptitle</span><span class="o">=</span><span class="s1">&#39;Data fold and roll&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">remove_median_allh</span><span class="p">:</span>
                    <span class="n">droll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_median_allh</span><span class="p">(</span><span class="n">tfold</span><span class="p">,</span> <span class="n">droll</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span>
                                                    <span class="n">skip_rise</span><span class="o">=</span><span class="n">skip_rise</span><span class="p">,</span> <span class="n">skip_fall</span><span class="o">=</span><span class="n">skip_fall</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">doplot</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_folding</span><span class="p">(</span><span class="n">tfold</span><span class="p">,</span> <span class="n">droll</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">skip_rise</span><span class="o">=</span><span class="n">skip_rise</span><span class="p">,</span> <span class="n">skip_fall</span><span class="o">=</span><span class="n">skip_fall</span><span class="p">,</span>
                                           <span class="n">suptitle</span><span class="o">=</span><span class="s1">&#39;Data fold, roll and remove median all horn open&#39;</span><span class="p">)</span>

                <span class="c1"># Average each step on each cycle</span>
                <span class="n">m_points</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">err_m_points</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_over_points_oneTES</span><span class="p">(</span>
                    <span class="n">tfold</span><span class="p">,</span>
                    <span class="n">droll</span><span class="p">,</span>
                    <span class="n">period</span><span class="p">,</span>
                    <span class="n">skip_rise</span><span class="o">=</span><span class="n">skip_rise</span><span class="p">,</span>
                    <span class="n">skip_fall</span><span class="o">=</span><span class="n">skip_fall</span><span class="p">,</span>
                    <span class="n">median</span><span class="o">=</span><span class="n">median</span><span class="p">,</span>
                    <span class="n">rm_slope_percycle</span><span class="o">=</span><span class="n">rm_slope_percycle</span><span class="p">,</span>
                    <span class="n">doplot</span><span class="o">=</span><span class="n">doplot</span><span class="p">)</span>
                <span class="c1"># Make the combination for each cycle</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncycles</span><span class="p">):</span>
                    <span class="n">fringes1D_percycle</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="n">err_fringes1D_percycle</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">weighted_sum</span><span class="p">(</span><span class="n">m_points</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="p">:],</span>
                                                                                                  <span class="n">err_m_points</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span>
                                                                                                  <span class="p">:],</span>
                                                                                                  <span class="n">weights</span><span class="p">)</span>

                <span class="c1"># Average over cycles and make the combination on the mean to get fringes</span>
                <span class="n">Mcycles</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:],</span> <span class="n">err_Mcycles</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_over_cycles_oneTES</span><span class="p">(</span>
                    <span class="n">m_points</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
                    <span class="n">err_m_points</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
                    <span class="n">median</span><span class="o">=</span><span class="n">median</span><span class="p">,</span>
                    <span class="n">Ncycles_to_use</span><span class="o">=</span><span class="n">Ncycles_to_use</span><span class="p">,</span>
                    <span class="n">speak</span><span class="o">=</span><span class="n">speak</span><span class="p">,</span>
                    <span class="n">doplot</span><span class="o">=</span><span class="n">doplot</span><span class="p">)</span>
                <span class="n">fringes1D</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">err_fringes1D</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">weighted_sum</span><span class="p">(</span><span class="n">Mcycles</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:],</span> <span class="n">err_Mcycles</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:],</span> <span class="n">weights</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">doplot</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_plot_TOD_reconstruction</span><span class="p">(</span><span class="n">droll</span><span class="p">,</span> <span class="n">Mcycles</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:])</span>

        <span class="c1"># Final plots</span>
        <span class="c1"># Fringes</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Fringes and errors - BL </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="si">}</span><span class="s1"> - </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="c1"># Make a convolution with Astropy (just to see better the fringes)</span>
        <span class="n">fringes2D</span> <span class="o">=</span> <span class="n">make2Dfringes_data</span><span class="p">(</span><span class="n">fringes1D</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_bad_TES</span><span class="p">)</span>
        <span class="n">fringes2D_conv</span> <span class="o">=</span> <span class="n">astropy_convolution</span><span class="p">(</span><span class="n">fringes2D</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_conv_astropy</span><span class="p">)</span>
        <span class="n">cmap_bwr</span> <span class="o">=</span> <span class="n">make_cmap_nan_black</span><span class="p">(</span><span class="s1">&#39;bwr&#39;</span><span class="p">)</span>
        <span class="n">plot_fringes_imshow</span><span class="p">(</span><span class="n">fringes2D_conv</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap_bwr</span><span class="p">,</span>
                            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Astropy convolution&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">make_mask2D_thermometers_TD</span><span class="p">())</span>
        <span class="n">plot_fringes_scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xTES</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yTES</span><span class="p">,</span> <span class="n">fringes1D</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_bad_TES</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                             <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap_bwr</span><span class="p">)</span>

        <span class="c1"># Errors</span>
        <span class="n">cmap_viridis</span> <span class="o">=</span> <span class="n">make_cmap_nan_black</span><span class="p">(</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
        <span class="n">plot_fringes_scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xTES</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yTES</span><span class="p">,</span> <span class="n">err_fringes1D</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_bad_TES</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span>
                             <span class="n">cmap</span><span class="o">=</span><span class="n">cmap_viridis</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Errors&#39;</span><span class="p">)</span>
        <span class="n">plot_fringes_scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xTES</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yTES</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fringes1D</span> <span class="o">/</span> <span class="n">err_fringes1D</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_bad_TES</span><span class="p">,</span>
                             <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax3</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap_viridis</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span>
                             <span class="n">title</span><span class="o">=</span><span class="s1">&#39;|Values/Errors|&#39;</span><span class="p">)</span>

        <span class="c1"># Plot the result for the reference TES</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_fringes_measurement_perTES</span><span class="p">(</span><span class="n">fringes1D</span><span class="p">,</span> <span class="n">err_fringes1D</span><span class="p">,</span> <span class="n">fringes1D_percycle</span><span class="p">,</span> <span class="n">err_fringes1D_percycle</span><span class="p">,</span>
                                              <span class="n">TES</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ASIC</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">m_points</span><span class="p">,</span> <span class="n">err_m_points</span><span class="p">,</span> <span class="n">Mcycles</span><span class="p">,</span> <span class="n">err_Mcycles</span><span class="p">,</span> <span class="n">fringes1D</span><span class="p">,</span> <span class="n">err_fringes1D</span><span class="p">,</span> \
               <span class="n">fringes1D_percycle</span><span class="p">,</span> <span class="n">err_fringes1D_percycle</span></div>


    <span class="c1"># ================ Plot functions very specific to the fringes analysis</span>
    <span class="k">def</span> <span class="nf">_plot_finding_t0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tfold</span><span class="p">,</span> <span class="n">msignal</span><span class="p">,</span> <span class="n">dsignal</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">start_times</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">)):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tfold</span><span class="p">,</span> <span class="n">msignal</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean over periods&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tfold</span><span class="p">,</span> <span class="n">dsignal</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Derivative&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tfold</span><span class="p">[</span><span class="n">thr</span><span class="p">],</span> <span class="n">dsignal</span><span class="p">[</span><span class="n">thr</span><span class="p">],</span> <span class="s1">&#39;ro&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;High Derivative (&gt;3sig)&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">start_times</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lab</span> <span class="o">=</span> <span class="s1">&#39;Found Start times&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lab</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">start_times</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">lab</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lab</span> <span class="o">=</span> <span class="s1">&#39;Median Start Time (modulo period/6)&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lab</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">t0</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">stable_time</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">lab</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">framealpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;t0 determination on Reference TES&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time in Period&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Signal averaged over periods&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_plot_folding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tfold</span><span class="p">,</span> <span class="n">dfold</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">skip_rise</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip_fall</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">suptitle</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">)):</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">suptitle</span><span class="p">)</span>
        <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">axs</span><span class="p">)</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dfold</span><span class="p">,</span>
                   <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
                   <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                   <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tfold</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">tfold</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tfold</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncycles</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">):</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">i</span> <span class="o">*</span> <span class="p">(</span><span class="n">period</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time [s]&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Cycle number&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncycles</span><span class="p">):</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tfold</span><span class="p">,</span> <span class="n">dfold</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">):</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">i</span> <span class="o">*</span> <span class="p">(</span><span class="n">period</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">skip_rise</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">lab1</span> <span class="o">=</span> <span class="s1">&#39;Skip rise </span><span class="si">{:.2f}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">skip_rise</span><span class="p">)</span>
                    <span class="n">lab2</span> <span class="o">=</span> <span class="s1">&#39;Skip fall </span><span class="si">{:.2f}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">skip_fall</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lab1</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">lab2</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">ax2</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="p">(</span><span class="n">period</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="p">(</span><span class="n">period</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">)</span> <span class="o">+</span> <span class="n">skip_rise</span><span class="p">),</span>
                            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">lab1</span><span class="p">)</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">period</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">)</span> <span class="o">-</span> <span class="n">skip_fall</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">period</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">),</span>
                            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">lab2</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time [s]&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;ADU&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="k">return</span>

<div class="viewcode-block" id="FringesAnalysis.plot_average_over_steps">
<a class="viewcode-back" href="../../qubic.html#qubic.fringes_lib.FringesAnalysis.plot_average_over_steps">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_average_over_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m_points</span><span class="p">,</span> <span class="n">err_m_points</span><span class="p">,</span> <span class="n">Mcycles</span><span class="p">,</span> <span class="n">err_Mcycles</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">)):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

        <span class="n">ttt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">stable_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stable_time</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># Mean time of each step</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncycles</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lab</span> <span class="o">=</span> <span class="s1">&#39;Mean on each step&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lab</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">ttt</span><span class="p">,</span> <span class="n">m_points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span>
                        <span class="n">yerr</span><span class="o">=</span><span class="n">err_m_points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span>
                        <span class="n">xerr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stable_time</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mf">0.025</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">lab</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">ttt</span><span class="p">,</span> <span class="n">Mcycles</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">err_Mcycles</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stable_time</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean over cycles&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;rx&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time [s]&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Value for each cycle&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="k">return</span></div>


    <span class="k">def</span> <span class="nf">_plot_TOD_reconstruction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dfold</span><span class="p">,</span> <span class="n">Mcycles</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">)):</span>
        <span class="n">tf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncycles</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">stable_time</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stable_time</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">tf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncycles</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsp_per</span><span class="p">)</span>
        <span class="n">TOD_reconstructed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">Mcycles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncycles</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">dfold</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Input signal&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">TOD_reconstructed</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Reconstructed TOD with Mcycles&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time samples&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;TOD&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_plot_fringes_measurement_perTES</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fringes1D</span><span class="p">,</span> <span class="n">err_fringes1D</span><span class="p">,</span> <span class="n">fringes1D_percycle</span><span class="p">,</span> <span class="n">err_fringes1D_percycle</span><span class="p">,</span>
                                         <span class="n">TES</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ASIC</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">TES</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ASIC</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ASIC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refASICnum</span>
            <span class="n">TES</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refTESnum</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">ASIC</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndet_oneASIC</span> <span class="o">+</span> <span class="p">(</span><span class="n">TES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncycles</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;TES </span><span class="si">{</span><span class="n">TES</span><span class="si">}</span><span class="s1"> - ASIC </span><span class="si">{</span><span class="n">ASIC</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Measurement on each cycle</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">fringes1D_percycle</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span>
                     <span class="n">yerr</span><span class="o">=</span><span class="n">err_fringes1D_percycle</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fringes per cycle&#39;</span><span class="p">)</span>

        <span class="c1"># Fit</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">fringes1D_percycle</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">deg</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="n">err_fringes1D_percycle</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">xx</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">xx</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">xx</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">fit</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Polynomial fit deg=3&#39;</span><span class="p">)</span>

        <span class="c1"># Final measurement and the error</span>
        <span class="n">err_plus</span> <span class="o">=</span> <span class="n">fringes1D</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">err_fringes1D</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">err_minus</span> <span class="o">=</span> <span class="n">fringes1D</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">err_fringes1D</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">err_plus</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">err_minus</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">21.5</span><span class="p">),</span> <span class="n">err_minus</span><span class="p">,</span> <span class="n">err_plus</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">fringes1D</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fringes on all cycles&#39;</span><span class="p">)</span>

        <span class="c1"># Mean over the measurements on each cycle</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fringes1D_percycle</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Simple mean&#39;</span><span class="p">)</span>

        <span class="c1"># Median  over the measurements on each cycle</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">fringes1D_percycle</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Median&#39;</span><span class="p">)</span>

        <span class="c1"># Meancut  over the measurements on each cycle</span>
        <span class="n">meancut_mean</span><span class="p">,</span> <span class="n">mean_cut_std</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">meancut</span><span class="p">(</span><span class="n">fringes1D_percycle</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">nsig</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">med</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">meancut_mean</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean cut&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">meancut_mean</span> <span class="o">+</span> <span class="n">mean_cut_std</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">meancut_mean</span> <span class="o">-</span> <span class="n">mean_cut_std</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Cycle index&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Fringes value&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">20.5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncycles</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fringes1D_percycle</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]))</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">,</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fringes1D_percycle</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]))</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_plot_folding_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">TES</span><span class="p">,</span> <span class="n">ASIC</span><span class="p">,</span> <span class="n">tfold</span><span class="p">,</span> <span class="n">datafold</span><span class="p">,</span> <span class="n">residuals_time</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">errs</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">ASIC</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndet_oneASIC</span> <span class="o">+</span> <span class="p">(</span><span class="n">TES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">amps</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">2</span><span class="p">:]</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">stable_time</span> <span class="o">=</span> <span class="n">period</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">stable_time</span><span class="p">)</span>
        <span class="n">mean_allh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">amps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">allh</span><span class="p">])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tfold</span><span class="p">,</span> <span class="n">datafold</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Folded signal&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">period</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">),</span> <span class="n">amps</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">errs</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">2</span><span class="p">:],</span>
                     <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fit Amplitudes&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tfold</span><span class="p">,</span> <span class="n">ft</span><span class="o">.</span><span class="n">simsig_fringes</span><span class="p">(</span><span class="n">tfold</span><span class="p">,</span> <span class="n">period</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]),</span>
                 <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fit&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tfold</span><span class="p">,</span> <span class="n">residuals_time</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span>
                 <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Residuals: RMS=</span><span class="si">{0:6.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">residuals_time</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:])))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">stable_time</span> <span class="o">*</span> <span class="n">k</span> <span class="o">+</span> <span class="n">t0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">mean_allh</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean all open&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time [s]&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;TOD&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;TES </span><span class="si">{</span><span class="n">TES</span><span class="si">}</span><span class="s1"> - ASIC </span><span class="si">{</span><span class="n">ASIC</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)</span>
        <span class="k">return</span></div>


<span class="c1"># =========================================</span>
<div class="viewcode-block" id="SaveFringesFitsPdf">
<a class="viewcode-back" href="../../qubic.html#qubic.fringes_lib.SaveFringesFitsPdf">[docs]</a>
<span class="k">class</span> <span class="nc">SaveFringesFitsPdf</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">date_obs</span><span class="p">,</span> <span class="n">allBLs</span><span class="p">,</span> <span class="n">allstable_time</span><span class="p">,</span> <span class="n">allNcycles</span><span class="p">,</span> <span class="n">xTES</span><span class="p">,</span> <span class="n">yTES</span><span class="p">,</span> <span class="n">allfringes1D</span><span class="p">,</span> <span class="n">allerr_fringes1D</span><span class="p">,</span>
                 <span class="n">allmask_bad_TES</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">ecosorb</span><span class="o">=</span><span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;ONAFP&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">q</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">date_obs</span> <span class="o">=</span> <span class="n">date_obs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allBLs</span> <span class="o">=</span> <span class="n">allBLs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nBLs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">allBLs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BLs_sort</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BLs_type</span> <span class="o">=</span> <span class="n">scal</span><span class="o">.</span><span class="n">find_equivalent_baselines</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allBLs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allstable_time</span> <span class="o">=</span> <span class="n">allstable_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allNcycles</span> <span class="o">=</span> <span class="n">allNcycles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xTES</span> <span class="o">=</span> <span class="n">xTES</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yTES</span> <span class="o">=</span> <span class="n">yTES</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allfringes1D</span> <span class="o">=</span> <span class="n">allfringes1D</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allerr_fringes1D</span> <span class="o">=</span> <span class="n">allerr_fringes1D</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allmask_bad_TES</span> <span class="o">=</span> <span class="n">allmask_bad_TES</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">=</span> <span class="n">nsteps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ecosorb</span> <span class="o">=</span> <span class="n">ecosorb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_keyvals</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_fdict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_make_keyvals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make a dictionary with relevant information on the measurement.</span>
<span class="sd">        Assign the FITS keyword values for the primary header</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">keyvals</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;DATE-OBS&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date_obs</span><span class="p">,</span> <span class="s1">&#39;Date of the measurement&#39;</span><span class="p">),</span>
                   <span class="s1">&#39;NBLS&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nBLs</span><span class="p">,</span> <span class="s1">&#39;Number of baselines&#39;</span><span class="p">),</span>
                   <span class="s1">&#39;NSTEP&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">,</span> <span class="s1">&#39;Number of stable steps per cycle&#39;</span><span class="p">),</span>
                   <span class="s1">&#39;ECOSORD&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecosorb</span><span class="p">,</span> <span class="s1">&#39;Ecosorb on the source&#39;</span><span class="p">),</span>
                   <span class="s1">&#39;FRAME&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span> <span class="s1">&#39;Referential frame for (X, Y) TES&#39;</span><span class="p">)}</span>

        <span class="k">return</span> <span class="n">keyvals</span>

    <span class="k">def</span> <span class="nf">_make_fdict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Make a dictionary with all relevant data.&quot;&quot;&quot;</span>
        <span class="n">fdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;BLS&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">allBLs</span><span class="p">,</span> <span class="s1">&#39;Stable_time&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">allstable_time</span><span class="p">,</span> <span class="s1">&#39;NCYCLES&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">allNcycles</span><span class="p">,</span>
                 <span class="s1">&#39;X_TES&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">xTES</span><span class="p">,</span> <span class="s1">&#39;Y_TES&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">yTES</span><span class="p">,</span> <span class="s1">&#39;FRINGES_1D&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">allfringes1D</span><span class="p">,</span>
                 <span class="s1">&#39;ERRORS&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">allerr_fringes1D</span><span class="p">,</span> <span class="s1">&#39;MASK_BAD_TES&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">allmask_bad_TES</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">fdict</span>

<div class="viewcode-block" id="SaveFringesFitsPdf.save_fringes_pdf_plots">
<a class="viewcode-back" href="../../qubic.html#qubic.fringes_lib.SaveFringesFitsPdf.save_fringes_pdf_plots">[docs]</a>
    <span class="k">def</span> <span class="nf">save_fringes_pdf_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">save_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save all the fringe plots (all baselines) in a pdf file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyvals</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">keyvals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyvals</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">save_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">save_name</span> <span class="o">=</span> <span class="s1">&#39;Fringes_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_obs</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nBLs</span><span class="si">}</span><span class="s1">BLs.pdf&#39;</span>

        <span class="k">with</span> <span class="n">PdfPages</span><span class="p">(</span><span class="n">out_dir</span> <span class="o">+</span> <span class="n">save_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">pp</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nBLs</span><span class="p">):</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Fringes - BL </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">allBLs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1"> - </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">date_obs</span><span class="si">}</span><span class="s1"> - type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">BLs_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">fringes2D</span> <span class="o">=</span> <span class="n">make2Dfringes_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allfringes1D</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">allmask_bad_TES</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">fringes2D_conv</span> <span class="o">=</span> <span class="n">astropy_convolution</span><span class="p">(</span><span class="n">fringes2D</span><span class="p">)</span>
                <span class="n">plot_fringes_imshow</span><span class="p">(</span><span class="n">fringes2D_conv</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax0</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Astropy convolution&#39;</span><span class="p">,</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="n">make_cmap_nan_black</span><span class="p">(</span><span class="s1">&#39;bwr&#39;</span><span class="p">))</span>
                <span class="n">plot_fringes_scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xTES</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yTES</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allfringes1D</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">allmask_bad_TES</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                     <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
                <span class="n">pp</span><span class="o">.</span><span class="n">savefig</span><span class="p">()</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="SaveFringesFitsPdf.write_fits_fringes">
<a class="viewcode-back" href="../../qubic.html#qubic.fringes_lib.SaveFringesFitsPdf.write_fits_fringes">[docs]</a>
    <span class="k">def</span> <span class="nf">write_fits_fringes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">save_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Save a .fits with the fringes data.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">out_dir</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
            <span class="n">out_dir</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span>

        <span class="k">if</span> <span class="n">save_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">save_name</span> <span class="o">=</span> <span class="s1">&#39;Fringes_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_obs</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nBLs</span><span class="si">}</span><span class="s1">BLs.fits&#39;</span>

        <span class="c1"># Header creation</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyvals</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">hdr</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyvals</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="n">hdu_prim</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">hdr</span><span class="p">)</span>
        <span class="n">allhdu</span> <span class="o">=</span> <span class="p">[</span><span class="n">hdu_prim</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fdict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">hdu</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fdict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
            <span class="n">allhdu</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdu</span><span class="p">)</span>

        <span class="n">thdulist</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">(</span><span class="n">allhdu</span><span class="p">)</span>
        <span class="n">thdulist</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">out_dir</span> <span class="o">+</span> <span class="n">save_name</span><span class="p">,</span> <span class="s1">&#39;warn&#39;</span><span class="p">)</span>

        <span class="k">return</span></div>
</div>



<span class="k">def</span> <span class="nf">read_fits_fringes</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read a .fits where you saved the data and returns two dictionaries with</span>
<span class="sd">    the header content and the data themselves.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hdulist</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="p">)</span>

    <span class="n">fringes_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">hdulist</span><span class="p">)):</span>
        <span class="n">extname</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;EXTNAME&#39;</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">fringes_dict</span><span class="p">[</span><span class="n">extname</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>

    <span class="k">return</span> <span class="n">header</span><span class="p">,</span> <span class="n">fringes_dict</span>


<span class="c1"># ============== Tool functions ==============</span>
<span class="k">def</span> <span class="nf">decide_bad_TES</span><span class="p">(</span><span class="n">allmask_bad_TES</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make a mask for bad detectors, common to all images.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    allmask_bad_TES: list</span>
<span class="sd">        List with the mask of the worst TES for each image.</span>
<span class="sd">    condition: int</span>
<span class="sd">        Number of images where the detector must be NAN to consider it as bad.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nimages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">allmask_bad_TES</span><span class="p">)</span>
    <span class="n">ndet</span> <span class="o">=</span> <span class="n">allmask_bad_TES</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">the_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ndet</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nimages</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># replace NAN by 1</span>
            <span class="n">the_mask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">allmask_bad_TES</span><span class="p">[</span><span class="n">k</span><span class="p">])]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Add 1 if it is NAN</span>
            <span class="n">the_mask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">allmask_bad_TES</span><span class="p">[</span><span class="n">k</span><span class="p">])]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">the_mask</span><span class="p">[</span><span class="n">the_mask</span> <span class="o">&gt;=</span> <span class="n">condition</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">the_mask</span><span class="p">[</span><span class="n">the_mask</span> <span class="o">&lt;</span> <span class="n">condition</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of bad detectors: </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">ndet</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">the_mask</span><span class="p">))</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">ndet</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">the_mask</span>


<span class="k">def</span> <span class="nf">give_index_bad_TES</span><span class="p">(</span><span class="n">the_mask</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Give the index of the bad TES from a mask.&quot;&quot;&quot;</span>
    <span class="n">ndet</span> <span class="o">=</span> <span class="n">the_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nbadtes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ndet</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">the_mask</span><span class="p">))</span>
    <span class="n">badTES</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nbadtes</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">badTES</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">the_mask</span><span class="p">))[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="mi">128</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># TES</span>
    <span class="n">badTES</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">the_mask</span><span class="p">))[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">128</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># ASIC</span>

    <span class="k">return</span> <span class="n">badTES</span>


<span class="k">def</span> <span class="nf">find_high_derivative</span><span class="p">(</span><span class="n">signal</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the derivative of a signal and find where it is high.&quot;&quot;&quot;</span>
    <span class="n">dsignal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">signal</span><span class="p">))</span>
    <span class="n">md</span><span class="p">,</span> <span class="n">sd</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">meancut</span><span class="p">(</span><span class="n">dsignal</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">thr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dsignal</span> <span class="o">-</span> <span class="n">md</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">sd</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dsignal</span><span class="p">,</span> <span class="n">thr</span>


<span class="k">def</span> <span class="nf">cut_data</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">tf</span><span class="p">,</span> <span class="n">tdata</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cut the TODs from t0 to tf.</span>
<span class="sd">    They can be None if you do not want to cut the beginning or the end.</span>
<span class="sd">    data shape: [nTES, nsamples]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">t0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">tdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">tf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tf</span> <span class="o">=</span> <span class="n">tdata</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">tdata</span> <span class="o">&gt;=</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tdata</span> <span class="o">&lt;=</span> <span class="n">tf</span><span class="p">)</span>
    <span class="n">tdata_cut</span> <span class="o">=</span> <span class="n">tdata</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>
    <span class="n">data_cut</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">ok</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">tdata_cut</span><span class="p">,</span> <span class="n">data_cut</span>


<span class="k">def</span> <span class="nf">cut_data_Nperiods</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">tf</span><span class="p">,</span> <span class="n">t_data</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">period</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cut the TODs from t0 to tf with an integer number of periods</span>
<span class="sd">    They can be None if you do not want to cut the beginning or the end.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">t0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">t_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">tf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tf</span> <span class="o">=</span> <span class="n">t_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">nper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">tf</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">/</span> <span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">tend</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">+</span> <span class="n">nper</span> <span class="o">*</span> <span class="n">period</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_data</span> <span class="o">&gt;=</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t_data</span> <span class="o">&lt;=</span> <span class="n">tend</span><span class="p">)</span>
    <span class="n">t_data_cut</span> <span class="o">=</span> <span class="n">t_data</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>
    <span class="n">data_cut</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">t_data_cut</span><span class="p">,</span> <span class="n">data_cut</span><span class="p">,</span> <span class="n">nper</span>


<span class="k">def</span> <span class="nf">weighted_sum</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">errs</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Weighted sum and its error&quot;&quot;&quot;</span>
    <span class="n">w_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span> <span class="o">*</span> <span class="n">vals</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">errs</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">w_sum</span><span class="p">,</span> <span class="n">sigma</span>


<span class="k">def</span> <span class="nf">make_mask2D_thermometers_TD</span><span class="p">():</span>
    <span class="n">mask_thermos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">17</span><span class="p">,</span> <span class="mi">17</span><span class="p">))</span>
    <span class="n">mask_thermos</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">mask_thermos</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">return</span> <span class="n">mask_thermos</span>


<span class="k">def</span> <span class="nf">remove_thermometers</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fringes1D</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove the 8 thermometers.</span>
<span class="sd">    Returns 1D arrays with 248 values and not 256.&quot;&quot;&quot;</span>
    <span class="n">fringes1D</span> <span class="o">=</span> <span class="n">fringes1D</span><span class="p">[</span><span class="n">x</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">y</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fringes1D</span>


<span class="k">def</span> <span class="nf">reorder_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">xqsoft</span><span class="p">,</span> <span class="n">yqsoft</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reorder data (TES signal) as ordered in the QUBIC soft.</span>
<span class="sd">    The number of TES should be 248 (without thermometers).&quot;&quot;&quot;</span>
    <span class="n">ndet</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">data_ordered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndet</span><span class="p">):</span>
        <span class="n">index_simu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">xqsoft</span> <span class="o">==</span> <span class="n">xdata</span><span class="p">[</span><span class="n">det</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">yqsoft</span> <span class="o">==</span> <span class="n">ydata</span><span class="p">[</span><span class="n">det</span><span class="p">]))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data_ordered</span><span class="p">[</span><span class="n">index_simu</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">det</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">data_ordered</span>


<span class="c1"># ============== Plot functions ==============</span>
<span class="k">def</span> <span class="nf">plot_sum_diff_fringes</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">keyvals</span><span class="p">,</span> <span class="n">fdict</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot the sum and the difference of all equivalent baselines.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">keyvals</span><span class="p">[</span><span class="s1">&#39;NSTEP&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">keyvals</span><span class="p">:</span>
            <span class="n">keyvals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">keyvals</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">fringes2D</span> <span class="o">=</span> <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;FRINGES_2D&#39;</span><span class="p">]</span>
    <span class="n">allBLs</span> <span class="o">=</span> <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;BLS&#39;</span><span class="p">]</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">keyvals</span><span class="p">[</span><span class="s1">&#39;DATE-OBS&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">make_mask2D_thermometers_TD</span><span class="p">()</span>

    <span class="n">BLs_sort</span><span class="p">,</span> <span class="n">BLs_type</span> <span class="o">=</span> <span class="n">scal</span><span class="o">.</span><span class="n">find_equivalent_baselines</span><span class="p">(</span><span class="n">allBLs</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    <span class="n">ntype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">BLs_type</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># Number of equivalency types</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntype</span><span class="p">):</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fringes2D</span><span class="p">)[</span><span class="n">BLs_type</span> <span class="o">==</span> <span class="n">j</span><span class="p">]</span>
        <span class="n">neq</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">BLs_sort</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>  <span class="c1"># Number of equivalent baselines for that type</span>
        <span class="n">sgns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">neq</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">17</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">neq</span><span class="p">):</span>
            <span class="n">sgns</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="n">i</span>

        <span class="n">av_fringe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">neq</span>
        <span class="n">diff_fringe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">images</span> <span class="o">*</span> <span class="n">sgns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">neq</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">neq</span><span class="si">}</span><span class="s1"> BLs - </span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">av_fringe</span> <span class="o">*</span> <span class="n">mask</span><span class="p">),</span>
                   <span class="n">vmin</span><span class="o">=-</span><span class="n">lim</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">lim</span><span class="p">,</span>
                   <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                   <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;Gaussian&#39;</span><span class="p">)</span>
        <span class="n">ft</span><span class="o">.</span><span class="n">qgrid</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Imshow - Sum / </span><span class="si">{</span><span class="n">neq</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">diff_fringe</span> <span class="o">*</span> <span class="n">mask</span><span class="p">),</span>
                   <span class="n">vmin</span><span class="o">=-</span><span class="n">lim</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">lim</span><span class="p">,</span>
                   <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                   <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;Gaussian&#39;</span><span class="p">)</span>
        <span class="n">ft</span><span class="o">.</span><span class="n">qgrid</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Imshow - Diff / </span><span class="si">{</span><span class="n">neq</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">return</span>


<span class="k">def</span> <span class="nf">make_cmap_nan_black</span><span class="p">(</span><span class="n">cmap</span><span class="p">):</span>
    <span class="n">cmap_bwr</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">))</span>
    <span class="n">cmap_bwr</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cmap_bwr</span>


<span class="k">def</span> <span class="nf">plot_fringes_scatter</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">xTES</span><span class="p">,</span> <span class="n">yTES</span><span class="p">,</span> <span class="n">fringes1D</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;ONAFP&#39;</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">cbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">1.</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">make_cmap_nan_black</span><span class="p">(</span><span class="s1">&#39;bwr&#39;</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Scatter plot&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">):</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fringes</span> <span class="o">=</span> <span class="n">remove_thermometers</span><span class="p">(</span><span class="n">xTES</span><span class="p">,</span> <span class="n">yTES</span><span class="p">,</span> <span class="n">fringes1D</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="c1"># Clip weird detectors, NAN values are automatically clipped</span>
        <span class="n">clip_mask</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">fringes</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">fringes</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">clip_mask</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">scal</span><span class="o">.</span><span class="n">scatter_plot_FP</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fringes</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span>
                         <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                         <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                         <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                         <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                         <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                         <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
                         <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                         <span class="n">cbar</span><span class="o">=</span><span class="n">cbar</span><span class="p">,</span>
                         <span class="n">plotnonfinite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span>
                         <span class="p">)</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">make2Dfringes_QubicSoft</span><span class="p">(</span><span class="n">fringes1D</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">nan2zero</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;fringes1D must have 248 elements ordered as in Qubic soft.&quot;&quot;&quot;</span>
    <span class="n">fringes2D</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">fringes1D</span><span class="p">)[</span><span class="mi">17</span><span class="p">:,</span> <span class="p">:</span><span class="mi">17</span><span class="p">]</span>
    <span class="n">fringes2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">fringes2D</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nan2zero</span><span class="p">:</span>
        <span class="n">fringes2D</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">fringes2D</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="n">fringes2D</span>


<span class="k">def</span> <span class="nf">make2Dfringes_data</span><span class="p">(</span><span class="n">fringes1D</span><span class="p">,</span> <span class="n">nan2zero</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">fringes2D</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">image_asics</span><span class="p">(</span><span class="n">all1</span><span class="o">=</span><span class="n">fringes1D</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nan2zero</span><span class="p">:</span>
        <span class="n">fringes2D</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">fringes2D</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="n">fringes2D</span>


<span class="k">def</span> <span class="nf">astropy_convolution</span><span class="p">(</span><span class="n">fringes2D</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">nan_treatment</span><span class="o">=</span><span class="s1">&#39;interpolate&#39;</span><span class="p">,</span> <span class="n">preserve_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">Gaussian2DKernel</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
    <span class="n">image_convolved</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">fringes2D</span><span class="p">,</span>
                               <span class="n">kernel</span><span class="p">,</span>
                               <span class="n">nan_treatment</span><span class="o">=</span><span class="n">nan_treatment</span><span class="p">,</span>
                               <span class="n">preserve_nan</span><span class="o">=</span><span class="n">preserve_nan</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image_convolved</span>


<span class="k">def</span> <span class="nf">plot_fringes_imshow</span><span class="p">(</span><span class="n">fringes2D</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
                        <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Imshow&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="c1"># Clip weird detectors, NAN values are automatically clipped</span>
        <span class="n">clip_mask</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">fringes2D</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">fringes2D</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">clip_mask</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fringes2D</span> <span class="o">*=</span> <span class="n">mask</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">fringes2D</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
                    <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                    <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                    <span class="n">interpolation</span><span class="o">=</span><span class="n">interp</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cbar</span><span class="p">:</span>
        <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;5%&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">plot_fringes_diagonal</span><span class="p">(</span><span class="n">fringes2D</span><span class="p">,</span> <span class="n">idiag</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">anti_diag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the diagonals in 1D and the sum of all diagonals.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fringes2D: array</span>
<span class="sd">        A 2D image of the focal plane (17x17).</span>
<span class="sd">    idiag: list</span>
<span class="sd">        Diagonal index you want to plot, 0 is the main one and it can be from -16 to 16.</span>
<span class="sd">    anti_diag: bool</span>
<span class="sd">        If True, it will take the anti-diagonals.</span>
<span class="sd">    fig, ax: matplotlib figure</span>
<span class="sd">        If not None, you can include the plot in matplotlib subplots.</span>
<span class="sd">    figsize</span>
<span class="sd">    ylim</span>
<span class="sd">    title: str</span>
<span class="sd">        Plot title</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fringes2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">fringes2D</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">anti_diag</span><span class="p">:</span>
        <span class="n">fringes2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">fringes2D</span><span class="p">)</span>
    <span class="n">sum_diag</span> <span class="o">=</span> <span class="n">sum_all_diag</span><span class="p">(</span><span class="n">fringes2D</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sum_diag</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sum of all diagonal&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idiag</span><span class="p">:</span>
        <span class="n">diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">fringes2D</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">33</span><span class="p">)[::</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">33</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">i</span><span class="p">):</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">i</span><span class="p">)][::</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">diag</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Diagonal </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;TES index on the diagonal&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Signal&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">sum_all_diag</span><span class="p">(</span><span class="n">fringes2D</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sum diagonal in a 2D images. Pixels that are not TES (outside the FP should be at 0.</span>
<span class="sd">    The sum is normalized to take into account the diagonal lengths and the pixels that are not TES.&quot;&quot;&quot;</span>
    <span class="n">offsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>
    <span class="n">sum_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">33</span><span class="p">)</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">33</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">offsets</span><span class="p">:</span>
        <span class="n">diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">fringes2D</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
        <span class="c1"># Fill the array at right places</span>
        <span class="n">first</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">last</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">last</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">sum_diag</span><span class="p">[</span><span class="n">first</span><span class="p">:</span><span class="n">last</span><span class="p">][::</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">diag</span>

        <span class="c1"># Build the normalization array (take into account 0. outside the FP)</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">dd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">diag</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dd</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="n">norm</span><span class="p">[</span><span class="n">first</span><span class="p">:</span><span class="n">last</span><span class="p">][::</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">sum_diag</span> <span class="o">/=</span> <span class="n">norm</span>

    <span class="k">return</span> <span class="n">sum_diag</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, QUBIC Collaboration.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>