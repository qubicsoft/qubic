<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>qubic.sb_fitting &mdash; Qubicsoft 5.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=ee801c84"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Qubicsoft
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Qubicsoft</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">qubic.sb_fitting</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for qubic.sb_fitting</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">qubic.fibtools</span> <span class="k">as</span> <span class="nn">ft</span>
<span class="kn">import</span> <span class="nn">qubic.plotters</span> <span class="k">as</span> <span class="nn">p</span>
<span class="kn">import</span> <span class="nn">qubic.lin_lib</span> <span class="k">as</span> <span class="nn">ll</span>
<span class="kn">import</span> <span class="nn">qubic</span>
<span class="c1"># import demodulation_lib as dl</span>

<span class="kn">from</span> <span class="nn">pysimulators</span> <span class="kn">import</span> <span class="n">FitsArray</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">matplotlib.mlab</span> <span class="k">as</span> <span class="nn">mlab</span>
<span class="kn">import</span> <span class="nn">scipy.ndimage.filters</span> <span class="k">as</span> <span class="nn">f</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span> <span class="k">as</span> <span class="nn">scsig</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">interpolate</span>
<span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">healpy</span> <span class="k">as</span> <span class="nn">hp</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numexpr</span> <span class="k">as</span> <span class="nn">ne</span>
<span class="kn">import</span> <span class="nn">pickle</span>


<div class="viewcode-block" id="get_hpmap">
<a class="viewcode-back" href="../../qubic.html#qubic.sb_fitting.get_hpmap">[docs]</a>
<span class="k">def</span> <span class="nf">get_hpmap</span><span class="p">(</span><span class="n">TESNum</span><span class="p">,</span> <span class="n">directory</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">qubic</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_map</span><span class="p">(</span><span class="n">directory</span> <span class="o">+</span> <span class="s1">&#39;/Healpix/healpix_TESNum_</span><span class="si">{}</span><span class="s1">.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">TESNum</span><span class="p">)))</span></div>



<div class="viewcode-block" id="get_lines">
<a class="viewcode-back" href="../../qubic.html#qubic.sb_fitting.get_lines">[docs]</a>
<span class="k">def</span> <span class="nf">get_lines</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">directory</span><span class="p">):</span>
    <span class="n">nn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
    <span class="n">hpmaps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nn</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">12</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">nums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nn</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nn</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">lines</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">33</span><span class="p">:</span>
                <span class="n">nums</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">+</span> <span class="mi">32</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nums</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">-</span> <span class="mi">32</span> <span class="o">+</span> <span class="mi">32</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">128</span>
            <span class="n">hpmaps</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">get_hpmap</span><span class="p">(</span><span class="n">nums</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">directory</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hpmaps</span><span class="p">,</span> <span class="n">nums</span></div>



<div class="viewcode-block" id="show_lines">
<a class="viewcode-back" href="../../qubic.html#qubic.sb_fitting.show_lines">[docs]</a>
<span class="k">def</span> <span class="nf">show_lines</span><span class="p">(</span><span class="n">maps</span><span class="p">,</span> <span class="n">nums</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">maps</span><span class="p">)</span>
    <span class="n">nl</span> <span class="o">=</span> <span class="n">sh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nl</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">hp</span><span class="o">.</span><span class="n">gnomview</span><span class="p">(</span><span class="n">maps</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">reso</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="nb">min</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="nb">max</span><span class="p">,</span> <span class="n">sub</span><span class="o">=</span><span class="p">(</span><span class="n">nl</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">l</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="n">nums</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
    <span class="n">tight_layout</span><span class="p">()</span></div>



<div class="viewcode-block" id="get_flatmap">
<a class="viewcode-back" href="../../qubic.html#qubic.sb_fitting.get_flatmap">[docs]</a>
<span class="k">def</span> <span class="nf">get_flatmap</span><span class="p">(</span><span class="n">TESNum</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">azmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">azmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">elmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">elmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">fitted_directory</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">themap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">FitsArray</span><span class="p">(</span><span class="n">directory</span> <span class="o">+</span> <span class="s1">&#39;/Flat/imgflat_TESNum_</span><span class="si">{}</span><span class="s1">.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">TESNum</span><span class="p">)))</span>
    <span class="n">az</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">FitsArray</span><span class="p">(</span><span class="n">directory</span> <span class="o">+</span> <span class="s1">&#39;/Flat/azimuth.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">TESNum</span><span class="p">)))</span>
    <span class="n">el</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">FitsArray</span><span class="p">(</span><span class="n">directory</span> <span class="o">+</span> <span class="s1">&#39;/Flat/elevation.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">TESNum</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">azmin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">azmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">az</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">azmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">azmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">az</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">elmin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">elmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">elmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">elmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
    <span class="n">okaz</span> <span class="o">=</span> <span class="p">(</span><span class="n">az</span> <span class="o">&gt;=</span> <span class="n">azmin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">az</span> <span class="o">&lt;=</span> <span class="n">azmax</span><span class="p">)</span>
    <span class="n">az</span> <span class="o">=</span> <span class="n">az</span><span class="p">[</span><span class="n">okaz</span><span class="p">]</span>
    <span class="n">okel</span> <span class="o">=</span> <span class="p">(</span><span class="n">el</span> <span class="o">&gt;=</span> <span class="n">elmin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">el</span> <span class="o">&lt;=</span> <span class="n">elmax</span><span class="p">)</span>
    <span class="n">el</span> <span class="o">=</span> <span class="n">el</span><span class="p">[</span><span class="n">okel</span><span class="p">]</span>
    <span class="n">themap</span> <span class="o">=</span> <span class="n">themap</span><span class="p">[:,</span> <span class="n">okaz</span><span class="p">][</span><span class="n">okel</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">if</span> <span class="n">remove</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">remove</span><span class="p">)</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">remove</span><span class="p">)</span>
        <span class="n">xc</span><span class="p">,</span> <span class="n">yval</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">others</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="n">remove</span><span class="p">,</span> <span class="n">themap</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="p">[</span><span class="n">mm</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ss</span><span class="p">,</span> <span class="n">mm</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ss</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                              <span class="n">nbins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">cutbad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dispersion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">bla</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">yval</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">dy</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">bla</span><span class="p">)</span>
        <span class="n">themap</span> <span class="o">-=</span> <span class="n">pp</span><span class="p">(</span><span class="n">remove</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fitted_directory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">themap</span><span class="p">,</span> <span class="n">az</span><span class="p">,</span> <span class="n">el</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">### Read fitted synthesized beam</span>
        <span class="n">thefile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fitted_directory</span> <span class="o">+</span> <span class="s1">&#39;/fit-TES</span><span class="si">{}</span><span class="s1">.pk&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">TESNum</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
        <span class="n">fitpars</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">thefile</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin1&#39;</span><span class="p">)</span>
        <span class="n">thefile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">sbfitmodel</span> <span class="o">=</span> <span class="n">SbModelIndepPeaks</span><span class="p">(</span><span class="n">nrings</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">common_fwhm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">no_xy_shift</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">distortion</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">az</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">el</span><span class="p">))</span>
        <span class="n">fitmap</span><span class="p">,</span> <span class="n">newxxyy</span> <span class="o">=</span> <span class="n">sbfitmodel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fitpars</span><span class="p">,</span> <span class="n">return_peaks</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">themap</span><span class="p">,</span> <span class="n">az</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">fitmap</span><span class="p">,</span> <span class="n">newxxyy</span></div>



<div class="viewcode-block" id="show_flatmap">
<a class="viewcode-back" href="../../qubic.html#qubic.sb_fitting.show_flatmap">[docs]</a>
<span class="k">def</span> <span class="nf">show_flatmap</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">TESNum</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">flatmap</span><span class="p">,</span> <span class="n">az</span><span class="p">,</span> <span class="n">el</span> <span class="o">=</span> <span class="n">get_flatmap</span><span class="p">(</span><span class="n">TESNum</span><span class="p">,</span> <span class="n">directory</span><span class="p">)</span>
    <span class="n">imshow</span><span class="p">(</span><span class="n">flatmap</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">az</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">az</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">el</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">el</span><span class="p">)],</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
    <span class="n">title</span><span class="p">(</span><span class="s1">&#39;TES #</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">TESNum</span><span class="p">))</span>
    <span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Az angle&#39;</span><span class="p">)</span>
    <span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;El&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cbar</span><span class="p">:</span>
        <span class="n">colorbar</span><span class="p">()</span></div>



<div class="viewcode-block" id="show_flatmaps_list">
<a class="viewcode-back" href="../../qubic.html#qubic.sb_fitting.show_flatmaps_list">[docs]</a>
<span class="k">def</span> <span class="nf">show_flatmaps_list</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">TESNums</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">tight</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">nn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">TESNums</span><span class="p">)</span>
    <span class="n">ny</span> <span class="o">=</span> <span class="n">nn</span> <span class="o">/</span> <span class="n">nx</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">TESNums</span><span class="p">:</span>
        <span class="n">subplot</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ii</span><span class="p">)</span>
        <span class="n">show_flatmap</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">nn</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="n">cbar</span><span class="p">)</span>
        <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">tight</span><span class="p">:</span>
        <span class="n">tight_layout</span><span class="p">()</span></div>



<div class="viewcode-block" id="beeps">
<a class="viewcode-back" href="../../qubic.html#qubic.sb_fitting.beeps">[docs]</a>
<span class="k">def</span> <span class="nf">beeps</span><span class="p">(</span><span class="n">nbeeps</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="n">beep</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;echo -n &#39;</span><span class="se">\a</span><span class="s2">&#39;;sleep 0.2;&quot;</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">beep</span><span class="p">(</span><span class="n">nbeeps</span><span class="p">)</span></div>



<div class="viewcode-block" id="thph2uv">
<a class="viewcode-back" href="../../qubic.html#qubic.sb_fitting.thph2uv">[docs]</a>
<span class="k">def</span> <span class="nf">thph2uv</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="n">ph</span><span class="p">):</span>
    <span class="n">sth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">th</span><span class="p">)</span>
    <span class="n">cth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">)</span>
    <span class="n">sph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
    <span class="n">cph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sth</span> <span class="o">*</span> <span class="n">cph</span><span class="p">,</span> <span class="n">sth</span> <span class="o">*</span> <span class="n">sph</span><span class="p">,</span> <span class="n">cth</span><span class="p">])</span></div>


<div class="viewcode-block" id="ang_dist">
<a class="viewcode-back" href="../../qubic.html#qubic.sb_fitting.ang_dist">[docs]</a>
<span class="k">def</span> <span class="nf">ang_dist</span><span class="p">(</span><span class="n">thph0</span><span class="p">,</span> <span class="n">thph1</span><span class="p">):</span>
    <span class="n">uv0</span> <span class="o">=</span> <span class="n">thph2uv</span><span class="p">(</span><span class="n">thph0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">thph0</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">uv1</span> <span class="o">=</span> <span class="n">thph2uv</span><span class="p">(</span><span class="n">thph1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">thph1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">uv0</span><span class="o">*</span><span class="n">uv1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ang</span></div>


<div class="viewcode-block" id="uv2thph">
<a class="viewcode-back" href="../../qubic.html#qubic.sb_fitting.uv2thph">[docs]</a>
<span class="k">def</span> <span class="nf">uv2thph</span><span class="p">(</span><span class="n">uv</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">uv</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">uv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">r</span><span class="p">))</span>
    <span class="n">ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">uv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">uv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">th</span><span class="p">,</span> <span class="n">ph</span><span class="p">])</span></div>



<div class="viewcode-block" id="rotmatX">
<a class="viewcode-back" href="../../qubic.html#qubic.sb_fitting.rotmatX">[docs]</a>
<span class="k">def</span> <span class="nf">rotmatX</span><span class="p">(</span><span class="n">th</span><span class="p">):</span>
    <span class="n">cth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">)</span>
    <span class="n">sth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">th</span><span class="p">)</span>
    <span class="n">rotmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">cth</span><span class="p">,</span> <span class="o">-</span><span class="n">sth</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">sth</span><span class="p">,</span> <span class="n">cth</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">rotmat</span></div>



<div class="viewcode-block" id="rotmatY">
<a class="viewcode-back" href="../../qubic.html#qubic.sb_fitting.rotmatY">[docs]</a>
<span class="k">def</span> <span class="nf">rotmatY</span><span class="p">(</span><span class="n">th</span><span class="p">):</span>
    <span class="n">cth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">)</span>
    <span class="n">sth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">th</span><span class="p">)</span>
    <span class="n">rotmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">cth</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sth</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="n">sth</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cth</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">rotmat</span></div>



<div class="viewcode-block" id="rotmatZ">
<a class="viewcode-back" href="../../qubic.html#qubic.sb_fitting.rotmatZ">[docs]</a>
<span class="k">def</span> <span class="nf">rotmatZ</span><span class="p">(</span><span class="n">th</span><span class="p">):</span>
    <span class="n">cth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">)</span>
    <span class="n">sth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">th</span><span class="p">)</span>
    <span class="n">rotmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">cth</span><span class="p">,</span> <span class="o">-</span><span class="n">sth</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">sth</span><span class="p">,</span> <span class="n">cth</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">rotmat</span></div>



<span class="c1">### Rotation from QUBIC reference frame to the measurement one</span>
<div class="viewcode-block" id="rotate_q2m">
<a class="viewcode-back" href="../../qubic.html#qubic.sb_fitting.rotate_q2m">[docs]</a>
<span class="k">def</span> <span class="nf">rotate_q2m</span><span class="p">(</span><span class="n">thin</span><span class="p">,</span> <span class="n">phin</span><span class="p">,</span> <span class="n">angs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])),</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1">#### All Angles in Radians</span>
    <span class="n">uvecin</span> <span class="o">=</span> <span class="n">thph2uv</span><span class="p">(</span><span class="n">thin</span><span class="p">,</span> <span class="n">phin</span><span class="p">)</span>
    <span class="c1">### First rotation: pitch angle around optical axis</span>
    <span class="n">r0</span> <span class="o">=</span> <span class="n">rotmatZ</span><span class="p">(</span><span class="n">angs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1">### Second rotation: down to actual elevation</span>
    <span class="n">r1</span> <span class="o">=</span> <span class="n">rotmatY</span><span class="p">(</span><span class="n">angs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1">### Third rotation: go to actual azimuth</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">rotmatZ</span><span class="p">(</span><span class="n">angs</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="c1"># uvecout = np.dot(r2, np.dot(r1, np.dot(r0, uvecin)))</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r0</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">inverse</span><span class="p">:</span>
        <span class="n">Rinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
        <span class="n">uvecout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Rinv</span><span class="p">,</span> <span class="n">uvecin</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">uvecout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">uvecin</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">uv2thph</span><span class="p">(</span><span class="n">uvecout</span><span class="p">)</span></div>



<span class="c1">#######################################################################################################################################</span>
<span class="c1"># ######################################################################################################################################</span>
<div class="viewcode-block" id="SimpleSbModel">
<a class="viewcode-back" href="../../qubic.html#qubic.sb_fitting.SimpleSbModel">[docs]</a>
<span class="k">class</span> <span class="nc">SimpleSbModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class defining the simplest Synthesized Beam model for QUBIC:</span>
<span class="sd">    - A square grid of n Gaussian Peaks with the same symmetric FWHM.</span>
<span class="sd">    - n is defined by nrings (1=&gt;1 peak, 2=&gt;9 peaks, ...)</span>
<span class="sd">    - The square grid has a rotation angle</span>
<span class="sd">    - The amplitude of the peaks is given by a common Primary Gaussian Beam whose FWHM and center is fit</span>
<span class="sd">    - A distorsion to the position of the peaks is allowed</span>

<span class="sd">    So Finally parameters are:</span>
<span class="sd">    [0]: Az center of the square [deg]</span>
<span class="sd">    [1]: El center of the square [deg]</span>
<span class="sd">    [2]: Interpeak distance [deg]</span>
<span class="sd">    [3]: Orientation angle [deg]</span>
<span class="sd">    [4]: X distorsion magnitude</span>
<span class="sd">    [5]: X distosion power</span>
<span class="sd">    [6]: Y distorsion magnitude</span>
<span class="sd">    [7]: Y distorsion power</span>
<span class="sd">    [8]: FWHM of the peaks [deg]</span>
<span class="sd">    [9]: Amplitude of primary beam</span>
<span class="sd">    [10]: Az center of primary beam [deg]</span>
<span class="sd">    [11]: El center of primary beam [deg]</span>
<span class="sd">    [12]: FWHM of primary beam [deg]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">startpars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ranges</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fixpars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrings</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1">### Preparing the grid of peaks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;SimpleSbModel&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nrings</span> <span class="o">=</span> <span class="n">nrings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npeaks_line</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nrings</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npeaks_line</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npeaks_line</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nrings</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xxyy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">xx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">yy</span><span class="p">)])</span>

        <span class="c1">### Parameters names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npars</span> <span class="o">=</span> <span class="mi">13</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AzCenter&#39;</span><span class="p">,</span> <span class="s1">&#39;ElCenter&#39;</span><span class="p">,</span> <span class="s1">&#39;PeakDist&#39;</span><span class="p">,</span> <span class="s1">&#39;Angle&#39;</span><span class="p">,</span> <span class="s1">&#39;XDistAmp&#39;</span><span class="p">,</span> <span class="s1">&#39;XDistPow&#39;</span><span class="p">,</span> <span class="s1">&#39;YDistAmp&#39;</span><span class="p">,</span> <span class="s1">&#39;YDistPow&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;FWHMPeaks&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;PrimAmp&#39;</span><span class="p">,</span> <span class="s1">&#39;PrimAzCenter&#39;</span><span class="p">,</span> <span class="s1">&#39;PrimElCenter&#39;</span><span class="p">,</span> <span class="s1">&#39;PrimFWHM&#39;</span><span class="p">]</span>
        <span class="c1">### Default parameters</span>
        <span class="k">if</span> <span class="n">startpars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startpars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">50.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">45.</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">1e5</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">50.</span><span class="p">,</span> <span class="mf">13.</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startpars</span> <span class="o">=</span> <span class="n">startpars</span>

        <span class="c1">### Fixed parameters</span>
        <span class="k">if</span> <span class="n">fixpars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fixpars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startpars</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fixpars</span> <span class="o">=</span> <span class="n">fixpars</span>

        <span class="c1">### Range allowed for fitting</span>
        <span class="k">if</span> <span class="n">ranges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">5.</span><span class="p">,</span> <span class="mf">45.</span><span class="p">,</span> <span class="mf">7.</span><span class="p">,</span> <span class="mf">40.</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.</span><span class="p">,</span> <span class="mf">47.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mf">5.</span><span class="p">,</span> <span class="mf">55.</span><span class="p">,</span> <span class="mf">9.</span><span class="p">,</span> <span class="mf">50.</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">4.</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">4.</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">1e6</span><span class="p">,</span> <span class="mf">3.</span><span class="p">,</span> <span class="mf">53.</span><span class="p">,</span> <span class="mf">16.</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span> <span class="o">=</span> <span class="n">ranges</span>

        <span class="c1">### Possible extra-arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_args</span> <span class="o">=</span> <span class="n">extra_args</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">return_peaks</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">x2d</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># The Azimuth values of the pixels</span>
        <span class="n">y2d</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># The elevation values of the pixels</span>
        <span class="c1"># The parameters ##########################################</span>
        <span class="n">xc</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">yc</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">distx</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">distpowerX</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">disty</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">distpowerY</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">fwhmpeaks</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">ampgauss</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
        <span class="n">xcgauss</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>
        <span class="n">ycgauss</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span>
        <span class="n">fwhmgauss</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span>

        <span class="c1"># Peaks positions #########################################</span>
        <span class="c1"># Rotate initial Grid centered on (0,0)</span>
        <span class="n">cosang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span>
        <span class="n">sinang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span>
        <span class="n">rotmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">cosang</span><span class="p">,</span> <span class="o">-</span><span class="n">sinang</span><span class="p">],</span> <span class="p">[</span><span class="n">sinang</span><span class="p">,</span> <span class="n">cosang</span><span class="p">]])</span>
        <span class="n">newxxyy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span><span class="p">):</span>
            <span class="n">newxxyy</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rotmat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xxyy</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
        <span class="c1"># Scale it wit interpeak distance</span>
        <span class="n">newxxyy</span> <span class="o">*=</span> <span class="n">dist</span>
        <span class="c1"># Apply Distorsions</span>
        <span class="n">undistxxyy</span> <span class="o">=</span> <span class="n">newxxyy</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">newxxyy</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">distx</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">undistxxyy</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span> <span class="o">**</span> <span class="n">distpowerX</span>
        <span class="n">newxxyy</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">disty</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">undistxxyy</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span> <span class="o">**</span> <span class="n">distpowerY</span>
        <span class="c1"># Move to actual center</span>
        <span class="n">newxxyy</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">xc</span>
        <span class="n">newxxyy</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">yc</span>

        <span class="c1">### Peak amplitudes and resulting map #######################</span>
        <span class="n">themap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x2d</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">amps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span><span class="p">):</span>
            <span class="n">amp</span> <span class="o">=</span> <span class="n">ampgauss</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">((</span><span class="n">xcgauss</span> <span class="o">-</span> <span class="n">newxxyy</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">ycgauss</span> <span class="o">-</span> <span class="n">newxxyy</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">fwhmgauss</span> <span class="o">/</span> <span class="mf">2.35</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">newxxyy</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">y0</span> <span class="o">=</span> <span class="n">newxxyy</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">fwhmpeaks</span> <span class="o">/</span> <span class="mf">2.35</span>
            <span class="n">themap</span> <span class="o">+=</span> <span class="n">ne</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="s2">&quot;amp * exp(-0.5*((x2d-x0)**2 + (y2d-y0)**2)/sig**2)&quot;</span><span class="p">)</span>

        <span class="n">newxxyy</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">amps</span>
        <span class="n">newxxyy</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">fwhmpeaks</span>

        <span class="k">if</span> <span class="n">return_peaks</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">themap</span><span class="p">,</span> <span class="n">newxxyy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">themap</span><span class="p">)</span>

<div class="viewcode-block" id="SimpleSbModel.print_start">
<a class="viewcode-back" href="../../qubic.html#qubic.sb_fitting.SimpleSbModel.print_start">[docs]</a>
    <span class="k">def</span> <span class="nf">print_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|---------------------------------------------------------------------|&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|-------------------- Initial Parameters -----------------------------|&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|---------------------------------------------------------------------|&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|Parameter        | init-value | range0      | range1      |  fixed   |&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|---------------------------------------------------------------------|&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npars</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|</span><span class="si">{0:&lt;16}</span><span class="s1"> | </span><span class="si">{1:&gt;10.3f}</span><span class="s1"> |</span><span class="si">{2:&gt;13.3f}</span><span class="s1">|</span><span class="si">{3:&gt;13.3f}</span><span class="s1">|    </span><span class="si">{4:^3}</span><span class="s1">   |&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parnames</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                                                       <span class="bp">self</span><span class="o">.</span><span class="n">startpars</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                                                       <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span>
                                                                                       <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span>
                                                                                       <span class="bp">self</span><span class="o">.</span><span class="n">fixpars</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|---------------------------------------------------------------------|&#39;</span><span class="p">)</span></div>
</div>



<span class="c1">#######################################################################################################################################</span>
<span class="c1"># ######################################################################################################################################</span>


<span class="c1">#######################################################################################################################################</span>
<span class="c1"># ######################################################################################################################################</span>
<div class="viewcode-block" id="SbModelIndepPeaksAmpFWHM">
<a class="viewcode-back" href="../../qubic.html#qubic.sb_fitting.SbModelIndepPeaksAmpFWHM">[docs]</a>
<span class="k">class</span> <span class="nc">SbModelIndepPeaksAmpFWHM</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class defining the simplest Synthesized Beam model for QUBIC:</span>
<span class="sd">    - A square grid of n Gaussian Peaks with the same symmetric FWHM.</span>
<span class="sd">    - n is defined by nrings (1=&gt;1 peak, 2=&gt;9 peaks, ...)</span>
<span class="sd">    - The square grid has a rotation angle</span>
<span class="sd">    - The amplitude of the peaks are independent</span>
<span class="sd">    - The FWHM of the peaks can be all the same or different depending on the keyword common_fwhm</span>
<span class="sd">      If common_fwhm is True then this model is equivalent to SbModelIndepPeaksAmp</span>
<span class="sd">    - A distorsion to the position of the peaks is allowed</span>

<span class="sd">    So Finally parameters are:</span>
<span class="sd">    [0]: Az center of the square [deg]</span>
<span class="sd">    [1]: El center of the square [deg]</span>
<span class="sd">    [2]: Interpeak distance [deg]</span>
<span class="sd">    [3]: Orientation angle [deg]</span>
<span class="sd">    [4]: X distorsion magnitude</span>
<span class="sd">    [5]: X distosion power</span>
<span class="sd">    [6]: Y distorsion magnitude</span>
<span class="sd">    [7]: Y distorsion power</span>
<span class="sd">    [8]: Average FWHM of the peaks</span>
<span class="sd">    [9+2*ipeak]: Amplitudes of the peaks</span>
<span class="sd">    [9+2*ipeak+1]: Delta FWHM of each peak to be added to the average one [deg]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">startpars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ranges</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fixpars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrings</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">common_fwhm</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1">### Preparing the grid of peaks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;SbModelIndepPeaksAmpFWHM&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">common_fwhm</span> <span class="o">=</span> <span class="n">common_fwhm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nrings</span> <span class="o">=</span> <span class="n">nrings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npeaks_line</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nrings</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npeaks_line</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npeaks_line</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nrings</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xxyy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">xx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">yy</span><span class="p">)])</span>

        <span class="n">npars</span> <span class="o">=</span> <span class="mi">9</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npars</span> <span class="o">=</span> <span class="n">npars</span>
        <span class="c1">### Parameters names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parnames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="s1">&#39;              &#39;</span><span class="p">,</span> <span class="n">npars</span><span class="p">)</span>
        <span class="n">firstparnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AzCenter&#39;</span><span class="p">,</span> <span class="s1">&#39;ElCenter&#39;</span><span class="p">,</span> <span class="s1">&#39;PeakDist&#39;</span><span class="p">,</span> <span class="s1">&#39;Angle&#39;</span><span class="p">,</span> <span class="s1">&#39;XDistAmp&#39;</span><span class="p">,</span> <span class="s1">&#39;XDistPow&#39;</span><span class="p">,</span> <span class="s1">&#39;YDistAmp&#39;</span><span class="p">,</span> <span class="s1">&#39;YDistPow&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;FWHMPeaksAv&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parnames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstparnames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parnames</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;AmpPeak</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parnames</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;DeltaFWHMPeak</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1">### Default parameters</span>
        <span class="k">if</span> <span class="n">startpars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startpars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npars</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startpars</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">50.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">45.</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">startpars</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e5</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">startpars</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startpars</span> <span class="o">=</span> <span class="n">startpars</span>

        <span class="c1">### Fixed parameters</span>
        <span class="k">if</span> <span class="n">fixpars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fixpars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startpars</span><span class="p">))</span>
            <span class="c1">### A subtlety here: if we ask for a fit with common FWHM for all peaks, then we need to fix the individual</span>
            <span class="c1">### FWHMs to zero (as at the end the FWHM used is the sum of the two). In the other case, when we want to fit</span>
            <span class="c1">### diffferent FWHM for each, then the average fwhm is fixed while the others can var around zero</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">common_fwhm</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fixpars</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fixpars</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fixpars</span> <span class="o">=</span> <span class="n">fixpars</span>

        <span class="c1">### Range allowed for fitting</span>
        <span class="k">if</span> <span class="n">ranges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">npars</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">5.</span><span class="p">,</span> <span class="mf">45.</span><span class="p">,</span> <span class="mf">7.</span><span class="p">,</span> <span class="mf">40.</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>
                                            <span class="p">[</span><span class="mf">5.</span><span class="p">,</span> <span class="mf">55.</span><span class="p">,</span> <span class="mf">9.</span><span class="p">,</span> <span class="mf">50.</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">4.</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">4.</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">]])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e6</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span> <span class="o">=</span> <span class="n">ranges</span>

        <span class="c1">### Possible extra-arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_args</span> <span class="o">=</span> <span class="n">extra_args</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_start</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">return_peaks</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">x2d</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># The Azimuth values of the pixels</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x2d</span><span class="p">)</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x2d</span><span class="p">)</span>
        <span class="n">y2d</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># The elevation values of the pixels</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y2d</span><span class="p">)</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y2d</span><span class="p">)</span>
        <span class="c1"># The parameters ##########################################</span>
        <span class="n">xc</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">yc</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">distx</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">distpowerX</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">disty</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">distpowerY</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">fwhmpeaks_av</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">amps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span><span class="p">)</span>
        <span class="n">fwhmpeaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span><span class="p">):</span>
            <span class="n">amps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">fwhmpeaks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fwhmpeaks_av</span> <span class="o">+</span> <span class="n">pars</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1">### Peaks positions #########################################</span>
        <span class="c1"># Rotate initial Grid centered on (0,0)</span>
        <span class="n">cosang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span>
        <span class="n">sinang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span>
        <span class="n">rotmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">cosang</span><span class="p">,</span> <span class="o">-</span><span class="n">sinang</span><span class="p">],</span> <span class="p">[</span><span class="n">sinang</span><span class="p">,</span> <span class="n">cosang</span><span class="p">]])</span>
        <span class="n">newxxyy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span><span class="p">):</span> <span class="n">newxxyy</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rotmat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xxyy</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
        <span class="c1"># Scale it wit interpeak distance</span>
        <span class="n">newxxyy</span> <span class="o">*=</span> <span class="n">dist</span>
        <span class="c1"># Apply Distorsions</span>
        <span class="n">undistxxyy</span> <span class="o">=</span> <span class="n">newxxyy</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">yok</span> <span class="o">=</span> <span class="n">undistxxyy</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">newxxyy</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">yok</span><span class="p">]</span> <span class="o">+=</span> <span class="n">distx</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">undistxxyy</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">yok</span><span class="p">])</span> <span class="o">**</span> <span class="n">distpowerX</span>
        <span class="n">xok</span> <span class="o">=</span> <span class="n">undistxxyy</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">newxxyy</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">xok</span><span class="p">]</span> <span class="o">+=</span> <span class="n">disty</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">undistxxyy</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">xok</span><span class="p">])</span> <span class="o">**</span> <span class="n">distpowerY</span>
        <span class="c1"># Move to actual center</span>
        <span class="n">newxxyy</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">xc</span>
        <span class="n">newxxyy</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">yc</span>
        <span class="k">if</span> <span class="o">~</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">newxxyy</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)):</span>
            <span class="n">stop</span>

        <span class="c1">### Peak amplitudes and resulting map #######################</span>
        <span class="c1"># themap = np.zeros(x2d.shape)</span>
        <span class="c1"># for i in range(self.npeaks):</span>
        <span class="c1"># 	themap += amps[i]*np.exp(-((x2d-newxxyy[0,i])**2 +(y2d-newxxyy[1,i])**2)/(2*(fwhmpeaks[i]/2.35)**2) )</span>
        <span class="n">themap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x2d</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span><span class="p">):</span>
            <span class="n">amp</span> <span class="o">=</span> <span class="n">amps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">newxxyy</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">y0</span> <span class="o">=</span> <span class="n">newxxyy</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">fwhmpeaks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.35</span>
            <span class="n">themap</span> <span class="o">+=</span> <span class="n">ne</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="s2">&quot;amp * exp(-0.5*((x2d-x0)**2 + (y2d-y0)**2)/sig**2)&quot;</span><span class="p">)</span>

        <span class="n">newxxyy</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">amps</span>
        <span class="n">newxxyy</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">fwhmpeaks</span>

        <span class="k">if</span> <span class="n">return_peaks</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">themap</span><span class="p">,</span> <span class="n">newxxyy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">themap</span><span class="p">)</span>

<div class="viewcode-block" id="SbModelIndepPeaksAmpFWHM.print_start">
<a class="viewcode-back" href="../../qubic.html#qubic.sb_fitting.SbModelIndepPeaksAmpFWHM.print_start">[docs]</a>
    <span class="k">def</span> <span class="nf">print_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|---------------------------------------------------------------------|&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|-------------------- Initial Parameters -----------------------------|&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|            Important: common_fwhm = </span><span class="si">{0:}</span><span class="s1">                            |&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">common_fwhm</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|---------------------------------------------------------------------|&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|Parameter        | init-value | range0      | range1      |  fixed   |&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|---------------------------------------------------------------------|&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npars</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|</span><span class="si">{0:&lt;16}</span><span class="s1"> | </span><span class="si">{1:&gt;10.3f}</span><span class="s1"> |</span><span class="si">{2:&gt;13.3f}</span><span class="s1">|</span><span class="si">{3:&gt;13.3f}</span><span class="s1">|    </span><span class="si">{4:^3}</span><span class="s1">   |&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parnames</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                                                       <span class="bp">self</span><span class="o">.</span><span class="n">startpars</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                                                       <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span>
                                                                                       <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span>
                                                                                       <span class="bp">self</span><span class="o">.</span><span class="n">fixpars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|---------------------------------------------------------------------|&#39;</span><span class="p">)</span></div>
</div>



<span class="c1">#######################################################################################################################################</span>
<span class="c1"># ######################################################################################################################################</span>


<span class="c1">#######################################################################################################################################</span>
<span class="c1"># ######################################################################################################################################</span>
<div class="viewcode-block" id="SbModelIndepPeaks">
<a class="viewcode-back" href="../../qubic.html#qubic.sb_fitting.SbModelIndepPeaks">[docs]</a>
<span class="k">class</span> <span class="nc">SbModelIndepPeaks</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class defining the simplest Synthesized Beam model for QUBIC:</span>
<span class="sd">    - A square grid of n Gaussian Peaks with the same symmetric FWHM.</span>
<span class="sd">    - n is defined by nrings (1=&gt;1 peak, 2=&gt;9 peaks, ...)</span>
<span class="sd">    - The square grid has a rotation angle</span>
<span class="sd">    - The amplitude of the peaks are independent</span>
<span class="sd">    - The FWHM of the peaks can be all the same or different depending on the keyword common_fwhm</span>
<span class="sd">      If common_fwhm is True then this model is equivalent to SbModelIndepPeaksAmp</span>
<span class="sd">    - A global distorsion to the position of the peaks is allowed</span>
<span class="sd">    - A small shift of each peak position is allowed around the initial position</span>

<span class="sd">    So if common_fwhm=True and no_xy_shift=True and distrotion=True this model is equivalent to SbModelIndepPeaksAmp</span>
<span class="sd">    So if common_fwhm=False and no_xy_shift=True and distortion=True this model is equivalent to SbModelIndepPeaksAmpFWHM</span>

<span class="sd">    So Finally parameters are:</span>
<span class="sd">    [0]: Az center of the square [deg]</span>
<span class="sd">    [1]: El center of the square [deg]</span>
<span class="sd">    [2]: Interpeak distance [deg]</span>
<span class="sd">    [3]: Orientation angle [deg]</span>
<span class="sd">    [4]: X distorsion magnitude</span>
<span class="sd">    [5]: X distosion power</span>
<span class="sd">    [6]: Y distorsion magnitude</span>
<span class="sd">    [7]: Y distorsion power</span>
<span class="sd">    [8]: Average FWHM of the peaks</span>
<span class="sd">    [9+4*ipeak]: Amplitudes of the peaks</span>
<span class="sd">    [9+4*ipeak+1]: Delta FWHM of each peak to be added to the average one [deg]</span>
<span class="sd">    [9+4*ipeak+2]: X shift of the peak [deg]</span>
<span class="sd">    [9+4*ipeak+3]: Y shift of the peak [deg]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">startpars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ranges</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fixpars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrings</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">common_fwhm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_xy_shift</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">distortion</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1">### Preparing the grid of peaks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;SbModelIndepPeaks&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">common_fwhm</span> <span class="o">=</span> <span class="n">common_fwhm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_xy_shift</span> <span class="o">=</span> <span class="n">no_xy_shift</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distortion</span> <span class="o">=</span> <span class="n">distortion</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nrings</span> <span class="o">=</span> <span class="n">nrings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npeaks_line</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nrings</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npeaks_line</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npeaks_line</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nrings</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xxyy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">xx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">yy</span><span class="p">)])</span>

        <span class="n">npars</span> <span class="o">=</span> <span class="mi">9</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span> <span class="o">*</span> <span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npars</span> <span class="o">=</span> <span class="n">npars</span>
        <span class="c1">### Parameters names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parnames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="s1">&#39;              &#39;</span><span class="p">,</span> <span class="n">npars</span><span class="p">)</span>
        <span class="n">firstparnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AzCenter&#39;</span><span class="p">,</span> <span class="s1">&#39;ElCenter&#39;</span><span class="p">,</span> <span class="s1">&#39;PeakDist&#39;</span><span class="p">,</span> <span class="s1">&#39;Angle&#39;</span><span class="p">,</span> <span class="s1">&#39;XDistAmp&#39;</span><span class="p">,</span> <span class="s1">&#39;XDistPow&#39;</span><span class="p">,</span> <span class="s1">&#39;YDistAmp&#39;</span><span class="p">,</span> <span class="s1">&#39;YDistPow&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;FWHMPeaksAv&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parnames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstparnames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parnames</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;AmpPeak</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parnames</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;DeltaFWHMPeak</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parnames</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;DeltaXPeak</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parnames</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;DeltaYPeak</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1">### Default parameters</span>
        <span class="k">if</span> <span class="n">startpars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startpars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npars</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startpars</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">50.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">45.</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">startpars</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e5</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">startpars</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">startpars</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">startpars</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startpars</span> <span class="o">=</span> <span class="n">startpars</span>

        <span class="c1">### Fixed parameters</span>
        <span class="k">if</span> <span class="n">fixpars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fixpars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startpars</span><span class="p">))</span>
            <span class="c1">### A subtlety here: if we ask for a fit with common FWHM for all peaks, then we need to fix the individual</span>
            <span class="c1">### FWHMs to zero (as at the end the FWHM used is the sum of the two). In the other case, when we want to fit</span>
            <span class="c1">### diffferent FWHM for each, then the average fwhm is fixed while the others can var around zero</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">common_fwhm</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fixpars</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fixpars</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_xy_shift</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fixpars</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fixpars</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distortion</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fixpars</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fixpars</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fixpars</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fixpars</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fixpars</span> <span class="o">=</span> <span class="n">fixpars</span>

        <span class="c1">### Range allowed for fitting</span>
        <span class="k">if</span> <span class="n">ranges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">npars</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">5.</span><span class="p">,</span> <span class="mf">45.</span><span class="p">,</span> <span class="mf">7.</span><span class="p">,</span> <span class="mf">40.</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>
                                            <span class="p">[</span><span class="mf">5.</span><span class="p">,</span> <span class="mf">55.</span><span class="p">,</span> <span class="mf">9.</span><span class="p">,</span> <span class="mf">50.</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">4.</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">4.</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">]])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e6</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span> <span class="o">=</span> <span class="n">ranges</span>

        <span class="c1">### Possible extra-arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_args</span> <span class="o">=</span> <span class="n">extra_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncalls</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_start</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">mypars</span><span class="p">,</span> <span class="n">return_peaks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extra_args</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1"># t0 = time.time()</span>
        <span class="c1"># self.ncalls += 1</span>
        <span class="c1"># print(&#39;Call #{0} - {1:5.2f} ms &#39;.format(self.ncalls, 1000*(t0-self.time)))</span>
        <span class="c1"># self.time = t0</span>
        <span class="n">x2d</span><span class="p">,</span> <span class="n">y2d</span> <span class="o">=</span> <span class="n">x</span>  <span class="c1"># The Azimuth and elevation values of the pixels</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">mypars</span><span class="p">)</span>
        <span class="c1"># The parameters ##########################################</span>
        <span class="n">xc</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">yc</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">distx</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">distpowerX</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">disty</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">distpowerY</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">fwhmpeaks_av</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">amps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span><span class="p">)</span>
        <span class="n">fwhmpeaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span><span class="p">)</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span><span class="p">)</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span><span class="p">):</span>
            <span class="n">amps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">fwhmpeaks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fwhmpeaks_av</span> <span class="o">+</span> <span class="n">pars</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">dx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">dy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>

        <span class="c1">### Peaks positions #########################################</span>
        <span class="c1"># Rotate initial Grid centered on (0,0)</span>
        <span class="n">cosang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span>
        <span class="n">sinang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span>
        <span class="n">rotmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">cosang</span><span class="p">,</span> <span class="o">-</span><span class="n">sinang</span><span class="p">],</span> <span class="p">[</span><span class="n">sinang</span><span class="p">,</span> <span class="n">cosang</span><span class="p">]])</span>
        <span class="n">newxxyy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span><span class="p">):</span> <span class="n">newxxyy</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rotmat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xxyy</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
        <span class="c1"># Scale it wit interpeak distance</span>
        <span class="n">newxxyy</span> <span class="o">*=</span> <span class="n">dist</span>
        <span class="c1"># Apply Distorsions</span>
        <span class="n">undistxxyy</span> <span class="o">=</span> <span class="n">newxxyy</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">yok</span> <span class="o">=</span> <span class="n">undistxxyy</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">newxxyy</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">yok</span><span class="p">]</span> <span class="o">+=</span> <span class="n">distx</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">undistxxyy</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">yok</span><span class="p">])</span> <span class="o">**</span> <span class="n">distpowerX</span>
        <span class="n">xok</span> <span class="o">=</span> <span class="n">undistxxyy</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">newxxyy</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">xok</span><span class="p">]</span> <span class="o">+=</span> <span class="n">disty</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">undistxxyy</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">xok</span><span class="p">])</span> <span class="o">**</span> <span class="n">distpowerY</span>
        <span class="c1"># Move to actual center</span>
        <span class="n">newxxyy</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">xc</span> <span class="o">+</span> <span class="n">dx</span>
        <span class="n">newxxyy</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">yc</span> <span class="o">+</span> <span class="n">dy</span>
        <span class="k">if</span> <span class="o">~</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">newxxyy</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)):</span>
            <span class="n">stop</span>

        <span class="c1">### Peak amplitudes and resulting map #######################</span>
        <span class="c1"># themap = np.zeros(np.shape(x2d))</span>
        <span class="c1"># for i in range(self.npeaks):</span>
        <span class="c1"># 	themap += amps[i]*np.exp(-((x2d-newxxyy[0,i])**2 +(y2d-newxxyy[1,i])**2)/(2*(fwhmpeaks[i]/2.35)**2) )</span>

        <span class="c1">### Peak amplitudes and resulting map #######################</span>
        <span class="c1">### Much faster version (gain ~3.5)</span>
        <span class="n">themap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x2d</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npeaks</span><span class="p">):</span>
            <span class="n">amp</span> <span class="o">=</span> <span class="n">amps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">newxxyy</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">y0</span> <span class="o">=</span> <span class="n">newxxyy</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">fwhmpeaks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.35</span>
            <span class="n">themap</span> <span class="o">+=</span> <span class="n">ne</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="s2">&quot;amp * exp(-0.5*((x2d-x0)**2 + (y2d-y0)**2)/sig**2)&quot;</span><span class="p">)</span>

        <span class="n">newxxyy</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">amps</span>
        <span class="n">newxxyy</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">fwhmpeaks</span>

        <span class="k">if</span> <span class="n">return_peaks</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">themap</span><span class="p">,</span> <span class="n">newxxyy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">themap</span><span class="p">)</span>

<div class="viewcode-block" id="SbModelIndepPeaks.print_start">
<a class="viewcode-back" href="../../qubic.html#qubic.sb_fitting.SbModelIndepPeaks.print_start">[docs]</a>
    <span class="k">def</span> <span class="nf">print_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|---------------------------------------------------------------------|&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|-------------------- Initial Parameters -----------------------------|&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|            Important: common_fwhm = </span><span class="si">{0:}</span><span class="s1">                            |&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">common_fwhm</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|            Important: no_xy_shift = </span><span class="si">{0:}</span><span class="s1">                            |&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_xy_shift</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|---------------------------------------------------------------------|&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|Parameter        | init-value | range0      | range1      |  fixed   |&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|---------------------------------------------------------------------|&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npars</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|</span><span class="si">{0:&lt;16}</span><span class="s1"> | </span><span class="si">{1:&gt;10.3f}</span><span class="s1"> |</span><span class="si">{2:&gt;13.3f}</span><span class="s1">|</span><span class="si">{3:&gt;13.3f}</span><span class="s1">|    </span><span class="si">{4:^3}</span><span class="s1">   |&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parnames</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                                                       <span class="bp">self</span><span class="o">.</span><span class="n">startpars</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                                                       <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span>
                                                                                       <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span>
                                                                                       <span class="bp">self</span><span class="o">.</span><span class="n">fixpars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|---------------------------------------------------------------------|&#39;</span><span class="p">)</span></div>
</div>



<span class="c1">#######################################################################################################################################</span>
<span class="c1"># ######################################################################################################################################</span>


<div class="viewcode-block" id="fit_sb">
<a class="viewcode-back" href="../../qubic.html#qubic.sb_fitting.fit_sb">[docs]</a>
<span class="k">def</span> <span class="nf">fit_sb</span><span class="p">(</span><span class="n">flatmap_init</span><span class="p">,</span> <span class="n">az_init</span><span class="p">,</span> <span class="n">el_init</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">newsize</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span> <span class="n">az_center</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">el_center</span><span class="o">=</span><span class="mf">50.</span><span class="p">,</span>
           <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
           <span class="n">resample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extra_title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">return_fitted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nsiglo</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">nsighi</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span>
           <span class="n">figsave</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1">#### If requested, resample the iage in order to speedup the fitting</span>
    <span class="k">if</span> <span class="n">resample</span><span class="p">:</span>
        <span class="c1">### Resample input map to have less pixels to deal with for fitting</span>
        <span class="n">flatmap</span> <span class="o">=</span> <span class="n">scsig</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">scsig</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">flatmap_init</span><span class="p">,</span> <span class="n">newsize</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">newsize</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">az</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">az_init</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">az_init</span><span class="p">),</span> <span class="n">newsize</span><span class="p">)</span>
        <span class="n">el</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">el_init</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">el_init</span><span class="p">),</span> <span class="n">newsize</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flatmap</span> <span class="o">=</span> <span class="n">flatmap_init</span>
        <span class="n">az</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">az_init</span><span class="p">)</span>
        <span class="n">el</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">el_init</span><span class="p">)</span>
    <span class="n">az2d</span><span class="p">,</span> <span class="n">el2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">az</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">el_center</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">el</span><span class="p">))</span>

    <span class="c1"># if verbose:</span>
    <span class="c1"># 	print(&#39;fit_sb: Model Name = &#39;,model.name)</span>
    <span class="c1"># 	print(&#39;Initial Parameters:&#39;)</span>
    <span class="c1"># 	model.print_start()</span>

    <span class="c1">### First find the location of the maximum closest to the center</span>
    <span class="n">distance_max</span> <span class="o">=</span> <span class="n">dmax</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">az2d</span> <span class="o">-</span> <span class="n">az_center</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">el2d</span> <span class="o">-</span> <span class="n">el_center</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">distance_max</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="c1">### We use a smoothed version of the map in order to avoid glitches</span>
    <span class="n">smoothed_flatmap</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">flatmap</span><span class="p">,</span> <span class="mf">2.</span><span class="p">)</span>
    <span class="n">wmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">smoothed_flatmap</span> <span class="o">*</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">smoothed_flatmap</span> <span class="o">*</span> <span class="n">mask</span><span class="p">))</span>
    <span class="n">maxval</span> <span class="o">=</span> <span class="n">flatmap</span><span class="p">[</span><span class="n">wmax</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># print(&#39;Maximum of map is {0:5.2g} and was found at: az={1:5.2f}, el={2:5.2f}&#39;.format(maxval,az2d[wmax][0], el2d[wmax][0]))</span>

    <span class="c1">### Get the fixed parameters</span>
    <span class="n">fixpars</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fixpars</span>

    <span class="c1">### Create range for the fitting around the initial values</span>
    <span class="n">ranges</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">ranges</span><span class="o">.</span><span class="n">T</span>

    <span class="c1">### Update initial parameters with the values found on the map</span>
    <span class="n">parsinit</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">startpars</span>
    <span class="n">parsinit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">az2d</span><span class="p">[</span><span class="n">wmax</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">parsinit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">el2d</span><span class="p">[</span><span class="n">wmax</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">parsinit</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxval</span>
    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;SbModelIndepPeaksAmp&#39;</span><span class="p">:</span>
        <span class="n">parsinit</span><span class="p">[</span><span class="mi">9</span><span class="p">:]</span> <span class="o">=</span> <span class="n">maxval</span>
        <span class="n">ranges</span><span class="p">[</span><span class="mi">9</span><span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxval</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;SbModelIndepPeaksAmpFWHM&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">npeaks</span><span class="p">):</span>
            <span class="n">parsinit</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxval</span>
            <span class="n">ranges</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxval</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;SbModelIndepPeaks&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">npeaks</span><span class="p">):</span>
            <span class="n">parsinit</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxval</span>
            <span class="n">ranges</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">maxval</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>

    <span class="c1">### Run the fitting</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">az2d</span><span class="p">,</span> <span class="n">el2d</span><span class="p">]</span>
    <span class="n">mm</span><span class="p">,</span> <span class="n">ss</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">meancut</span><span class="p">(</span><span class="n">flatmap</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running Minuit with model: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">model</span><span class="o">.</span><span class="n">print_start</span><span class="p">()</span>
    <span class="n">mychi2</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">MyChi2_nocov</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">flatmap</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">flatmap</span><span class="p">))</span> <span class="o">+</span> <span class="n">ss</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">do_minuit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">flatmap</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">flatmap</span><span class="p">))</span> <span class="o">+</span> <span class="n">ss</span><span class="p">,</span> <span class="n">parsinit</span><span class="p">,</span>
                       <span class="n">functname</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">chi2</span><span class="o">=</span><span class="n">mychi2</span><span class="p">,</span> <span class="n">rangepars</span><span class="o">=</span><span class="n">ranges</span><span class="p">,</span> <span class="n">fixpars</span><span class="o">=</span><span class="n">fixpars</span><span class="p">,</span>
                       <span class="n">force_chi2_ndf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nohesse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="n">precision</span><span class="p">)</span>
    <span class="n">fitpars</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">fiterrs</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1">### Get the peaks positions and amplitudes</span>
    <span class="n">themap</span><span class="p">,</span> <span class="n">newxxyy</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fitpars</span><span class="p">,</span> <span class="n">return_peaks</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">### Put the fitted amplitude values to zero when needed (when peak ouside the input image)</span>
    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;SbModelIndepPeaksAmp&#39;</span><span class="p">:</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">az2d</span><span class="p">)</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">az2d</span><span class="p">)</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">el2d</span><span class="p">)</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">el2d</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">npeaks</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(((</span><span class="n">newxxyy</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">xmin</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newxxyy</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">xmax</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">newxxyy</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ymin</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newxxyy</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ymax</span><span class="p">))):</span>
                <span class="n">fitpars</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">fiterrs</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1">### Now get the map again with updated parameters</span>
        <span class="n">themap</span><span class="p">,</span> <span class="n">newxxyy</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fitpars</span><span class="p">,</span> <span class="n">return_peaks</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;SbModelIndepPeaksAmpFWHM&#39;</span><span class="p">:</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">az2d</span><span class="p">)</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">az2d</span><span class="p">)</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">el2d</span><span class="p">)</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">el2d</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">npeaks</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(((</span><span class="n">newxxyy</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">xmin</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newxxyy</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">xmax</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">newxxyy</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ymin</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newxxyy</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ymax</span><span class="p">))):</span>
                <span class="n">fitpars</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">fiterrs</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1">### Now get the map again with updated parameters</span>
        <span class="n">themap</span><span class="p">,</span> <span class="n">newxxyy</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fitpars</span><span class="p">,</span> <span class="n">return_peaks</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;SbModelIndepPeaks&#39;</span><span class="p">:</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">az2d</span><span class="p">)</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">az2d</span><span class="p">)</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">el2d</span><span class="p">)</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">el2d</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">npeaks</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(((</span><span class="n">newxxyy</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">xmin</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newxxyy</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">xmax</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">newxxyy</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ymin</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newxxyy</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ymax</span><span class="p">))):</span>
                <span class="n">fitpars</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">fiterrs</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;===========================================================&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fitted values:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----------------------------------------------------------&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parsinit</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:&lt;20}</span><span class="s1">: </span><span class="si">{1:&gt;12.6f}</span><span class="s1"> +/- </span><span class="si">{2:&gt;12.6f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parnames</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fitpars</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fiterrs</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----------------------------------------------------------&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Residuals**2/pix : </span><span class="si">{0:^8.5g}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">flatmap</span> <span class="o">-</span> <span class="n">themap</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">flatmap</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;===========================================================&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">doplot</span><span class="p">:</span>
        <span class="n">rc</span><span class="p">(</span><span class="s1">&#39;figure&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">newxxyy</span><span class="p">)</span>
        <span class="n">mm</span><span class="p">,</span> <span class="n">ss</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">meancut</span><span class="p">(</span><span class="n">flatmap</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">imshow</span><span class="p">(</span><span class="n">themap</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">az</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">az</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">el</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">el</span><span class="p">)],</span>
               <span class="n">vmin</span><span class="o">=</span><span class="n">mm</span> <span class="o">-</span> <span class="n">ss</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">mm</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">ss</span><span class="p">)</span>
        <span class="n">colorbar</span><span class="p">()</span>
        <span class="n">title</span><span class="p">(</span><span class="s1">&#39;Fitted Map &#39;</span> <span class="o">+</span> <span class="n">extra_title</span><span class="p">)</span>
        <span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Angle in Az direction [deg.]&#39;</span><span class="p">)</span>
        <span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Elevation [deg.]&#39;</span><span class="p">)</span>

        <span class="n">mm</span><span class="p">,</span> <span class="n">ss</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">meancut</span><span class="p">(</span><span class="n">flatmap</span> <span class="o">-</span> <span class="n">themap</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">imshow</span><span class="p">(</span><span class="n">flatmap</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">az</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">az</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">el</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">el</span><span class="p">)],</span>
               <span class="n">vmin</span><span class="o">=</span><span class="n">mm</span> <span class="o">-</span> <span class="n">nsiglo</span> <span class="o">*</span> <span class="n">ss</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">mm</span> <span class="o">+</span> <span class="n">nsighi</span> <span class="o">*</span> <span class="n">ss</span><span class="p">)</span>
        <span class="n">xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">az</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">az</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">50</span><span class="p">)))</span>
        <span class="n">ylim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">el</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">el</span><span class="p">))</span>
        <span class="n">colorbar</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plot</span><span class="p">(</span><span class="n">newxxyy</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">newxxyy</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="s1">&#39;r.&#39;</span><span class="p">)</span>
        <span class="n">title</span><span class="p">(</span><span class="s1">&#39;Input Map &#39;</span> <span class="o">+</span> <span class="n">extra_title</span><span class="p">)</span>
        <span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Angle in Az direction [deg.]&#39;</span><span class="p">)</span>
        <span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Elevation [deg.]&#39;</span><span class="p">)</span>

        <span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">imshow</span><span class="p">(</span><span class="n">themap</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">az</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">az</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">el</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">el</span><span class="p">)],</span>
               <span class="n">vmin</span><span class="o">=</span><span class="n">mm</span> <span class="o">-</span> <span class="n">nsiglo</span> <span class="o">*</span> <span class="n">ss</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">mm</span> <span class="o">+</span> <span class="n">nsighi</span> <span class="o">*</span> <span class="n">ss</span><span class="p">)</span>
        <span class="n">colorbar</span><span class="p">()</span>
        <span class="n">title</span><span class="p">(</span><span class="s1">&#39;Fitted Map &#39;</span> <span class="o">+</span> <span class="n">extra_title</span><span class="p">)</span>
        <span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Angle in Az direction [deg.]&#39;</span><span class="p">)</span>
        <span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Elevation [deg.]&#39;</span><span class="p">)</span>

        <span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">imshow</span><span class="p">(</span><span class="n">flatmap</span> <span class="o">-</span> <span class="n">themap</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">az</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
                                         <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">az</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
                                         <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">el</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">el</span><span class="p">)],</span>
               <span class="n">vmin</span><span class="o">=</span><span class="n">mm</span> <span class="o">-</span> <span class="n">nsiglo</span> <span class="o">*</span> <span class="n">ss</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">mm</span> <span class="o">+</span> <span class="n">nsighi</span> <span class="o">*</span> <span class="n">ss</span><span class="p">)</span>
        <span class="n">colorbar</span><span class="p">()</span>
        <span class="n">title</span><span class="p">(</span><span class="s1">&#39;Residual Map &#39;</span> <span class="o">+</span> <span class="n">extra_title</span><span class="p">)</span>
        <span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Angle in Az direction [deg.]&#39;</span><span class="p">)</span>
        <span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Elevation [deg.]&#39;</span><span class="p">)</span>
        <span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">figsave</span><span class="p">:</span>
            <span class="n">savefig</span><span class="p">(</span><span class="n">figsave</span><span class="p">)</span>
        <span class="n">show</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">return_fitted</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fit</span><span class="p">,</span> <span class="n">newxxyy</span><span class="p">,</span> <span class="n">themap</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fit</span><span class="p">,</span> <span class="n">newxxyy</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, QUBIC Collaboration.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>