<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>qubic.selfcal_lib &mdash; Qubicsoft 5.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=ee801c84"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Qubicsoft
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Qubicsoft</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">qubic.selfcal_lib</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for qubic.selfcal_lib</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">healpy</span> <span class="k">as</span> <span class="nn">hp</span>

<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">RegularGridInterpolator</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">dblquad</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">sop</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>

<span class="kn">from</span> <span class="nn">qubicpack.pixel_translation</span> <span class="kn">import</span> <span class="n">tes2index</span><span class="p">,</span> <span class="n">make_id_focalplane</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Model_Fringes_QubicSoft&#39;</span><span class="p">,</span> <span class="s1">&#39;Model_Fringes_Maynooth&#39;</span><span class="p">]</span>


<span class="c1"># ========== Plot functions =============</span>
<span class="k">def</span> <span class="nf">plot_horns</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">simple</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

    <span class="n">xhorns</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="o">.</span><span class="n">center</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">yhorns</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="o">.</span><span class="n">center</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">simple</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xhorns</span><span class="p">,</span> <span class="n">yhorns</span><span class="p">,</span> <span class="s1">&#39;ko&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xhorns</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="o">.</span><span class="n">open</span><span class="p">)],</span> <span class="n">yhorns</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="o">.</span><span class="n">open</span><span class="p">)],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xhorns</span><span class="p">[</span><span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="o">.</span><span class="n">open</span><span class="p">],</span> <span class="n">yhorns</span><span class="p">[</span><span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="o">.</span><span class="n">open</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X_GRF [m]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y_GRF [m]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;square&#39;</span><span class="p">)</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">plot_baseline</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">hcenters</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="o">.</span><span class="n">center</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hcenters</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">hcenters</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">bs</span><span class="p">)</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">scatter_plot_FP</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">FP_signal</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">s</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;[W / Hz]&#39;</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make a scatter plot of the focal plane.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q: QubicInstrument()</span>
<span class="sd">    x: array</span>
<span class="sd">        X coordinates for the TES.</span>
<span class="sd">    y: array</span>
<span class="sd">        Y coordinates for the TES.</span>
<span class="sd">    FP_signal: array</span>
<span class="sd">        Signal to plot in 1D, should be ordered as x and y</span>
<span class="sd">    frame: str</span>
<span class="sd">        &#39;GRF&#39; or &#39;ONAFP&#39;, the frame used for x and y</span>
<span class="sd">    s: int</span>
<span class="sd">        Marker size on the plot</span>
<span class="sd">    title: str</span>
<span class="sd">        Plot title</span>
<span class="sd">    unit: str</span>
<span class="sd">        Unit of the signal to plot.</span>
<span class="sd">    kwargs: any kwarg for plt.scatter()</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">config</span> <span class="o">==</span> <span class="s1">&#39;TD&#39;</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="p">((</span><span class="n">fig</span><span class="o">.</span><span class="n">get_figwidth</span><span class="p">()</span> <span class="o">/</span> <span class="mi">35</span> <span class="o">*</span> <span class="n">fig</span><span class="o">.</span><span class="n">dpi</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="p">((</span><span class="n">fig</span><span class="o">.</span><span class="n">get_figwidth</span><span class="p">()</span> <span class="o">/</span> <span class="mi">70</span> <span class="o">*</span> <span class="n">fig</span><span class="o">.</span><span class="n">dpi</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">FP_signal</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cbar</span><span class="p">:</span>
        <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;5%&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="n">clb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>
        <span class="n">clb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;X_</span><span class="si">{</span><span class="n">frame</span><span class="si">}</span><span class="s1"> [m]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Y_</span><span class="si">{</span><span class="n">frame</span><span class="si">}</span><span class="s1"> [m]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;square&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">pcolor_plot_FP</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">FP_signal</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;[W / Hz]&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make a pcolor plot of the focal plane.</span>
<span class="sd">    !!! x, y, FP_signal must be ordered as defined in q.detector.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q: QubicInstrument()</span>
<span class="sd">    x: array</span>
<span class="sd">        X coordinates for the TES.</span>
<span class="sd">    y: array</span>
<span class="sd">        Y coordinates for the TES.</span>
<span class="sd">    FP_signal: array</span>
<span class="sd">        Signal to plot in 1D, should be ordered as x and y</span>
<span class="sd">    frame: str</span>
<span class="sd">        &#39;GRF&#39; or &#39;ONAFP&#39;, the frame used for x and y</span>
<span class="sd">    title: str</span>
<span class="sd">        Plot title</span>
<span class="sd">    unit: str</span>
<span class="sd">        Unit of the signal to plot.</span>
<span class="sd">    kwargs: any kwarg for plt.pcolor()</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

    <span class="n">x2D</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y2D</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">FP_signal2D</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">FP_signal</span><span class="p">)</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolor</span><span class="p">(</span><span class="n">x2D</span><span class="p">,</span> <span class="n">y2D</span><span class="p">,</span> <span class="n">FP_signal2D</span><span class="p">,</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cbar</span><span class="p">:</span>
        <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;5%&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="n">clb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>
        <span class="n">clb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;X_</span><span class="si">{</span><span class="n">frame</span><span class="si">}</span><span class="s1"> [m]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Y_</span><span class="si">{</span><span class="n">frame</span><span class="si">}</span><span class="s1"> [m]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;square&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">plot_horn_and_FP</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">FP_signal</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;[W / Hz]&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the horn array in GRF and a scatter plot of the focal plane in GRF or ONAFP.</span>
<span class="sd">    See scatter_plot_FP()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">axs</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="n">plot_horns</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax0</span><span class="p">)</span>
    <span class="n">scatter_plot_FP</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">FP_signal</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span>


<span class="k">def</span> <span class="nf">plot_BLs_eq</span><span class="p">(</span><span class="n">allBLs</span><span class="p">,</span> <span class="n">BLs_sort</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">simple</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the horn array and the observed baselines for each type (class of equivalence).</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    allBLs: list</span>
<span class="sd">        List containing all the baselines in the dataset.</span>
<span class="sd">    BLs_sort: list</span>
<span class="sd">        Indices of the baselines in the dataset for each type</span>
<span class="sd">    q: QubicInstrument</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nclass_eq</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">BLs_sort</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nclass_eq</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">axs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nclass_eq</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">dataset_eq</span> <span class="o">=</span> <span class="n">BLs_sort</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">plot_horns</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">simple</span><span class="o">=</span><span class="n">simple</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Type </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Type </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">dataset_eq</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  - </span><span class="si">{</span><span class="n">allBLs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">plot_baseline</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">allBLs</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="k">return</span>

<span class="c1"># ========== Tool functions =============</span>
<span class="k">def</span> <span class="nf">close_switches</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">switches</span><span class="p">):</span>
    <span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="o">.</span><span class="n">open</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
        <span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="o">.</span><span class="n">open</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">open_switches</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">switches</span><span class="p">):</span>
    <span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="o">.</span><span class="n">open</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
        <span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="o">.</span><span class="n">open</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">get_TEScoordinates_ONAFP</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get coordinates of the TES, x and y for the centers</span>
<span class="sd">    and the 4 corners (vertex) in the ONAFP frame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TES centers in the ONAFP frame</span>
    <span class="n">xGRF_TES</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">center</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">yGRF_TES</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">center</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">xONAFP_TES</span> <span class="o">=</span> <span class="o">-</span> <span class="n">yGRF_TES</span>
    <span class="n">yONAFP_TES</span> <span class="o">=</span> <span class="n">xGRF_TES</span>

    <span class="c1"># TES vertex in the ONAFP frame</span>
    <span class="n">vGRF_TES</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">vertex</span>
    <span class="n">vONAFP_TES</span> <span class="o">=</span> <span class="n">vGRF_TES</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>
    <span class="n">vONAFP_TES</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">xONAFP_TES</span><span class="p">,</span> <span class="n">yONAFP_TES</span><span class="p">,</span> <span class="n">vONAFP_TES</span>

<span class="k">def</span> <span class="nf">get_horn_coordinates_ONAFP</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get coordinates of the horn center (x, y, z),</span>
<span class="sd">    in the ONAFP frame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Horn centers in the ONAFP frame</span>
    <span class="n">center_GRF</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="o">.</span><span class="n">center</span>
    <span class="n">center_ONAFP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">center_GRF</span><span class="p">)</span>
    <span class="n">center_ONAFP</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">center_GRF</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="c1"># xONAFP = -yGRF</span>
    <span class="n">center_ONAFP</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">center_GRF</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>   <span class="c1"># yONAFP = xGRF</span>
    <span class="n">center_ONAFP</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">center_GRF</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>   <span class="c1"># zONAFP = zGRF</span>

    <span class="k">return</span> <span class="n">center_ONAFP</span>


<span class="k">def</span> <span class="nf">TES_Instru2coord</span><span class="p">(</span><span class="n">TES</span><span class="p">,</span> <span class="n">ASIC</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;ONAFP&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    From (TES, ASIC) numbering on the instrument to (x,y) coordinates in ONAFP or GRF frame.</span>
<span class="sd">    Returns also the focal plane index.</span>
<span class="sd">    !!! If q is a TD instrument, only ASIC 1 and 2 are acceptable.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    TES: TES number as defined on the instrument</span>
<span class="sd">    ASIC: ASIC number</span>
<span class="sd">    q: QubicInstrument()</span>
<span class="sd">    frame: str</span>
<span class="sd">        &#39;GRF&#39; or &#39;ONAFP&#39; only</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    x, y: TES center coordinates.</span>
<span class="sd">    FP_index: Focal Plane index, as used in Qubic soft.</span>
<span class="sd">    index_q: position index of the FP_index in q.detector.index()</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">TES</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">100</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;This is a thermometer !&#39;</span><span class="p">)</span>
    <span class="n">FP_index</span> <span class="o">=</span> <span class="n">tes2index</span><span class="p">(</span><span class="n">TES</span><span class="p">,</span> <span class="n">ASIC</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FP_index =&#39;</span><span class="p">,</span> <span class="n">FP_index</span><span class="p">)</span>

    <span class="n">index_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">FP_index</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Index_q =&#39;</span><span class="p">,</span> <span class="n">index_q</span><span class="p">)</span>

    <span class="n">centerGRF</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">center</span><span class="p">[</span><span class="n">q</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">FP_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">xGRF</span> <span class="o">=</span> <span class="n">centerGRF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">yGRF</span> <span class="o">=</span> <span class="n">centerGRF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">frame</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;GRF&#39;</span><span class="p">,</span> <span class="s1">&#39;ONAFP&#39;</span><span class="p">]:</span>
         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The frame is not valid.&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">frame</span> <span class="o">==</span> <span class="s1">&#39;GRF&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;X_GRF = </span><span class="si">{:.3f}</span><span class="s1"> mm, Y_GRF = </span><span class="si">{:.3f}</span><span class="s1"> mm&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xGRF</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">yGRF</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">xGRF</span><span class="p">,</span> <span class="n">yGRF</span><span class="p">,</span> <span class="n">FP_index</span><span class="p">,</span> <span class="n">index_q</span>
    <span class="k">elif</span> <span class="n">frame</span> <span class="o">==</span> <span class="s1">&#39;ONAFP&#39;</span><span class="p">:</span>
        <span class="n">xONAFP</span> <span class="o">=</span> <span class="o">-</span> <span class="n">yGRF</span>
        <span class="n">yONAFP</span> <span class="o">=</span> <span class="n">xGRF</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;X_ONAFP = </span><span class="si">{:.3f}</span><span class="s1"> mm, Y_ONAFP = </span><span class="si">{:.3f}</span><span class="s1"> mm&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xONAFP</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">yONAFP</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">xONAFP</span><span class="p">,</span> <span class="n">yONAFP</span><span class="p">,</span> <span class="n">FP_index</span><span class="p">,</span> <span class="n">index_q</span>


<span class="k">def</span> <span class="nf">get_TES_Instru_coords</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;ONAFP&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Same as TES_Instru2coord() but loop on all TES.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">thermos</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">config</span> <span class="o">==</span> <span class="s1">&#39;TD&#39;</span><span class="p">:</span>
        <span class="n">nASICS</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nASICS</span> <span class="o">=</span> <span class="mi">8</span>

    <span class="n">nTES</span> <span class="o">=</span> <span class="n">nASICS</span> <span class="o">*</span> <span class="mi">128</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nTES</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nTES</span><span class="p">)</span>
    <span class="n">FP_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nTES</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">index_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nTES</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ASIC</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nASICS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">TES</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">129</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> ASIC </span><span class="si">{</span><span class="n">ASIC</span><span class="si">}</span><span class="s1"> - TES </span><span class="si">{</span><span class="n">TES</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">TES</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">thermos</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">TES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">128</span> <span class="o">*</span> <span class="p">(</span><span class="n">ASIC</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">FP_index</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">index_q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span> <span class="n">TES_Instru2coord</span><span class="p">(</span><span class="n">TES</span><span class="p">,</span> <span class="n">ASIC</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">frame</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Thermometer !&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">FP_index</span><span class="p">,</span> <span class="n">index_q</span>


<span class="k">def</span> <span class="nf">index2tes</span><span class="p">(</span><span class="n">FPindex</span><span class="p">,</span> <span class="n">FPidentity</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return ASIC and TES numbers (instrument numbering)</span>
<span class="sd">    from the FPindex coming from q.detector.index&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">FPidentity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">FPidentity</span> <span class="o">=</span> <span class="n">make_id_focalplane</span><span class="p">()</span>
    <span class="n">TES</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">FPidentity</span><span class="o">.</span><span class="n">TES</span><span class="p">[</span><span class="n">FPidentity</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">FPindex</span><span class="p">])</span>
    <span class="n">ASIC</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">FPidentity</span><span class="o">.</span><span class="n">ASIC</span><span class="p">[</span><span class="n">FPidentity</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">FPindex</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">ASIC</span><span class="p">,</span> <span class="n">TES</span>


<span class="k">def</span> <span class="nf">get_all_tes_numbers</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a 2D array with ASIC and TES numbers ordered as in Qubic soft.&quot;&quot;&quot;</span>
    <span class="n">FPidentity</span> <span class="o">=</span> <span class="n">make_id_focalplane</span><span class="p">()</span>
    <span class="n">ndet</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ndet</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndet</span><span class="p">):</span>
        <span class="n">FPindex</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">tes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">tes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">index2tes</span><span class="p">(</span><span class="n">FPindex</span><span class="p">,</span> <span class="n">FPidentity</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tes</span>


<span class="k">def</span> <span class="nf">get_TESvertices_FromMaynoothFiles</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="n">ndet</span><span class="o">=</span><span class="mi">992</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get TES vertices coordinates from Maynooth files.</span>
<span class="sd">    Not very useful because `q.detector.vertex` gives the same.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rep : str</span>
<span class="sd">        Path of the repository for the simulated files, can be download at :</span>
<span class="sd">        https://drive.google.com/open?id=19dPHw_CeuFZ068b-VRT7N-LWzOL1fmfG</span>
<span class="sd">    ndet : int</span>
<span class="sd">        Number of TES.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get a 2D array from the file</span>
    <span class="n">vertices2D</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">rep</span> <span class="o">+</span> <span class="s1">&#39;/vertices.txt&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;\ &#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>

    <span class="c1"># Make a 3D array of shape (992, 4, 2)</span>
    <span class="n">vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ndet</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">vertices</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">vertices2D</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="mi">4</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">vertices</span>


<span class="k">def</span> <span class="nf">make_position</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">reso</span><span class="p">,</span> <span class="n">focal_length</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Position on the focal plane in the GRF frame.&quot;&quot;&quot;</span>
    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">reso</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">reso</span><span class="p">))</span>
    <span class="n">x1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
    <span class="n">y1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>
    <span class="n">z1d</span> <span class="o">=</span> <span class="n">x1d</span> <span class="o">*</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">focal_length</span>
    <span class="n">position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x1d</span><span class="p">,</span> <span class="n">y1d</span><span class="p">,</span> <span class="n">z1d</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="k">return</span> <span class="n">position</span>


<span class="k">def</span> <span class="nf">give_bs_pars</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;GRF&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find orientation angle and length for a baseline.&quot;&quot;&quot;</span>

    <span class="c1"># X, Y coordinates of the 2 horns in GRF or ONAFP.</span>
    <span class="k">if</span> <span class="n">frame</span> <span class="o">==</span> <span class="s1">&#39;ONAFP&#39;</span><span class="p">:</span>
        <span class="n">hc</span> <span class="o">=</span> <span class="n">get_horn_coordinates_ONAFP</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="n">hc</span> <span class="o">=</span> <span class="n">hc</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">frame</span> <span class="o">==</span> <span class="s1">&#39;GRF&#39;</span><span class="p">:</span>
        <span class="n">hc</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="o">.</span><span class="n">center</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">hc0</span> <span class="o">=</span> <span class="n">hc</span><span class="p">[</span><span class="n">bs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">hc1</span> <span class="o">=</span> <span class="n">hc</span><span class="p">[</span><span class="n">bs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

    <span class="n">bsxy</span> <span class="o">=</span> <span class="n">hc1</span> <span class="o">-</span> <span class="n">hc0</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">bsxy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bsxy</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bsxy</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">xycenter</span> <span class="o">=</span> <span class="p">(</span><span class="n">hc0</span> <span class="o">+</span> <span class="n">hc1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="k">return</span> <span class="n">theta</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">xycenter</span>


<span class="k">def</span> <span class="nf">check_equiv</span><span class="p">(</span><span class="n">vecbs1</span><span class="p">,</span> <span class="n">vecbs2</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if 2 baselines are equivalent.&quot;&quot;&quot;</span>
    <span class="n">norm1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vecbs1</span><span class="p">,</span> <span class="n">vecbs1</span><span class="p">)</span>
    <span class="n">norm2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vecbs2</span><span class="p">,</span> <span class="n">vecbs2</span><span class="p">)</span>
    <span class="n">cross12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">vecbs1</span><span class="p">,</span> <span class="n">vecbs2</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">norm1</span> <span class="o">-</span> <span class="n">norm2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cross12</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">find_equivalent_baselines</span><span class="p">(</span><span class="n">all_bs</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the equivalent baselines in a list.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    all_bs: list</span>
<span class="sd">        List of baselines.</span>
<span class="sd">    q: QubicInstrument</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    BLs_sort: List with baseline indices sorted according to equivalence.</span>
<span class="sd">        ex: BLs_sort = [[1, 3], [0, 2, 4]] means that you have 2 different classes</span>
<span class="sd">        of equivalence with 2 and 3 baselines respectively.</span>
<span class="sd">    all_eqtype: List of integers with the type of each baseline.</span>
<span class="sd">        ex: In the example above, you have 2 types (0 or 1)</span>
<span class="sd">        so you will get all_eqtype = [1, 0, 1, 0, 1]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">### Convert to array</span>
    <span class="n">all_bs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_bs</span><span class="p">)</span>
    <span class="c1">### centers</span>
    <span class="n">hcenters</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="o">.</span><span class="n">center</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="c1">### Baselines vectors</span>
    <span class="n">all_vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">all_bs</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_bs</span><span class="p">)):</span>
        <span class="n">coordsA</span> <span class="o">=</span> <span class="n">hcenters</span><span class="p">[</span><span class="n">all_bs</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">coordsB</span> <span class="o">=</span> <span class="n">hcenters</span><span class="p">[</span><span class="n">all_bs</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">all_vecs</span><span class="p">[</span><span class="n">ib</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">coordsB</span> <span class="o">-</span> <span class="n">coordsA</span>

    <span class="c1">### List of types of equivalence for each baseline: initially = -1</span>
    <span class="n">all_eqtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_bs</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="c1">### First type is zero and is associated to first baseline</span>
    <span class="n">eqnum</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">all_eqtype</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">eqnum</span>

    <span class="c1">### Indices of baselines</span>
    <span class="n">index_bs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_bs</span><span class="p">))</span>

    <span class="c1">### Loop over baselines</span>
    <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_bs</span><span class="p">)):</span>
        <span class="c1">### Identify those that have no type</span>
        <span class="n">wnotype</span> <span class="o">=</span> <span class="n">all_eqtype</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">bsnotype</span> <span class="o">=</span> <span class="n">all_bs</span><span class="p">[</span><span class="n">wnotype</span><span class="p">]</span>
        <span class="n">vecsnotype</span> <span class="o">=</span> <span class="n">all_vecs</span><span class="p">[</span><span class="n">wnotype</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">indexnotype</span> <span class="o">=</span> <span class="n">index_bs</span><span class="p">[</span><span class="n">wnotype</span><span class="p">]</span>
        <span class="c1">### Loop over those with no type</span>
        <span class="k">for</span> <span class="n">jb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bsnotype</span><span class="p">)):</span>
            <span class="c1">### Check if equivalent</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">check_equiv</span><span class="p">(</span><span class="n">all_vecs</span><span class="p">[</span><span class="n">ib</span><span class="p">,</span> <span class="p">:],</span> <span class="n">vecsnotype</span><span class="p">[</span><span class="n">jb</span><span class="p">,</span> <span class="p">:])</span>
            <span class="c1">### If so: give it the current type</span>
            <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                <span class="n">all_eqtype</span><span class="p">[</span><span class="n">indexnotype</span><span class="p">[</span><span class="n">jb</span><span class="p">]]</span> <span class="o">=</span> <span class="n">eqnum</span>
        <span class="c1">### We have gone through all possibilities for this type so we increment the type by 1</span>
        <span class="n">eqnum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">all_eqtype</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">alltypes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">all_eqtype</span><span class="p">)</span>
    <span class="n">BLs_sort</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alltypes</span><span class="p">)):</span>
        <span class="n">BLs_sort</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_bs</span><span class="p">[</span><span class="n">all_eqtype</span> <span class="o">==</span> <span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">BLs_sort</span><span class="p">,</span> <span class="n">all_eqtype</span>


<span class="c1"># ========== Compute power on the focal plane =============</span>
<span class="k">def</span> <span class="nf">make_external_A</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="n">open_horns</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute external_A from simulated files with aberrations.</span>
<span class="sd">    This can be used in get_response_power method that returns the synthetic beam on the sky</span>
<span class="sd">    or in get_response() to have the signal on the focal plane.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rep : str</span>
<span class="sd">        Path of the repository for the simulated files, can be download at :</span>
<span class="sd">        https://drive.google.com/open?id=19dPHw_CeuFZ068b-VRT7N-LWzOL1fmfG</span>
<span class="sd">    open_horns : list</span>
<span class="sd">        Indices of the open horns between 1 and 64.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    external_A : list of tables describing the phase and amplitude at each point of the focal</span>
<span class="sd">            plane for each of the horns:</span>
<span class="sd">            [0] : array, X coordinates with shape (n) in GRF [m]</span>
<span class="sd">            [1] : array, Y coordinates with shape (n) in GRF [m]</span>
<span class="sd">            [2] : array, amplitude on X with shape (n, nhorns)</span>
<span class="sd">            [3] : array, amplitude on Y with shape (n, nhorns)</span>
<span class="sd">            [4] : array, phase on X with shape (n, nhorns) [rad]</span>
<span class="sd">            [5] : array, phase on Y with shape (n, nhorns) [rad]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get simulation files</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">rep</span> <span class="o">+</span> <span class="s1">&#39;/*.dat&#39;</span><span class="p">))</span>

    <span class="n">nhorns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nhorns</span> <span class="o">!=</span> <span class="mi">64</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You should have 64 .dat files&#39;</span><span class="p">)</span>

    <span class="c1"># This is done to get the right file for each horn</span>
    <span class="n">horn_transpose</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
    <span class="n">horn_transpose</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">horn_transpose</span><span class="p">,</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">horn_transpose</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">horn_transpose</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="c1"># Get the sample number from the first file</span>
    <span class="n">data0</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">nn</span> <span class="o">=</span> <span class="p">(</span><span class="n">data0</span><span class="p">[</span><span class="s1">&#39;X_Index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sampling number = &#39;</span><span class="p">,</span> <span class="n">nn</span><span class="p">)</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data0</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="c1"># X and Y positions in the GRF frame</span>
    <span class="n">xONAFP</span> <span class="o">=</span> <span class="n">data0</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span>
    <span class="n">yONAFP</span> <span class="o">=</span> <span class="n">data0</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span>
    <span class="n">xGRF</span> <span class="o">=</span> <span class="n">yONAFP</span>
    <span class="n">yGRF</span> <span class="o">=</span> <span class="o">-</span> <span class="n">xONAFP</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">xGRF</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># Get all amplitudes and phases for each open horn</span>
    <span class="n">nopen_horns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">open_horns</span><span class="p">)</span>

    <span class="n">allampX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">nopen_horns</span><span class="p">))</span>
    <span class="n">allphiX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">nopen_horns</span><span class="p">))</span>
    <span class="n">allampY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">nopen_horns</span><span class="p">))</span>
    <span class="n">allphiY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">nopen_horns</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">allphiY</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">swi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">open_horns</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;horn &#39;</span><span class="p">,</span> <span class="n">swi</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">swi</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">swi</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The horn indices must be between 1 and 64 &#39;</span><span class="p">)</span>

        <span class="n">thefile</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="n">horn_transpose</span><span class="p">[</span><span class="n">swi</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Horn &#39;</span><span class="p">,</span> <span class="n">swi</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="n">thefile</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">thefile</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;MagX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">allampX</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;MagX&#39;</span><span class="p">]</span>
        <span class="n">allampY</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;MagX&#39;</span><span class="p">]</span>

        <span class="n">allphiX</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;PhaseX&#39;</span><span class="p">]</span>
        <span class="n">allphiY</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;PhaseY&#39;</span><span class="p">]</span>

    <span class="n">external_A</span> <span class="o">=</span> <span class="p">[</span><span class="n">xGRF</span><span class="p">,</span> <span class="n">yGRF</span><span class="p">,</span> <span class="n">allampX</span><span class="p">,</span> <span class="n">allampY</span><span class="p">,</span> <span class="n">allphiX</span><span class="p">,</span> <span class="n">allphiY</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">external_A</span>


<span class="k">def</span> <span class="nf">get_response_power</span><span class="p">(</span><span class="n">q</span><span class="p">,</span>
                       <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">spectral_irradiance</span><span class="p">,</span>
                       <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;ONAFP&#39;</span><span class="p">,</span> <span class="n">external_A</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hwp_position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                       <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute power on the focal plane in the ONAFP frame for one position of the source</span>
<span class="sd">    with respect to the instrument.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q: a qubic monochromatic instrument</span>
<span class="sd">    theta: float</span>
<span class="sd">        The source zenith angle [rad].</span>
<span class="sd">    phi: float</span>
<span class="sd">        The source azimuthal angle [rad].</span>
<span class="sd">    nu: float</span>
<span class="sd">        Source frequency in Hz.</span>
<span class="sd">    spectral_irradiance : array-like</span>
<span class="sd">        The source spectral_irradiance [W/m^2/Hz].</span>
<span class="sd">    frame: str</span>
<span class="sd">        Referential frame you want to use: &#39;GRF&#39; or &#39;ONAFP&#39;</span>
<span class="sd">    external_A: list of tables describing the phase and amplitude at</span>
<span class="sd">    each point of the focal plane for each of the horns, see make_external_A()</span>
<span class="sd">    hwp_position : int</span>
<span class="sd">        HWP position from 0 to 7.</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    x, y: 1D arrays with the coordinates on the focal plane in GRF or ONAFP.</span>
<span class="sd">    power: array with the power on the focal plane for each posiion (x, y) and each pointing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">frame</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;GRF&#39;</span><span class="p">,</span> <span class="s1">&#39;ONAFP&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The frame is not valid. It must be GRF or ONAFP.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">external_A</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">center</span>  <span class="c1"># GRF</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x1d</span> <span class="o">=</span> <span class="n">external_A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y1d</span> <span class="o">=</span> <span class="n">external_A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">z1d</span> <span class="o">=</span> <span class="n">x1d</span> <span class="o">*</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">q</span><span class="o">.</span><span class="n">optics</span><span class="o">.</span><span class="n">focal_length</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x1d</span><span class="p">,</span> <span class="n">y1d</span><span class="p">,</span> <span class="n">z1d</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">xGRF</span> <span class="o">=</span> <span class="n">position</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">yGRF</span> <span class="o">=</span> <span class="n">position</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Electric field on the FP in the GRF frame</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">_get_response</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">spectral_irradiance</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">area</span><span class="p">,</span>
                        <span class="n">nu</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">primary_beam</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">secondary_beam</span><span class="p">,</span>
                        <span class="n">external_A</span><span class="o">=</span><span class="n">external_A</span><span class="p">,</span> <span class="n">hwp_position</span><span class="o">=</span><span class="n">hwp_position</span><span class="p">)</span>
    <span class="n">power</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">E</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="c1"># power *= q.filter.bandwidth  # [W/Hz] to [W]</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Detector centers shape:&#39;</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">center</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Power shape:&#39;</span><span class="p">,</span> <span class="n">power</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;X_GRF shape:&#39;</span><span class="p">,</span> <span class="n">xGRF</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">frame</span> <span class="o">==</span> <span class="s1">&#39;GRF&#39;</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">xGRF</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">yGRF</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Make a pi/2 rotation from GRF -&gt; ONAFP referential frame</span>
        <span class="n">xONAFP</span> <span class="o">=</span> <span class="o">-</span> <span class="n">yGRF</span>
        <span class="n">yONAFP</span> <span class="o">=</span> <span class="n">xGRF</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">xONAFP</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">yONAFP</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">power</span>


<span class="k">def</span> <span class="nf">get_power_Maynooth</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="n">open_horns</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">horn_center</span><span class="p">,</span> <span class="n">hwp_position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get power on the focal plane from Maynooth simulations.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rep: str</span>
<span class="sd">        Repository with the simulation files.</span>
<span class="sd">    open_horns: list</span>
<span class="sd">        List of open horns.</span>
<span class="sd">    theta: float</span>
<span class="sd">        The source zenith angle [rad].</span>
<span class="sd">    nu: float</span>
<span class="sd">        Frequency of the calibration source [Hz]</span>
<span class="sd">    horn_center: array</span>
<span class="sd">        Coordinates of the horns.</span>
<span class="sd">    hwp_position: int</span>
<span class="sd">        HWP position from 0 to 7.</span>
<span class="sd">    verbose: bool</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    (x, y) coordinates on the focal plane in the ONAFP frame and the power at each coordinate.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get simulation files</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">rep</span> <span class="o">+</span> <span class="s1">&#39;/*.dat&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">64</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You should have 64 .dat files&#39;</span><span class="p">)</span>

    <span class="n">nhorns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">open_horns</span><span class="p">)</span>
    <span class="c1"># Get the sample number from the first file and the coordinates X, Y</span>
    <span class="n">data0</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">nn</span> <span class="o">=</span> <span class="n">data0</span><span class="p">[</span><span class="s1">&#39;X_Index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">xONAFP</span> <span class="o">=</span> <span class="n">data0</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span>  <span class="c1"># convert from mm to m</span>
    <span class="n">yONAFP</span> <span class="o">=</span> <span class="n">data0</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;# open horns = </span><span class="si">{</span><span class="n">nhorns</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sampling number = </span><span class="si">{</span><span class="n">nn</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of lines = </span><span class="si">{</span><span class="n">nn</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mi">2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># This is done to get the right file for each horn</span>
    <span class="n">horn_transpose</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
    <span class="n">horn_transpose</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">horn_transpose</span><span class="p">,</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">horn_transpose</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">horn_transpose</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="n">Ax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nhorns</span><span class="p">,</span> <span class="n">nn</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">Ay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Ax</span><span class="p">)</span>
    <span class="n">Phasex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Ax</span><span class="p">)</span>
    <span class="n">Phasey</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Ax</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">swi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">open_horns</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">swi</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">swi</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The switch indices must be between 1 and 64 &#39;</span><span class="p">)</span>

        <span class="n">thefile</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="n">horn_transpose</span><span class="p">[</span><span class="n">swi</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Horn &#39;</span><span class="p">,</span> <span class="n">swi</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="n">thefile</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">thefile</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Phase calculation</span>
        <span class="n">horn_x</span> <span class="o">=</span> <span class="n">horn_center</span><span class="p">[</span><span class="n">swi</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">horn_y</span> <span class="o">=</span> <span class="n">horn_center</span><span class="p">[</span><span class="n">swi</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">horn_x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">horn_y</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># distance between the horn and the center</span>
        <span class="n">additional_phase</span> <span class="o">=</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">3e8</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">*</span> <span class="n">dist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>

        <span class="n">Ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;MagX&#39;</span><span class="p">]</span>
        <span class="n">Ay</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;MagY&#39;</span><span class="p">]</span>

        <span class="n">Phasex</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;PhaseX&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">additional_phase</span>
        <span class="n">Phasey</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;PhaseY&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">additional_phase</span>

    <span class="c1"># Electric field for each open horn</span>
    <span class="n">Ex</span> <span class="o">=</span> <span class="n">Ax</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Phasex</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Phasex</span><span class="p">))</span>
    <span class="n">Ey</span> <span class="o">=</span> <span class="n">Ay</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Phasey</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Phasey</span><span class="p">))</span>

    <span class="c1"># Sum of the electric fields</span>
    <span class="n">sumEx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Ex</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">sumEy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Ey</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># HWP modulation</span>
    <span class="n">phi_hwp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">16</span>
    <span class="n">sumEx</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">phi_hwp</span><span class="p">[</span><span class="n">hwp_position</span><span class="p">])</span>
    <span class="n">sumEy</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">phi_hwp</span><span class="p">[</span><span class="n">hwp_position</span><span class="p">])</span>

    <span class="c1"># Power on the focal plane</span>
    <span class="c1"># power = np.abs(sumEx) ** 2 + np.abs(sumEy) ** 2</span>
    <span class="n">power</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sumEx</span> <span class="o">+</span> <span class="n">sumEy</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="k">return</span> <span class="n">xONAFP</span><span class="p">,</span> <span class="n">yONAFP</span><span class="p">,</span> <span class="n">power</span>


<span class="k">def</span> <span class="nf">fullreso2TESreso</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">power</span><span class="p">,</span> <span class="n">TESvertex</span><span class="p">,</span> <span class="n">TESarea</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decrease the resolution to have the power in each TES.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x, y: array</span>
<span class="sd">        Coordinates on the FP</span>
<span class="sd">    power: array</span>
<span class="sd">        Power on the FP.</span>
<span class="sd">    TESvertex: array</span>
<span class="sd">        Coordinates of the 4 corners of each TES.</span>
<span class="sd">    TESarea: float</span>
<span class="sd">        Area of the detectors [m]</span>
<span class="sd">    interp: bool</span>
<span class="sd">        If True, interpolate and integrate in each TES (takes time).</span>
<span class="sd">        If False, make the mean in each TES (faster).</span>
<span class="sd">    verbose: bool</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    The power in each TES.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ndet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">TESvertex</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">powerTES</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ndet</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ndet:&#39;</span><span class="p">,</span> <span class="n">ndet</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">interp</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;********** Begin interpolation **********&#39;</span><span class="p">)</span>
        <span class="n">reso</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reso:&#39;</span><span class="p">,</span> <span class="n">reso</span><span class="p">)</span>
        <span class="n">power_interp</span> <span class="o">=</span> <span class="n">RegularGridInterpolator</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                                                <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span>
                                               <span class="n">power</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">reso</span><span class="p">,</span> <span class="n">reso</span><span class="p">)),</span>
                                               <span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                                               <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                               <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
        <span class="n">power_interp_function</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">power_interp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;********** Begin integration in the TES era **********&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">TES</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndet</span><span class="p">):</span>
            <span class="c1"># Boundaries for the integral</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">TESvertex</span><span class="p">[</span><span class="n">TES</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">TESvertex</span><span class="p">[</span><span class="n">TES</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">TESvertex</span><span class="p">[</span><span class="n">TES</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">y2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">TESvertex</span><span class="p">[</span><span class="n">TES</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">gfun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">y1</span>
            <span class="n">hfun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">y2</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">xTES</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">yTES</span> <span class="o">=</span> <span class="p">(</span><span class="n">y1</span> <span class="o">+</span> <span class="n">y2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Power at the TES center:&#39;</span><span class="p">,</span> <span class="n">power_interp_function</span><span class="p">(</span><span class="n">xTES</span><span class="p">,</span> <span class="n">yTES</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;x boundaries: </span><span class="si">{:.2f}</span><span class="s1"> to </span><span class="si">{:.2f}</span><span class="s1"> mm&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x1</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">x2</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Delta x = </span><span class="si">{:.2f}</span><span class="s1"> mm&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;y boundaries: </span><span class="si">{:.2f}</span><span class="s1"> to </span><span class="si">{:.2f}</span><span class="s1"> mm&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y1</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">y2</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Delta y = </span><span class="si">{:.2f}</span><span class="s1"> mm&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">))</span>

            <span class="n">power</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">dblquad</span><span class="p">(</span><span class="n">power_interp_function</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">gfun</span><span class="p">,</span> <span class="n">hfun</span><span class="p">)</span>
            <span class="n">powerTES</span><span class="p">[</span><span class="n">TES</span><span class="p">]</span> <span class="o">=</span> <span class="n">power</span>

        <span class="n">powerTES</span> <span class="o">/=</span> <span class="n">TESarea</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">TES</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndet</span><span class="p">):</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">TESvertex</span><span class="p">[</span><span class="n">TES</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">TESvertex</span><span class="p">[</span><span class="n">TES</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">TESvertex</span><span class="p">[</span><span class="n">TES</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">y2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">TESvertex</span><span class="p">[</span><span class="n">TES</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">])</span>

            <span class="n">insideTEScondition</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">x1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">x2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;=</span> <span class="n">y1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">y2</span><span class="p">))</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">insideTEScondition</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">powerTES</span><span class="p">[</span><span class="n">TES</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">power</span><span class="p">[</span><span class="n">indices</span><span class="p">])</span>
            <span class="n">powerTES</span><span class="p">[</span><span class="n">TES</span><span class="p">]</span> <span class="o">/=</span> <span class="n">count</span>

    <span class="k">return</span> <span class="n">powerTES</span>


<span class="c1"># ========== Chi2 to fit the fringes =========</span>
<span class="k">def</span> <span class="nf">make_inverse_covariance</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">Cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">errors</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">Cov</span><span class="p">)</span>

    <span class="n">InvCov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Cov</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">InvCov</span>


<span class="k">def</span> <span class="nf">get_gains</span><span class="p">(</span><span class="n">allPowerPhi</span><span class="p">,</span> <span class="n">allInvCov</span><span class="p">,</span> <span class="n">allData</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute a gain for each detector analytically.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    allPowerPhi: list</span>
<span class="sd">        List with fringes models Phi multiply by a global power P.</span>
<span class="sd">    allInvCov: list</span>
<span class="sd">        List with the inverse covariance matrices, one for each image.</span>
<span class="sd">    allData: list</span>
<span class="sd">        List with the fringe images.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Gains A and their covariance matrix Cov_A, normalized such as &lt;A&gt; = 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Number of fringe images</span>
    <span class="n">nimages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">allPowerPhi</span><span class="p">)</span>

    <span class="n">InvCov_A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">allInvCov</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">Term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">allData</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nimages</span><span class="p">):</span>
        <span class="c1"># Make a diagonal matrix</span>
        <span class="n">PowerPhi_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">allPowerPhi</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="n">InvCov_A</span> <span class="o">+=</span> <span class="n">PowerPhi_mat</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">allInvCov</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">@</span> <span class="n">PowerPhi_mat</span>
        <span class="n">Term</span> <span class="o">+=</span> <span class="n">PowerPhi_mat</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">allInvCov</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">@</span> <span class="n">allData</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="n">Cov_A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">InvCov_A</span><span class="p">)</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">Cov_A</span> <span class="o">@</span> <span class="n">Term</span>

    <span class="c1"># Normalization</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Cov_A</span><span class="p">)</span> <span class="c1"># To cancel bad detectors</span>
    <span class="n">avgA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span> <span class="c1"># Weighted mean</span>
    <span class="n">A</span> <span class="o">/=</span> <span class="n">avgA</span>
    <span class="n">Cov_A</span> <span class="o">/=</span> <span class="n">avgA</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="k">return</span> <span class="n">A</span><span class="p">,</span> <span class="n">Cov_A</span>

<span class="k">def</span> <span class="nf">get_chi2</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">allInvCov</span><span class="p">,</span> <span class="n">allData</span><span class="p">,</span> <span class="n">BLs</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">nu_source</span><span class="o">=</span><span class="mf">150e9</span><span class="p">,</span> <span class="n">returnA</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the Chi^2 for a list of fringe images (several baselines) and a model M.</span>
<span class="sd">    M_k = P_k Phi_k(focal, source angle) @ A</span>
<span class="sd">    where k is the image index, P_k a global power, Phi_k the fringes model given by Model_Fringes_Ana</span>
<span class="sd">    and A contains the gains of the detectors.</span>
<span class="sd">    For now, we use the analytical model but it could be adapted to a more complex model (QubicSoft or Maynooth).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    params: list</span>
<span class="sd">        Focal length, source off-axis angle, log_10 of global powers P_k</span>
<span class="sd">    allInvCov: list</span>
<span class="sd">        List with the inverse covariance matrices, one for each image.</span>
<span class="sd">    allData: list</span>
<span class="sd">        List with the fringe images.</span>
<span class="sd">    BLs: list</span>
<span class="sd">        List of the baselines, for example [25, 57] is one baseline.</span>
<span class="sd">    q: a Qubic instrument</span>
<span class="sd">    nu_source: float</span>
<span class="sd">        Frequency of the calibration source</span>
<span class="sd">    returnA: bool</span>
<span class="sd">        If True, it will return the detector gains and their covariance.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    The Chi^2.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">nimages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">BLs</span><span class="p">)</span>
    <span class="n">focal</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">theta_source</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">logP</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">q</span><span class="o">.</span><span class="n">optics</span><span class="o">.</span><span class="n">focal_length</span> <span class="o">=</span> <span class="n">focal</span>
    <span class="n">allPowerPhi</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nimages</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Model_Fringes_Ana</span><span class="p">(</span><span class="n">q</span><span class="p">,</span>
                                  <span class="n">BLs</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                                  <span class="n">theta_source</span><span class="o">=</span><span class="n">theta_source</span><span class="p">,</span>
                                  <span class="n">nu_source</span><span class="o">=</span><span class="n">nu_source</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">Phi</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_fringes</span><span class="p">(</span><span class="n">times_gaussian</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Global amplitude</span>
        <span class="n">allPowerPhi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Phi</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">logP</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

    <span class="c1"># Gain for each detector</span>
    <span class="n">A</span><span class="p">,</span> <span class="n">Cov_A</span> <span class="o">=</span> <span class="n">get_gains</span><span class="p">(</span><span class="n">allPowerPhi</span><span class="p">,</span> <span class="n">allInvCov</span><span class="p">,</span> <span class="n">allData</span><span class="p">)</span>

    <span class="n">chi2</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nimages</span><span class="p">):</span>
        <span class="c1"># Compute the chi2</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">allPowerPhi</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">@</span> <span class="n">A</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">M</span> <span class="o">-</span> <span class="n">allData</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">chi2</span> <span class="o">+=</span> <span class="n">R</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">allInvCov</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">@</span> <span class="n">R</span>

    <span class="k">if</span> <span class="n">returnA</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">Cov_A</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">chi2</span>


<span class="k">def</span> <span class="nf">make_chi2_grid</span><span class="p">(</span><span class="n">allInvCov</span><span class="p">,</span> <span class="n">fringes</span><span class="p">,</span> <span class="n">BLs</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">nval_fl</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">nval_th</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">fl_min</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">fl_max</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span>
                   <span class="n">th_min</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">),</span> <span class="n">th_max</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">LogPower</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">fixPower</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loop over the parameters (focal length and source off-axis angle) to explore the chi2.</span>
<span class="sd">    Global powers are fixed to Log_10(Power)=-1 or optimized at each step by minimizing a temporary chi2 (longer).&quot;&quot;&quot;</span>
    <span class="n">nimages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">BLs</span><span class="p">)</span>
    <span class="n">chi2_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nval_fl</span><span class="p">,</span> <span class="n">nval_th</span><span class="p">))</span>

    <span class="n">all_fl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">fl_min</span><span class="p">,</span> <span class="n">fl_max</span><span class="p">,</span> <span class="n">nval_fl</span><span class="p">)</span>
    <span class="n">all_th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">th_min</span><span class="p">,</span> <span class="n">th_max</span><span class="p">,</span> <span class="n">nval_th</span><span class="p">)</span>

    <span class="c1"># Fast method</span>
    <span class="k">if</span> <span class="n">fixPower</span><span class="p">:</span>
        <span class="c1"># Global powers are fixed to initPower and we loop on fl and th.</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_fl</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">th</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_th</span><span class="p">):</span>
                <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">fl</span><span class="p">,</span> <span class="n">th</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">LogPower</span><span class="p">]</span> <span class="o">*</span> <span class="n">nimages</span>
                <span class="n">chi2_grid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_chi2</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">allInvCov</span><span class="p">,</span> <span class="n">fringes</span><span class="p">,</span> <span class="n">BLs</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">all_fl</span><span class="p">,</span> <span class="n">all_th</span><span class="p">,</span> <span class="n">chi2_grid</span>

    <span class="c1"># Slow method but more rigorous</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Loop on fl and th and at each step, minimize the chi2 to find the best global powers.</span>
        <span class="n">power_optimize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nval_fl</span><span class="p">,</span> <span class="n">nval_th</span><span class="p">,</span> <span class="n">nimages</span><span class="p">))</span>
        <span class="n">step</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_fl</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">th</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_th</span><span class="p">):</span>
                <span class="k">def</span> <span class="nf">chi2_temporary</span><span class="p">(</span><span class="n">mypower</span><span class="p">,</span> <span class="n">allInvCov</span><span class="p">,</span> <span class="n">fringes</span><span class="p">,</span> <span class="n">BLs</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">fl</span><span class="p">,</span> <span class="n">th</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">mypower</span><span class="p">)</span>
                    <span class="n">chi2_temp</span> <span class="o">=</span> <span class="n">get_chi2</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">allInvCov</span><span class="p">,</span> <span class="n">fringes</span><span class="p">,</span> <span class="n">BLs</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">chi2_temp</span>

                <span class="n">result</span> <span class="o">=</span> <span class="n">sop</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">chi2_temporary</span><span class="p">,</span>
                                      <span class="n">x0</span><span class="o">=</span><span class="p">[</span><span class="n">LogPower</span><span class="p">]</span> <span class="o">*</span> <span class="n">nimages</span><span class="p">,</span>
                                      <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">allInvCov</span><span class="p">,</span> <span class="n">fringes</span><span class="p">,</span> <span class="n">BLs</span><span class="p">,</span> <span class="n">q</span><span class="p">),</span>
                                      <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Nelder-Mead&#39;</span><span class="p">,</span>
                                      <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;maxiter&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">})</span>
                <span class="n">chi2_grid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;fun&#39;</span><span class="p">]</span>
                <span class="n">power_optimize</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">***Step </span><span class="si">{</span><span class="n">step</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">nval_fl</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">nval_th</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Chi2 min:&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;fun&#39;</span><span class="p">])</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;with powers =&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
                <span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">all_fl</span><span class="p">,</span> <span class="n">all_th</span><span class="p">,</span> <span class="n">chi2_grid</span><span class="p">,</span> <span class="n">power_optimize</span>


<span class="c1"># ========== Fringe simulations =============</span>
<span class="k">class</span> <span class="nc">Model_Fringes_Ana</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">baseline</span><span class="p">,</span> <span class="n">theta_source</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">phi_source</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">nu_source</span><span class="o">=</span><span class="mf">150e9</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="mf">20.</span><span class="p">,</span> <span class="n">amp</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;ONAFP&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        q: QubicInstrument</span>
<span class="sd">        baseline: list</span>
<span class="sd">            Baseline formed with 2 horns, index between 1 and 64 as on the instrument.</span>
<span class="sd">        theta_source: float</span>
<span class="sd">            The source zenith angle [rad].</span>
<span class="sd">        phi_source: float</span>
<span class="sd">            The source azimuthal angle [rad].</span>
<span class="sd">        nu_source: float</span>
<span class="sd">            Source frequency [Hz].</span>
<span class="sd">        fwhm: float</span>
<span class="sd">        amp: float</span>
<span class="sd">            Global amplitude for the fringes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BL</span> <span class="o">=</span> <span class="n">baseline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">q</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">focal</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">optics</span><span class="o">.</span><span class="n">focal_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_source</span> <span class="o">=</span> <span class="n">theta_source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phi_source</span> <span class="o">=</span> <span class="n">phi_source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nu_source</span> <span class="o">=</span> <span class="n">nu_source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lam</span> <span class="o">=</span> <span class="mf">3e8</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu_source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="n">fwhm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amp</span> <span class="o">=</span> <span class="n">amp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span>

        <span class="c1"># Detector centers</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">==</span> <span class="s1">&#39;ONAFP&#39;</span><span class="p">:</span>
            <span class="n">xONAFP</span><span class="p">,</span> <span class="n">yONAFP</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_TEScoordinates_ONAFP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">xONAFP</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">yONAFP</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">==</span> <span class="s1">&#39;GRF&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">center</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">center</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Angle and length of the baseline:</span>
        <span class="n">BL_angle</span><span class="p">,</span> <span class="n">BL_length</span><span class="p">,</span> <span class="n">BL_center</span> <span class="o">=</span> <span class="n">give_bs_pars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BL</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;ONAFP&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BL_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">BL_angle</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BL_length</span> <span class="o">=</span> <span class="n">BL_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BL_xc</span> <span class="o">=</span> <span class="n">BL_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BL_yc</span> <span class="o">=</span> <span class="n">BL_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Additional phase</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BL_xc</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">BL_yc</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">3e8</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu_source</span> <span class="o">*</span> <span class="n">dist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_source</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span>

    <span class="k">def</span> <span class="nf">make_gaussian</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">/</span> <span class="mf">2.355</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">focal</span><span class="p">)</span>
        <span class="c1"># The position of the gaussian depends on the position of the source</span>
        <span class="c1"># Maybe there is a sign problem here...</span>
        <span class="n">x_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">focal</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_source</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phi_source</span><span class="p">)</span>
        <span class="n">y_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">focal</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_source</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phi_source</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gaussian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">x_center</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_center</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaussian</span>

    <span class="k">def</span> <span class="nf">get_fringes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">times_gaussian</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">times_gaussian</span><span class="p">:</span>
            <span class="n">gaussian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_gaussian</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gaussian</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">xprime</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BL_angle</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BL_angle</span><span class="p">))</span>
        <span class="n">interfrange</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lam</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">focal</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">BL_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fringes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">interfrange</span> <span class="o">*</span> <span class="n">xprime</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">)</span> <span class="o">*</span> <span class="n">gaussian</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fringes</span>



<div class="viewcode-block" id="Model_Fringes_QubicSoft">
<a class="viewcode-back" href="../../qubic.html#qubic.selfcal_lib.Model_Fringes_QubicSoft">[docs]</a>
<span class="k">class</span> <span class="nc">Model_Fringes_QubicSoft</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">baseline</span><span class="p">,</span>
                 <span class="n">theta_source</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                 <span class="n">phi_source</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                 <span class="n">nu_source</span><span class="o">=</span><span class="mf">150e9</span><span class="p">,</span>
                 <span class="n">spec_irrad_source</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
                 <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;ONAFP&#39;</span><span class="p">,</span>
                 <span class="n">external_A</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">hwp_position</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        q: QubicInstrument</span>
<span class="sd">        baseline: list</span>
<span class="sd">            Baseline formed with 2 horns, index between 1 and 64 as on the instrument.</span>
<span class="sd">        theta_source: float</span>
<span class="sd">            The source zenith angle [rad].</span>
<span class="sd">        phi_source: float</span>
<span class="sd">            The source azimuthal angle [rad].</span>
<span class="sd">        nu_source: float</span>
<span class="sd">            Source frequency [Hz].</span>
<span class="sd">        spec_irrad: array-like</span>
<span class="sd">            The source spectral_irradiance [W/m^2/Hz].</span>
<span class="sd">        frame: str</span>
<span class="sd">            &#39;GRF&#39; or &#39;ONAFP&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">q</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span> <span class="o">=</span> <span class="n">baseline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_source</span> <span class="o">=</span> <span class="n">theta_source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phi_source</span> <span class="o">=</span> <span class="n">phi_source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nu_source</span> <span class="o">=</span> <span class="n">nu_source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec_irrad_source</span> <span class="o">=</span> <span class="n">spec_irrad_source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_A</span> <span class="o">=</span> <span class="n">external_A</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hwp_position</span> <span class="o">=</span> <span class="n">hwp_position</span>

<div class="viewcode-block" id="Model_Fringes_QubicSoft.get_fringes">
<a class="viewcode-back" href="../../qubic.html#qubic.selfcal_lib.Model_Fringes_QubicSoft.get_fringes">[docs]</a>
    <span class="k">def</span> <span class="nf">get_fringes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the fringes on the focal plane directly opening the baseline.</span>
<span class="sd">        see get_response_power() for the arguments.</span>
<span class="sd">        Returns (x, y) coordinates and the power.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">open_switches</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fringes</span> <span class="o">=</span> <span class="n">get_response_power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu_source</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">spec_irrad_source</span><span class="p">,</span>
                                           <span class="n">frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span>
                                           <span class="n">external_A</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">external_A</span><span class="p">,</span>
                                           <span class="n">hwp_position</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hwp_position</span><span class="p">,</span>
                                           <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">doplot</span><span class="p">:</span>
            <span class="n">plot_horn_and_FP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fringes</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span>
                             <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Baseline </span><span class="si">{}</span><span class="s1"> - Theta=</span><span class="si">{}</span><span class="s1">deg - Phi=</span><span class="si">{}</span><span class="s1">deg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span>
                                                                                  <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_source</span><span class="p">),</span>
                                                                                  <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phi_source</span><span class="p">)),</span>
                             <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fringes</span></div>


<div class="viewcode-block" id="Model_Fringes_QubicSoft.get_all_combinations_power">
<a class="viewcode-back" href="../../qubic.html#qubic.selfcal_lib.Model_Fringes_QubicSoft.get_all_combinations_power">[docs]</a>
    <span class="k">def</span> <span class="nf">get_all_combinations_power</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns the power on the focal plane at each pointing (each position of the source),</span>
<span class="sd">            for different configurations of the horn array: all open, all open except i, except j,</span>
<span class="sd">            except i and j, only i open, only j open, only i and j open.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        x, y: The coordinates on the FP.</span>
<span class="sd">        S, Cminus_i, Cminus_j, Sminus_ij, Ci, Cj, Sij : arrays</span>
<span class="sd">            Power on the focal plane for each configuration, at each pointing.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="o">.</span><span class="n">open</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># All open</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">S</span> <span class="o">=</span> <span class="n">get_response_power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu_source</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">spec_irrad_source</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">doplot</span><span class="p">:</span>
            <span class="n">plot_horn_and_FP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;$S$ - All open&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># All open except i</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="o">.</span><span class="n">open</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Cminus_i</span> <span class="o">=</span> <span class="n">get_response_power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu_source</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">spec_irrad_source</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">doplot</span><span class="p">:</span>
            <span class="n">plot_horn_and_FP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">Cminus_i</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span>
                             <span class="n">title</span><span class="o">=</span><span class="s1">&#39;$C_{-i}$&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39; - Horn </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> close&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># All open except baseline [i, j]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="o">.</span><span class="n">open</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Sminus_ij</span> <span class="o">=</span> <span class="n">get_response_power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu_source</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">spec_irrad_source</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">doplot</span><span class="p">:</span>
            <span class="n">plot_horn_and_FP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">Sminus_ij</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span>
                             <span class="n">title</span><span class="o">=</span><span class="s1">&#39;$S_{-ij}$&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39; - Baseline </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="si">}</span><span class="s1"> close&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># All open except j</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="o">.</span><span class="n">open</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Cminus_j</span> <span class="o">=</span> <span class="n">get_response_power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu_source</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">spec_irrad_source</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">doplot</span><span class="p">:</span>
            <span class="n">plot_horn_and_FP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">Cminus_j</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span>
                             <span class="n">title</span><span class="o">=</span><span class="s1">&#39;$C_{-j}$&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39; - Horn </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> close&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Only i open (not a realistic observable)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="o">.</span><span class="n">open</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="o">.</span><span class="n">open</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Ci</span> <span class="o">=</span> <span class="n">get_response_power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu_source</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">spec_irrad_source</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">doplot</span><span class="p">:</span>
            <span class="n">plot_horn_and_FP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">Ci</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span>
                             <span class="n">title</span><span class="o">=</span><span class="s1">&#39;$C_i$&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39; - Only horn </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> open&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Only j open (not a realistic observable)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="o">.</span><span class="n">open</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="o">.</span><span class="n">open</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Cj</span> <span class="o">=</span> <span class="n">get_response_power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu_source</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">spec_irrad_source</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">doplot</span><span class="p">:</span>
            <span class="n">plot_horn_and_FP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">Cj</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span>
                             <span class="n">title</span><span class="o">=</span><span class="s1">&#39;$C_j$&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39; - Only horn </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> open&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Only baseline [i, j] open (not a realistic observable)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="o">.</span><span class="n">open</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Sij</span> <span class="o">=</span> <span class="n">get_response_power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu_source</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">spec_irrad_source</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">doplot</span><span class="p">:</span>
            <span class="n">plot_horn_and_FP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">Sij</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span>
                             <span class="n">title</span><span class="o">=</span><span class="s1">&#39;$S_</span><span class="si">{ij}</span><span class="s1">$&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39; - Only baseline </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="si">}</span><span class="s1"> open&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">Cminus_i</span><span class="p">,</span> <span class="n">Sminus_ij</span><span class="p">,</span> <span class="n">Cminus_j</span><span class="p">,</span> <span class="n">Ci</span><span class="p">,</span> <span class="n">Cj</span><span class="p">,</span> <span class="n">Sij</span></div>


<div class="viewcode-block" id="Model_Fringes_QubicSoft.get_fringes_from_combination">
<a class="viewcode-back" href="../../qubic.html#qubic.selfcal_lib.Model_Fringes_QubicSoft.get_fringes_from_combination">[docs]</a>
    <span class="k">def</span> <span class="nf">get_fringes_from_combination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">measured_comb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the fringes on the FP by making the combination</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        x, y: The coordinates on the FP.</span>
<span class="sd">        fringes : Fringes on the FP, for each coordinate, at each pointing.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">S_tot</span><span class="p">,</span> <span class="n">Cminus_i</span><span class="p">,</span> <span class="n">Sminus_ij</span><span class="p">,</span> <span class="n">Cminus_j</span><span class="p">,</span> <span class="n">Ci</span><span class="p">,</span> <span class="n">Cj</span><span class="p">,</span> <span class="n">Sij</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">get_all_combinations_power</span><span class="p">(</span><span class="n">doplot</span><span class="o">=</span><span class="n">doplot</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">measured_comb</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fringes_comb</span> <span class="o">=</span> <span class="n">S_tot</span> <span class="o">-</span> <span class="n">Cminus_i</span> <span class="o">-</span> <span class="n">Cminus_j</span> <span class="o">+</span> <span class="n">Sminus_ij</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fringes_comb</span> <span class="o">=</span> <span class="n">S_tot</span> <span class="o">-</span> <span class="n">Cminus_i</span> <span class="o">-</span> <span class="n">Cminus_j</span> <span class="o">+</span> <span class="n">Sminus_ij</span> <span class="o">+</span> <span class="n">Ci</span> <span class="o">+</span> <span class="n">Cj</span>

        <span class="k">if</span> <span class="n">doplot</span><span class="p">:</span>
            <span class="n">plot_horn_and_FP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fringes_comb</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span>
                             <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Baseline </span><span class="si">{}</span><span class="s1"> - Theta=</span><span class="si">{}</span><span class="s1">deg - Phi=</span><span class="si">{}</span><span class="s1">deg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span>
                                                                                  <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_source</span><span class="p">),</span>
                                                                                  <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phi_source</span><span class="p">)),</span>
                             <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fringes_comb</span></div>
</div>



<div class="viewcode-block" id="Model_Fringes_Maynooth">
<a class="viewcode-back" href="../../qubic.html#qubic.selfcal_lib.Model_Fringes_Maynooth">[docs]</a>
<span class="k">class</span> <span class="nc">Model_Fringes_Maynooth</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">baseline</span><span class="p">,</span> <span class="n">rep</span><span class="p">,</span>
                 <span class="n">theta_source</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">nu_source</span><span class="o">=</span><span class="mf">150e9</span><span class="p">,</span>
                 <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;ONAFP&#39;</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        q: QubicInstrument</span>
<span class="sd">        baseline: list</span>
<span class="sd">            Baseline formed with 2 horns, index between 1 and 64 as on the instrument.</span>
<span class="sd">        rep: str</span>
<span class="sd">            Repository with the simulation files.</span>
<span class="sd">        theta: float</span>
<span class="sd">            The source zenith angle [rad].</span>
<span class="sd">        nu: float</span>
<span class="sd">            Frequency of the calibration source [Hz]</span>
<span class="sd">        frame: str</span>
<span class="sd">            &#39;GRF&#39; or &#39;ONAFP&#39;.</span>
<span class="sd">        interp: bool</span>
<span class="sd">            If True, interpolate and integrate in each TES (takes time).</span>
<span class="sd">            If False, make the mean in each TES (faster).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">q</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span> <span class="o">=</span> <span class="n">baseline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rep</span> <span class="o">=</span> <span class="n">rep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_source</span> <span class="o">=</span> <span class="n">theta_source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nu_source</span> <span class="o">=</span> <span class="n">nu_source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interp</span> <span class="o">=</span> <span class="n">interp</span>

<div class="viewcode-block" id="Model_Fringes_Maynooth.get_fringes">
<a class="viewcode-back" href="../../qubic.html#qubic.selfcal_lib.Model_Fringes_Maynooth.get_fringes">[docs]</a>
    <span class="k">def</span> <span class="nf">get_fringes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute fringes on the focal plane from Maynooth simulations.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        x, y coordinates on the FP in the ONAFP frame and the corresponding power.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">config</span> <span class="o">!=</span> <span class="s1">&#39;TD&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Maynooth simulations are for the TD only.&#39;</span><span class="p">)</span>

        <span class="n">xONAFP</span><span class="p">,</span> <span class="n">yONAFP</span><span class="p">,</span> <span class="n">fringes_fullreso</span> <span class="o">=</span> <span class="n">get_power_Maynooth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">theta_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu_source</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="o">.</span><span class="n">center</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="c1"># TES centers and TES vertex in the ONAFP frame</span>
        <span class="n">xONAFP_TES</span><span class="p">,</span> <span class="n">yONAFP_TES</span><span class="p">,</span> <span class="n">vONAFP_TES</span> <span class="o">=</span> <span class="n">get_TEScoordinates_ONAFP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fringes</span> <span class="o">=</span> <span class="n">fullreso2TESreso</span><span class="p">(</span><span class="n">xONAFP</span><span class="p">,</span> <span class="n">yONAFP</span><span class="p">,</span> <span class="n">fringes_fullreso</span><span class="p">,</span>
                                        <span class="n">vONAFP_TES</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">area</span><span class="p">,</span>
                                        <span class="n">interp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interp</span><span class="p">,</span>
                                        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="c1"># power_TES *= q.filter.bandwidth  # W/Hz to W</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">==</span> <span class="s1">&#39;ONAFP&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">xONAFP_TES</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">yONAFP_TES</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">==</span> <span class="s1">&#39;GRF&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">yONAFP_TES</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="o">-</span> <span class="n">xONAFP_TES</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fringes</span></div>


<div class="viewcode-block" id="Model_Fringes_Maynooth.get_fringes_from_combination">
<a class="viewcode-back" href="../../qubic.html#qubic.selfcal_lib.Model_Fringes_Maynooth.get_fringes_from_combination">[docs]</a>
    <span class="k">def</span> <span class="nf">get_fringes_from_combination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">measured_comb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute fringes on the focal plane from Maynooth simulations doing the combination with</span>
<span class="sd">        S_tot, Cminus_i, Cminus_j, Sminus_ij, Ci and Cj.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        measured_comb: bool</span>
<span class="sd">            If True, returns the measured combination: S_tot - Cminus_i - Cminus_j + Sminus_ij.</span>
<span class="sd">            If False, returns the complete combination: S_tot - Cminus_i - Cminus_j + Sminus_ij + Ci + Cj.</span>

<span class="sd">        verbose: bool</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        x, y coordinates on the FP in the ONAFP frame and the corresponding power.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">all_open</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">65</span><span class="p">)</span>
        <span class="n">first_close</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">all_open</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">second_close</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">all_open</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">both_close</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">all_open</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">xONAFP</span><span class="p">,</span> <span class="n">yONAFP</span><span class="p">,</span> <span class="n">S_tot</span> <span class="o">=</span> <span class="n">get_power_Maynooth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rep</span><span class="p">,</span> <span class="n">all_open</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu_source</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="o">.</span><span class="n">center</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Cminus_i</span> <span class="o">=</span> <span class="n">get_power_Maynooth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rep</span><span class="p">,</span> <span class="n">first_close</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu_source</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="o">.</span><span class="n">center</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Cminus_j</span> <span class="o">=</span> <span class="n">get_power_Maynooth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rep</span><span class="p">,</span> <span class="n">second_close</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu_source</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="o">.</span><span class="n">center</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Sminus_ij</span> <span class="o">=</span> <span class="n">get_power_Maynooth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rep</span><span class="p">,</span> <span class="n">both_close</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu_source</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="o">.</span><span class="n">center</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">measured_comb</span><span class="p">:</span>
            <span class="n">fringes_comb_fullreso</span> <span class="o">=</span> <span class="n">S_tot</span> <span class="o">-</span> <span class="n">Cminus_i</span> <span class="o">-</span> <span class="n">Cminus_j</span> <span class="o">+</span> <span class="n">Sminus_ij</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Ci</span> <span class="o">=</span> <span class="n">get_power_Maynooth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rep</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu_source</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="o">.</span><span class="n">center</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Cj</span> <span class="o">=</span> <span class="n">get_power_Maynooth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rep</span><span class="p">,</span> <span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu_source</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">horn</span><span class="o">.</span><span class="n">center</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="n">fringes_comb_fullreso</span> <span class="o">=</span> <span class="n">S_tot</span> <span class="o">-</span> <span class="n">Cminus_i</span> <span class="o">-</span> <span class="n">Cminus_j</span> <span class="o">+</span> <span class="n">Sminus_ij</span> <span class="o">+</span> <span class="n">Ci</span> <span class="o">+</span> <span class="n">Cj</span>

        <span class="c1"># TES centers and TES vertex in the ONAFP frame</span>
        <span class="n">xONAFP_TES</span><span class="p">,</span> <span class="n">yONAFP_TES</span><span class="p">,</span> <span class="n">vONAFP_TES</span> <span class="o">=</span> <span class="n">get_TEScoordinates_ONAFP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fringes_comb</span> <span class="o">=</span> <span class="n">fullreso2TESreso</span><span class="p">(</span><span class="n">xONAFP</span><span class="p">,</span> <span class="n">yONAFP</span><span class="p">,</span> <span class="n">fringes_comb_fullreso</span><span class="p">,</span>
                                            <span class="n">vONAFP_TES</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">area</span><span class="p">,</span>
                                            <span class="n">interp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interp</span><span class="p">,</span>
                                            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">==</span> <span class="s1">&#39;ONAFP&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">xONAFP_TES</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">yONAFP_TES</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">==</span> <span class="s1">&#39;GRF&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">yONAFP_TES</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="o">-</span> <span class="n">xONAFP_TES</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fringes_comb</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, QUBIC Collaboration.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>