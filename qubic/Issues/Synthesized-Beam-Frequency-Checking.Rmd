---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.4.0
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

# Issue #10 Problem with Primary Beam at different frequencies

```{python}
rc('figure', figsize=(16, 16))
rc('font', size=12)
rc('text', usetex=False)
rc('image', cmap='viridis')

import numpy as np
import matplotlib.pyplot as plt
import qubic
```

```{python}
#### This is the analytical synthesized for a pixel at the focal plane center 
#### without accounting for the primry beam (just the mukltple peaks)
def sb_noprim(th_deg, nu):
    th = np.radians(th_deg)
    lam = 3e8/nu
    P = 20
    deltax = 0.013
    df = 300.
    abscissa = np.pi * deltax/lam * th
    sb = np.sin(P*abscissa)**2 / np.sin(abscissa)**2
    return sb/np.max(sb)
```

```{python}
## With Multiband = False  => using a QubicInstrument

d = qubic.qubicdict.qubicDict()
d.read_from_file('../dicts/global_source_oneDet.dict')
d['multiband'] = False
d['config'] = 'FI'

# freqs = np.array([210*1e9, 220*1e9, 230*1e9])
freqs = np.array([1.32638868e+11, 1.50398340e+11, 1.67001321e+11])
nn = 1000
th = np.linspace(-30, 30, nn)
ph = 0

beams = ['gaussian', 'fitted_beam', 'multi_freq']

for b, beam in enumerate(beams):
    d['beam_shape'] = beam
    allbeams = np.zeros((len(freqs), nn))
    for i in range(len(freqs)):
        d['filter_nu'] = freqs[i]
        q = qubic.QubicInstrument(d)
        allbeams[i, :] = q.primary_beam(np.radians(np.abs(th)),ph)

        subplot(3, 1, b + 1)
        p = plot(th, allbeams[i,:],'--', label='nu={0:6.1f}'.format(freqs[i]/1e9))
        plot(th, allbeams[i,:]*sb_noprim(th, freqs[i]), color=p[0].get_color())

#         subplot(3, 2, b*2+2)
#         p = plot(th, allbeams[i,:],'--', label='nu={0:6.1f}'.format(freqs[i]/1e9))
#         plot(th, allbeams[i,:] * sb_noprim(th, freqs[i]), color=p[0].get_color())
#         yscale('log')
#         ylim(1e-3, 0)
    title('Beam_shape = {}, Multiband = {}'.format(d['beam_shape'], d['multiband']))
    legend()

```

```{python}
# q.primary_beam??
```

```{python}
# With multiband = True code have to be written differently
d = qubic.qubicdict.qubicDict()
d.read_from_file('../dicts/global_source_oneDet.dict')
d['multiband'] = True

q = qubic.QubicMultibandInstrument(d)
nsub = len(q)
nus = np.zeros(nsub)
for i in range(nsub): 
    nus[i] = q[i].filter.nu

indices = [0, 6, 11]

for b, beam in enumerate(beams):
    d['beam_shape'] = beam
    for i in range(len(indices)):
        allbeams[i,:] = q[indices[i]].primary_beam(np.radians(np.abs(th)),ph)
        subplot(3,1,b+1)
        p = plot(th, allbeams[i,:], '--', label='nu={0:6.1f}'.format(nus[i]/1e9))
        plot(th, allbeams[i,:] * sb_noprim(th, freqs[i]), color=p[0].get_color())

#         subplot(1,2,2)
#         p = plot(th, allbeams[i,:], '--', label='nu={0:6.1f}'.format(nus[i]/1e9))
#         plot(th, allbeams[i,:] * sb_noprim(th, freqs[i]), color=p[0].get_color())
#         yscale('log')
#         ylim(1e-3, 0)
        title('d[beam_shape]=' + beam + ' , Multiband=' + str(d['multiband']))
    legend()

```

```{python}

```

```{python}

```
