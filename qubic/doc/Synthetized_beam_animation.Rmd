---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.4.0
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

# Synthetized beam on the sky

```{python}
import glob
import os 

import numpy as np
import healpy as hp

import matplotlib.pyplot as plt
from matplotlib.animation import FuncAnimation

# %matplotlib inline
# %matplotlib notebook

from matplotlib import rc
rc('figure',figsize=(15,15))
rc('font',size=14)
#rc('text',usetex=False)

import qubic 
import qubic.sb_fitting as sbfit
import qubic.selfcal_lib as scal

from qubicpack.pixel_translation import make_id_focalplane, tes2index
```

```{python}
# If you want to save plots, set the directory here
save_dir = '/home/lmousset/QUBIC/These_manuscrit/Figures/Plots/'
```

```{python}
# Dictionary
d = qubic.qubicdict.qubicDict()
d.read_from_file('pipeline_demo.dict')
d['config'] = 'TD'
d['synthbeam_kmax'] = 3

# Instrument and scene
q = qubic.QubicInstrument(d)
s = qubic.QubicScene(d)
```

### Synthetic beams on the sky for all TES

```{python}
sb = q.get_synthbeam(s, idet=None, external_A=None, hwp_position=0)
print(sb.shape)

kmax = d['synthbeam_kmax']
npeaks = (2 * kmax + 1)**2
```

## Order the detectors in four regions as a function of the main peak 

```{python}
# detector_type=[]
# for l1 in allmain_peaks:
#     for j, l2 in enumerate(allmain_peaks):
#         if l1 == l2:
#             detector_type.append(j)
#             break  
            

```

```{python}
theta, phi, theta_order, phi_order, val_order = scal.get_coords_peaks(q, s, d, verbose=True)
allmain_peaks = scal.get_main_peak_list(theta, theta_order)
print(set(allmain_peaks))
the_nine_peaks = scal.get_peak_list(30)
print(the_nine_peaks)
```

### Coordinates of the TES in ONAFP

```{python}
xONAFP, yONAFP, vONAFP = scal.get_TEScoordinates_ONAFP(q)
print(xONAFP.shape)
```

### Plot

To compare simu/measurement, it looks we have to do the following (not sure):
* Measurement: centered on (lon=0, lat=0, phi=0)
* Simulation: centered on (lon=0, lat=90, phi=180)

```{python}
weirdTES = [1, 2, 14, 16, 28, 33, 34, 35, 40, 41, 46, 47, 48,
            49, 51, 53, 54, 55, 60, 73, 74, 80, 81, 85, 86, 92, 93, 104,
            105, 110, 114, 115, 117, 122, 125, 127, 128]
weirdx0, weirdy0 = [], []
for tes in weirdTES:
    x0, y0, FP_index, index_q = scal.TES_Instru2coord(tes, 2, q, frame='ONAFP')
    weirdx0.append(x0)
    weirdy0.append(y0)
```

```{python}
# Choose a TES (Instrument numerotation)
TES, ASIC = 95, 1
x0, y0, FP_index, index_q = scal.TES_Instru2coord(TES, ASIC, q, frame='ONAFP')

plt.subplots(1, 2, figsize=(12, 7))
plt.suptitle(f'TES {TES} - ASIC {ASIC}')#' - Index_q {index_q}')

# Focal plane
plt.subplot(121)
plt.scatter(xONAFP, yONAFP, c=allmain_peaks, marker='s', s=180, alpha=0.8, cmap='jet')
plt.xlabel('X_ONAFP')
plt.ylabel('Y_ONAFP')

plt.plot(weirdx0, weirdy0, 'ro')
plt.plot(x0, y0, 'bo')
plt.axis('square')
plt.title('Focal plane')

# Simulation
plt.subplot(122)
plt.axis('off')
hp.gnomview(sb[index_q], min=0, max=5e5, rot=(0, 90, 180), reso=28, sub=(122),
            title=f'Simulation - Main peak: {allmain_peaks[index_q]}', cbar=False)
hp.graticule(dpar=5)
for p in range(npeaks):
    th = theta[index_q, p]
    ph = phi[index_q, p]
#     th2 = theta_order[index_q, p]
#     ph2 = phi_order[index_q, p]
    hp.visufunc.projtext(th, ph, str(p), color='w', fontsize=10) 
#     hp.visufunc.projtext(th2+0.02, ph2+0.02, str(p), color='r', fontsize=10) 

#     th2 = theta_order[index_q, p]
#     ph2 = phi_order[index_q, p]
# #     hp.visufunc.projscatter(th2, ph2, color='w', marker='+')
#     if p < 9:
#         hp.visufunc.projtext(th2, ph2, str(p), color='r', fontsize=10)
#     else:
#         hp.visufunc.projtext(th2, ph2, str(p), color='orange', fontsize=10)

#plt.savefig(save_dir + f'peak_numbering_TES{TES}_ASIC{ASIC}.pdf', bbox_inches='tight')
```

```{python}
(nine_peak_alldet==30).sum()
```

```{python}
len(allmain_peaks)
allmain_peaks[-10]
```

```{python}
nine_peak_alldet.shape
```

```{python}
TES, ASIC = 46, 2
idx = get_index256array_from_TES(TES, ASIC)
nine_peak_alldet[idx]
```

```{python}
def get_index256array_from_TES(TES, ASIC):
    idx = (ASIC-1) * 128 + (TES-1)
    return idx

def get_TES_from_index256array(idx):
    TES = idx % 128 + 1
    ASIC = idx // 128 + 1
    return TES, ASIC


def get_nine_peak_alldet(q, s, d, verbose=True):
    theta, phi, theta_order, phi_order, val_order = scal.get_coords_peaks(q, s, d, verbose=True)
    print(theta.shape)
    allmain_peaks = scal.get_main_peak_list(theta, theta_order)
    nine_peak_alldet = []
    for idx in range(256):
        TES, ASIC = get_TES_from_index256array(idx)
        #print(TES, ASIC)
        _, _, _, index_q = scal.TES_Instru2coord(TES, ASIC, q, verbose=verbose)
        #print(index_q)
        if index_q is not None: #To avoid thermometers:
            main_peak = allmain_peaks[index_q]
            nine_peak_alldet.append(scal.get_peak_list(main_peak))

        else:
            nine_peak_alldet.append([np.nan]*9)
    return np.array(nine_peak_alldet)

nine_peak_alldet = get_nine_peak_alldet(q, s, d, verbose=True)
```

#### Print on the sky the motion of the one peak for all TES 


### Animation to see the beam moving

```{python}
# Choose a peak
color=['b', 'orange','g', 'r']
hp.gnomview(sb[200] * 0., min=0, max=1e6, rot=(0, 90, 180), reso=12, title=None, cbar=False)
hp.graticule(dpar=5)
for i, p in enumerate([16, 23, 24, 30]):
    for TES in range(248):
        
        th = theta[TES, p]
        ph = phi[TES, p]
        hp.visufunc.projscatter(th, ph, color=color[i], marker='.')
    #     hp.visufunc.projtext(th, ph, str(TES), color=color, fontsize=10)
#plt.savefig(save_dir + 'peak_displacement.pdf', bbox_inches='tight')
```

```{python}
d['nside']
```

```{python}
def animate(det):
    index = q.detector.index[det]
       
    # Focal plane
#     ax1.annotate(str(tes_index[tes]),  xy=(x, y), fontsize=10, color='r')
    
    x = xONAFP[det]
    y = yONAFP[det]
    point.set_data(x, y)
#     ax1.set_title('TES {}'.format(index))
    
    
    # Simulation
    hp.gnomview(sb[det], min=0, max=1e5, rot=(0, 90, 180), reso=20, sub=(122), 
                title='Simulation', cbar=False)
    hp.graticule()
    
    # pixel with Highest intensity
    nside = hp.get_nside(sb[det])
    pix_max = np.argmax(sb[det])
    lon, lat = hp.pix2ang(hp.get_nside(sb[det]), pix_max, lonlat=True)
    hp.visufunc.projscatter(lon, lat, color='r', marker='+', s=500, lonlat=True, label='Highest pixel')
    plt.legend()
    # Numbering of the peaks (absolute and ordered by intensity)
#     for p in range(npeaks):
#         th = theta[det, p]
#         ph = phi[det, p]
#         th2 = theta_order[det, p]
#         ph2 = phi_order[det, p]
# #         hp.visufunc.projscatter(th, ph, color='w', marker='+')
#         hp.visufunc.projtext(th-0.02, ph-0.02, str(p), color='w', fontsize=12) 
#         hp.visufunc.projtext(th2+0.02, ph2+0.02, str(p), color='r', fontsize=12) 
    

def init():
#     ax1.set_title('Synthetic beam on the sky')
    ax1.axis('square')
    ax2.axis('off')

    
fig, axs = plt.subplots(1, 2, figsize=(12, 8))
ax1, ax2 = np.ravel(axs)
ax1.scatter(xONAFP, yONAFP, c=allmain_peaks, marker='s', s=200, alpha=0.8, cmap='jet')
ax1.set_xlabel('X_ONAFP')
ax1.set_ylabel('Y_ONAFP')

det0 = 238
x0 = xONAFP[det0]
y0 = yONAFP[det0]
point, = ax1.plot(x0, y0, 'ro')
steps = np.arange(det0, det0+10, 1)

anim = FuncAnimation(fig, animate, steps, init_func=init, interval=1000, blit=True, repeat=False)

# Save a .gif
# anim.save('./animation_beam.gif', writer='imagemagick')
```

```{python}

```
