---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.4.0
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

# Simulations for calibration (fringes on the FP)

#### Edited by Louise
selfcal_lib.py allows to do several simulations concerning the calibration, especially the simlation of the signal on the focal plane. This notebook gives some examples of what you can do with.

```{python pycharm={'is_executing': False}}
from __future__ import division, print_function

# %matplotlib inline
# %matplotlib notebook

import numpy as np
import scipy
import matplotlib.pyplot as plt
import matplotlib.ticker as plticker
from matplotlib.colors import SymLogNorm

from qubicpack.utilities import Qubic_DataDir

import qubic

from qubic import selfcal_lib as scal

plt.rcParams['figure.figsize'] = (12, 6)


# import matplotlib.animation as animation
# from IPython.display import HTML
```

```{python}
# Use a tool from qubicpack to get a path
basedir = Qubic_DataDir(datafile='instrument.py', ) 
print('basedir : ', basedir)


# Get a dictionary
dictfilename = basedir + '/dicts/global_source_oneDet.dict'
d = qubic.qubicdict.qubicDict()
d.read_from_file(dictfilename)
print(d['detarray'])
print(d['MultiBand'])
print(d['nf_sub'])

d['MultiBand'] = False
d['nf_sub'] = 1
d['config'] = 'TD'
d['beam_shape'] = 'gaussian'
```

```{python}
# You need a qubic instrument for that function
q = qubic.QubicInstrument(d)

plt.figure(figsize=(6, 4))
q.detector.plot(fill=True)
plt.xlabel('X_GRF')
plt.ylabel('Y_GRF')
plt.title('q.detector.plot()')

# q.optics.focal_length = 0.30 # Change the focal length
```

# Instrument horn config

```{python}
q.horn.open = False # All close
q.horn.open[3] = True # Close one
print(q.horn)

plt.subplots(1, 2, figsize=(12, 6))

plt.subplot(121)
q.horn.plot()
plt.xlabel('$X_{GRF}$ [m]', fontsize=20)
plt.ylabel('$Y_{GRF}$ [m]', fontsize=20)
plt.axis('equal')

# Numbering on the horns
a = 1
x = q.horn.center[:, 0]
y = q.horn.center[:, 1]
for i,j in zip(x, y):
    corr = -0.002 # adds a little correction to put annotation in marker's centrum
    plt.annotate(str(a),  xy=(i + corr, j + corr), fontsize=14, color='r')
    a += 1
    
plt.subplot(122)
q.horn.plot()
scal.plot_baseline(q, [25, 57])
plt.xlabel('$X_{GRF}$ [m]', fontsize=20)
plt.ylabel('$Y_{GRF}$ [m]', fontsize=20)
plt.axis('equal')
```

# Qubic soft simulation (no aberrations)

This is a simulation that doesn't take into account optical aberrations (only geometrical optics). If the point source is on the optical axis, then you get a symmetrical image.

You can choose the resolution you want for the image on the FP.

```{python}
# Create an object
# baseline = [142, 230]
baseline = [25, 57]
f = scal.Fringes(baseline)

xONAFP, yONAFP, fringes = f.get_fringes(q,
                                        theta=np.array([0.]), phi=np.array([0.]),
                                        nu=150e9, spectral_irradiance=1.,
                                        frame='ONAFP',
                                        doplot=True, verbose=True, norm=None)

print(fringes.shape)
```

```{python}
x, y, S, Cminus_i, Sminus_ij, Cminus_j, Ci, Cj, Sij = f.get_all_combinations_power(q, 
                                                                             theta=[0], phi=[0], 
                                                                             nu=150e9, spectral_irradiance=1.,
                                                                             frame='ONAFP',
                                                                             doplot=True, verbose=True, 
                                                                             norm=None)

# They are 3D arrays : (reso, reso, #pointings)
print('shape of each combination :', Cminus_i.shape)
```

```{python}
fringes_true = S - Cminus_i - Cminus_j + Sminus_ij + Ci + Cj
fringes_meas = S - Cminus_i - Cminus_j + Sminus_ij

plt.subplots(1, 2)
plt.suptitle(f'Baseline: {baseline}', fontsize=18)
plt.subplots_adjust(wspace=0.3)

plt.subplot(121)
scal.scatter_plot_FP(q, x, y, fringes_true[:, 0], frame='ONAFP', title='Complete combination', norm=None)
# scal.pcolor_plot_FP(q, x, y, fringes_true[:, 0], frame='ONAFP', title='Complete combination')

plt.subplot(122)
scal.scatter_plot_FP(q, x, y, fringes_meas[:, 0], frame='ONAFP', title='Measured combination', norm=None)
```

### Fringes by combining the different horn configurations

```{python}
# Make the combination (S_tot - Cminus_i - Cminus_j + Sminus_ij) / Ci

x, y, fringes_combined = f.get_fringes_from_combination(q,
                                                        measured_comb=False,
                                                        theta=[0], phi=[0], 
                                                        nu=150e9, spectral_irradiance=1.,
                                                        frame='ONAFP',
                                                        doplot=True, verbose=True)
print(fringes.shape)
```

# Power on the focal plane with optical aberrations
Using simulations from Maynooth,
need to download the files at : https://drive.google.com/open?id=19dPHw_CeuFZ068b-VRT7N-LWzOL1fmfG

```{python}
# Path to the simulated files 
rep = Qubic_DataDir(datafile='detcentres.txt', datadir='/home/lmousset/QUBIC/')
print('rep:', rep)
```

```{python}
open_horns = [25, 57]
xONAFP, yONAFP, power = scal.get_power_Maynooth(open_horns, 0., 150e9, q.horn.center, rep, hwp_position=0)
print(xONAFP.shape)
print(power.shape)

plt.figure()
scal.scatter_plot_FP(q, xONAFP, yONAFP, power, s=1, 
                   frame='ONAFP', 
                   title='Maynooth full resolution', 
                   norm=None)
```

```{python}
open_horns = [25, 57]
scal.open_switches(q, open_horns)

external_A = scal.make_external_A(rep, open_horns)

xONAFP, yONAFP, power = scal.get_response_power(q,
                                              theta=np.array([0.]), phi=np.array([0.]),
                                              nu=150e9, spectral_irradiance=1.,
                                              frame='ONAFP',
                                              external_A=external_A, hwp_position=0, 
                                              verbose=True)

plt.figure()
scal.scatter_plot_FP(q, xONAFP, yONAFP, power, s=100, 
                   frame='ONAFP', 
                   title='Maynooth full resolution', 
                   norm=None)
```

```{python}
xONAFP_TES, yONAFP_TES, powerTES = f.get_fringes_Maynooth(q, rep, 
                                                          theta=np.array([0.]), nu=150e9,
                                                          interp=True,
                                                          verbose=True)

plt.figure()
scal.scatter_plot_FP(q, xONAFP_TES, yONAFP_TES, powerTES, s=None, 
                   frame='ONAFP', 
                   title='Maynooth at TES resolution', 
                   norm=None)
```

```{python}
xONAFP_TES, yONAFP_TES, powerTES = f.get_fringes_Maynooth(q, rep, 
                                                          theta=np.array([0.]), nu=150e9,
                                                          interp=False,
                                                          verbose=True)

plt.figure()
scal.scatter_plot_FP(q, xONAFP_TES, yONAFP_TES, powerTES, s=None, 
                   frame='ONAFP', 
                   title='Maynooth at TES resolution', 
                   norm=None)
```

```{python}
xONAFP_TES, yONAFP_TES, fringes_comb_TES = f.get_fringes_Maynooth_combination(q, rep,
                                                                              measured_comb=True,
                                                                              theta=np.array([0.]), nu=150e9,
                                                                              interp=False,
                                                                              verbose=True)

plt.figure()
scal.scatter_plot_FP(q, xONAFP_TES, yONAFP_TES, fringes_comb_TES, s=None, 
                   frame='ONAFP', 
                   title='Maynooth TES resolution', 
                   norm=None)
```

```{python}

```
