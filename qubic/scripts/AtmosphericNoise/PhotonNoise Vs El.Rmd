---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.4.1
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

```{python}
from pylab import *
import os
import sys
import time
import pickle
from importlib import reload


# Specific science modules
import healpy as hp
import numpy as np
from scipy import interpolate

rc('figure', figsize=(16, 10))
rc('font', size=15)

# Specific qubic modules
from qubicpack.utilities import Qubic_DataDir
from pysimulators import FitsArray
import pysm
import qubic
from qubic import fibtools as ft
from qubic import SpectroImLib as si
from qubic import scene
```

```{python}
#config = 'TD'
config = 'FI'

if config == 'TD':
    dictname = 'test_photon_noise-TD.dict'
    freqs = [150.]
    ndet = 248
elif config == 'FI':
    dictname = 'test_photon_noise.dict'
    freqs = [150., 220.]
    ndet = 992

### Read input dictionary
reload(si)
reload(scene)
reload(qubic)

global_dir = Qubic_DataDir(datafile='instrument.py', datadir=os.environ['QUBIC_DATADIR'])
dictfilename = global_dir + '/dicts/'+dictname
d = qubic.qubicdict.qubicDict()
d.read_from_file(dictfilename)
d['npointings'] = 5000
d['nf_recon'] = 1
d['nf_sub'] = 1    ### this is OK as we use noise-only simulations

### Input map set to zeros
x0 = np.zeros((d['nf_sub'],d['nside']**2*12,3))
### Random pointing
p = qubic.get_pointing(d)

print(d['synthbeam_kmax'])
print(d['synthbeam_fraction'])
```

```{python}
f = 150
print('   Frequency = {}'.format(f))
d['filter_nu'] = f*1e9
d['detector_nep'] = 1e-30
d['photon_noise'] = True
TOD, maps_convolved = si.create_TOD(d, p, x0)

```

```{python}
plot(p.elevation, TOD[0,:], ',')
from qubic import fibtools as ft
x,y,dx,dy,_ = ft.profile(p.elevation, TOD[0,:], dispersion=True)
```

```{python}
plot(x,dy)
```

```{python}
el = np.linspace(30,70,100)
airmass = 1./np.cos(np.radians(el))
airmass_50 = 1./np.cos(np.radians(50))
plot(el, np.sqrt(airmass/airmass_50))
```

```{python}
q = qubic.QubicInstrument(d)
```

```{python}
print(q.detector.efficiency)
```

```{python}

```
