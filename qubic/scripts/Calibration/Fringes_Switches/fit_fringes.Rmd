---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.4.0
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

## Fit the fringe measurements

```{python}
from __future__ import division, print_function

# %matplotlib inline
import matplotlib
matplotlib.use('nbagg')

import glob
import numpy as np
import matplotlib.pyplot as plt
import scipy.optimize as sop
import pandas as pd
from matplotlib.backends.backend_pdf import PdfPages
import scipy.optimize as sop

import qubic
from qubic import selfcal_lib as scal
from qubicpack.utilities import Qubic_DataDir
from qubic import fringes_lib as fl

import qubic.fibtools as ft
```

## Get the measurement

```{python}
global_dir = '/home/lmousset/QUBIC/Qubic_work/Calibration/datas/Fringes/'
myfringes = 'Fringes_2020-10-27_TypeEq0_with_10BLs.fits'
#'Fringes_2020-10-27_TypeEq2_with_2BLs.fits'

header, fdict = fl.read_fits_fringes(global_dir + myfringes)
print(fdict.keys())

nBLs = header['NBLS']
BLs_eq = fdict['BLS-EQ']
print(BLs_eq)
```

```{python}
# Make a QUBIC instrument
basedir = Qubic_DataDir(datafile='instrument.py', )
dictfilename = basedir + '/dicts/global_source_oneDet.dict'
d = qubic.qubicdict.qubicDict()
d.read_from_file(dictfilename)
q = qubic.QubicInstrument(d)


# Horn array with all baselines
plt.figure(figsize=(6, 6))
scal.plot_horns(q)
for i in range(nBLs):
    scal.plot_baseline(q, BLs_eq[i])

# Plot fringes on the FP
BL_index = 0
fl.plot_fringes_onFP(q, BL_index, header, fdict)

# Plot folded signal and the fit for one TES 
TES = 95
fl.plot_folded_fit(TES, BL_index, header, fdict)

```

```{python}
x = fdict['X_TES']
y = fdict['Y_TES']
data = fdict['COMBINATION'][BL_index]

x, y, data = fl.remove_thermometers(x, y, data)

print(data.shape)
```

```{python}
fdict.keys()
```

## Fringes models

```{python}
baseline = fdict['BLS-EQ'][BL_index]
print(baseline)
```

### QUBIC soft simulation

```{python}
Model_QS = scal.Model_Fringes_QubicSoft(q, baseline,
                                        theta_source=np.array([0.]), phi_source=np.array([0.]),
                                        nu_source=150e9, spec_irrad_source=1.,
                                        frame='ONAFP',)

rc('figure', figsize=(12, 6))
xONAFP, yONAFP, fringes = Model_QS.get_fringes(doplot=True, verbose=True, norm=None, s=100)

print('fringes shape:', fringes.shape)
```

### Maynooth simu

```{python}
# Path to the simulated files 
rep = Qubic_DataDir(datafile='detcentres.txt', datadir='/home/lmousset/QUBIC/')
print('rep:', rep)

Model_Maynooth = scal.Model_Fringes_Maynooth(q, baseline, rep, 
                                             theta_source=np.array([0.]), nu_source=150e9,
                                             frame='ONAFP', interp=False)

xONAFP, yONAFP, fringes = Model_Maynooth.get_fringes(verbose=True)

plt.figure()
scal.scatter_plot_FP(q, xONAFP, yONAFP, fringes, s=None, 
                       frame='ONAFP', 
                       title='Maynooth at TES resolution', 
                       norm=None)
```

### Analytical function

```{python}
theta_deg = 0.
Model_Ana = scal.Model_Fringes_Ana(q, baseline, theta_source=np.deg2rad(theta_deg), nu_source=150e9, fwhm=20., amp=1., frame='ONAFP')
print(Model_Ana.focal)

xONAFP, yONAFP, fringes = Model_Ana.get_fringes(times_gaussian=True)

plt.figure()
scal.scatter_plot_FP(q, xONAFP, yONAFP, fringes, frame='ONAFP')

```

# Start fitting

```{python}
def get_chi2(params, invcov, data, **kwargs):
    
    focal, theta_source = params
    
    q.optics.focal_length = focal
    model = scal.Model_Fringes_Ana(q, baseline, 
                                    theta_source=theta_source, 
                                    nu_source=150e9, 
                                    fwhm=20., amp=1., frame='ONAFP')
    
    x, y, Phi = model.get_fringes(**kwargs)
    print(Phi.shape)
    
#     ndet = len(data)
#     A = np.zeros_like(Phi)
#     for idet in range(ndet):
#         sigma_A = 1. / (Phi[idet].T * invcov[idet, idet] * Phi[idet])
#         A[idet] = sigma_A * Phi[idet].T * invcov[idet, idet] * data[idet]
        
    R = Phi - data
    chi2 = R.T @ invcov @ R 
    return chi2
    
```

```{python}
# fake data
focal_data = 0.27
theta_data = 0.

q.optics.focal_length = focal_data
model_fake_data = scal.Model_Fringes_Ana(q, baseline, 
                                theta_source=theta_data, 
                                nu_source=150e9, 
                                fwhm=20., amp=1., frame='ONAFP')

x, y, fake_fringes = model_fake_data.get_fringes(times_gaussian=False)

gain = np.ones_like(fake_fringes)
# gain = np.random.rand(fake_fringes.shape[0]) * 10
fake_fringes *= gain

plt.figure()
scal.scatter_plot_FP(q, xONAFP, yONAFP, fake_fringes, frame='ONAFP')

```

```{python}
invcov = np.identity(fake_fringes.shape[0])
invcov = np.diag(np.random.rand(fake_fringes.shape[0]) * 100)
```

```{python}
params = [0.27, 0.]
chi2 = get_chi2(params, invcov, fake_fringes, times_gaussian=True)
print(chi2)
```

```{python}
result = sop.minimize(get_chi2, x0=[0.3, 0.], args=(invcov, data), method="CG", tol=None)
```

```{python}
result
```

```{python}

```

```{python}

```

```{python}

```
