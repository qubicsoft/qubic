---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.1'
      jupytext_version: 1.2.1
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

# Synthetic beam on the focal plane
Edited by Louise 

Using data from 2019-04-06, scan at 150GHz

```{python}
from __future__ import division, print_function

# %matplotlib inline
# %matplotlib notebook
# import mpld3
# mpld3.enable_notebook()

import numpy as np
import matplotlib.pyplot as plt
import matplotlib.animation as animation
from IPython.display import HTML

from qubicpack.utilities import Qubic_DataDir
import qubicpack as qp
from qubicpack.pixel_translation import make_id_focalplane, plot_id_focalplane

import qubic.fibtools as ft
import qubic.sb_fitting as sbfit
import qubic.selfcal_lib as sc

import matplotlib.animation as animation
from IPython.display import HTML
```

```{python}
# plot style so figures are more readable. Hopefully
plt.rcParams['figure.figsize'] = (8, 6)
plt.rcParams['font.size'] = 10
plt.rcParams['lines.linewidth'] = 3
plt.rcParams['xtick.labelsize'] = 14
plt.rcParams['ytick.labelsize'] = 14
plt.rcParams['axes.labelsize'] = 15
plt.rcParams['axes.titlesize'] = 15
plt.rcParams['legend.fontsize'] = 14
```

```{python}

```

```{python}
# Get the data
rep = Qubic_DataDir(datafile='allFitSB.pdf')
print(rep)

all_tes_sig = []
for tes in range(1, 257):
    themap, az, el, fitmap, newxxyy = sbfit.get_flatmap(tes, rep, fitted_directory=rep+'/FitSB')
    if tes == 93: 
        print(themap.shape)
        plt.imshow(themap)
        
    all_tes_sig.append((fitmap[71, :])/np.sum(fitmap))    
#     all_tes_sig.append(np.ravel(themap))
    
all_tes_sig = np.array(all_tes_sig)
print(all_tes_sig.shape)
```

```{python}
(ntes, nsamples) = np.shape(all_tes_sig)
print(ntes, nsamples)
```

```{python}
j=0
for i in range(nsamples):
    if np.all(all_tes_sig[:, i])==0.:
        j+=1
        print(i)
print(j)
```

```{python}
# Remove Bad TES
bad_TES = [1, 2, 3, 4, 8, 11, 14, 15, 20, 21, 25, 29, 30, 33, 35, 39, 40, 47, 48, 53, 55, 56, 63, 
           70, 78, 84, 85, 89, 91, 92, 97, 102, 103, 112, 116, 119, 121, 126, 128, 132, 139, 143, 
           144, 145, 146, 147, 148, 155, 156, 174, 178, 179, 187, 190, 202, 211, 217, 221, 227, 228,
          230, 234, 238, 240, 241, 242, 243, 245, 249, 253, 254]
print(len(bad_TES))
for i in bad_TES:
    all_tes_sig[i-1, :] = np.nan
    all_newxxyy[i-1, :, :] = np.nan
```

```{python}
# TEST to check if TES are at the right place
all_tes_sig[28+128, :] = 1.e7
all_tes_sig[62+128, :] = 1.e7
```

### Image on the focal plane

```{python}
signal = np.empty((128, 2, nsamples))
signal[:, 0, :] = all_tes_sig[:128, :]
signal[:, 1, :] = all_tes_sig[128:, :]
```

```{python}
all_quart_fp = []
for i in range(35, 170):
    image_fp = sc.tes_signal2image_fp(signal[:, :, i], [1, 2])
    _, quart_fp = sc.get_real_fp(image_fp, quadrant=3)
    plt.imshow(quart_fp, vmin=0, vmax=0.003)
    plt.title(i)
    #plt.colorbar()
    plt.pause(0.05)
```

### Normalize using meancut in fibtools

```{python}
mean, std = zip(*[ft.meancut(all_tes_sig[i, :], nsig=3) for i in range(ntes)])
```

```{python}
all_tes_sig_norm = np.ones_like(all_tes_sig)
for i in range(ntes):
    #all_tes_sig_norm[i, :] = (all_tes_sig[i, :] - mean[i])/ std[i]    
    all_tes_sig_norm[i, :] = all_tes_sig[i, :]
```

```{python}
plot(all_tes_sig_norm[36,:])
```

```{python}
all_quart_fp = []
fig = plt.figure()
for i in range(10000, 10200):
    image_fp = sc.tes_signal2image_fp(signal[:, :, i], [1, 2])
    _, quart_fp = sc.get_real_fp(image_fp, quadrant=3)
    
    im = plt.imshow(quart_fp, animated=True)
    all_quart_fp.append([im])


ani = animation.ArtistAnimation(fig, all_quart_fp, interval=1000, repeat=False)

# Show the animation
HTML(ani.to_html5_video())

# Save the animation 
# ani.save('Synthetic_beam_FP.mp4')
```

```{python}
1
```

```{python}

```
