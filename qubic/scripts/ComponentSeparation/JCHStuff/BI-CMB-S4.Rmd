---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.4.1
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

```{python}
import s4bi
from importlib import reload
from scipy import constants
from astropy.cosmology import Planck15
rc('figure',figsize=(16,4))
rc('font',size=12)


```

# CMB-S4 Description

```{python}
subplot(1,2,1)
errorbar(s4bi.s4_config['frequency'], s4bi.s4_config['depth_p'], xerr=s4bi.s4_config['bandwidth']/2, fmt='ro')
xlabel('Frequency [GHz]')
ylabel(r'Depth_p [$\mu$K.arcmin]')
title('CMB-S4 Configuration')
subplot(1,2,2)
errorbar(s4bi.s4_config['frequency'], s4bi.s4_config['fwhm'], xerr=s4bi.s4_config['bandwidth']/2, fmt='ro')
xlabel('Frequency [GHz]')
ylabel('FWHM [arcmin]')
title('CMB-S4 Configuration')
```

# QUBIC+ Description

```{python}
reload(s4bi)
# QUBIC+
qp_nsub = np.array([5, 5, 5, 5, 5, 5, 5, 5, 5, 5])
qp_effective_fraction = np.array([1., 1., 1., 1., 1., 1., 1., 1., 1.])

qp_config = s4bi.qubicify(s4bi.s4_config, qp_nsub, qp_effective_fraction)
print(qp_config['frequency'])
print(qp_config['depth_p'])
print(qp_config['bandwidth'])
    
subplot(1,2,1)
errorbar(s4bi.s4_config['frequency'], s4bi.s4_config['depth_p'], xerr=s4bi.s4_config['bandwidth']/2, fmt='ro', label='CMB-S4')
errorbar(qp_config['frequency'], qp_config['depth_p'], xerr=qp_config['bandwidth']/2, fmt='bo', label='BI')
xlabel('Frequency [GHz]')
ylabel(r'Depth_p [$\mu$K.arcmin]')
title('CMB-S4 Configuration')
legend()
subplot(1,2,2)
errorbar(s4bi.s4_config['frequency'], s4bi.s4_config['fwhm'], xerr=s4bi.s4_config['bandwidth']/2, fmt='ro', label='CMB-S4')
errorbar(qp_config['frequency'], qp_config['fwhm'], xerr=qp_config['bandwidth']/2, fmt='bo', label='BI')
xlabel('Frequency [GHz]')
ylabel('FWHM [arcmin]')
title('CMB-S4 Configuration')
legend()
```

# Component maps

```{python}
reload(s4bi)
components = ['c1', 'd0', 's0']
ref_freqs = [150., 353., 70.]
fsky = 0.03
nside = 256
radec_center = [0, -57]
center = qubic.equ2gal(radec_center[0], radec_center[1])

map_CMB, map_dust_353GHz, map_sync_70GHz = s4bi.get_component_maps(components, ref_freqs, nside, fsky)

```

```{python}
stokes = ['I', 'Q', 'U', 'P']
okpix = map_CMB[0,:] != hp.UNSEEN

m_sync_70GHz = np.mean(map_sync_70GHz[:,okpix], axis=1)
s_sync_70GHz = np.std(map_sync_70GHz[:,okpix], axis=1)

m_dust_353GHz = np.mean(map_dust_353GHz[:,okpix], axis=1)
s_dust_353GHz = np.std(map_dust_353GHz[:,okpix], axis=1)

m_CMB = np.mean(map_CMB[:,okpix], axis=1)
s_CMB = np.std(map_CMB[:,okpix], axis=1)


for c in components:
    figure()
    for istk in range(4):
        hp.gnomview(map_sync_70GHz[istk,:], rot=center, reso=15, 
                    title='Synchrotron '+stokes[istk]+' at 70 GHz ($\mu$K$_{CMB}$)'+'\n {0:5.2g}+/-{1:5.2g}'.format(m_sync_70GHz[istk], s_sync_70GHz[istk]), sub=(1,4,istk+1))

figure()    
for istk in range(4):
    hp.gnomview(map_dust_353GHz[istk,:], rot=center, reso=15, 
                title='Dust '+stokes[istk]+' at 353 GHz ($\mu$K$_{CMB}$)'+'\n {0:5.2g}+/-{1:5.2g}'.format(m_dust_353GHz[istk], s_dust_353GHz[istk]), sub=(1,4,istk+1))

figure()    
for istk in range(4):
    hp.gnomview(map_CMB[istk,:], rot=center, reso=15, 
                title='CMB '+stokes[istk]+' ($\mu$K$_{CMB}$)'+'\n {0:5.2g}+/-{1:5.2g}'.format(m_CMB[istk], s_CMB[istk]), sub=(1,4,istk+1))


```

# Component Models

FGBuster gives components scaled to 1 at their respective reference frequencies. We have added a double-beta component model.

```{python}
rc('figure',figsize=(16,8))
rc('font',size=12)

import fgbuster
from fgbuster import CMB, Dust, Synchrotron, AnalyticComponent, ModifiedBlackBody

dust_ref_freq = 353.
sync_ref_freq = 70.
dust = Dust(dust_ref_freq, beta_d=1.6, temp=20)
cmb = CMB() 
sync = Synchrotron(sync_ref_freq, beta_pl=-3)

### The double beta component model
dbdust = AnalyticComponent(analytic_expr, nu0=353, temp=20., h_over_k=constants.h * 1e9 / constants.k)
print(dbdust.params)   # parameters are beta0, beta1 and nubreak
# let's fix the params for now
beta0 = 1.3
beta1 = 1.54
nubreak = 200.

numin = 20
numax = 400
nnu = 1000
nus = np.linspace(numin, numax, nnu)

plot(nus, dust.eval(nus), label='Dust')
plot(nus, sync.eval(nus), label='Synchrotron')
plot(nus, cmb.eval(nus), label='CMB')
plot(nus, dbdust.eval(nus, beta0, beta1, nubreak), 
     label='Double Beta Dust with beta_0={}, beta_1={}, nubreak={}'.format(beta0, beta1, nubreak))
xlabel('Frequency [GHz]')
ylabel('SED')
yscale('log')
xscale('log')
legend()
title('All normalized to 1 at a ref frequency')
```

Now we use the normalization (RMS) found from PYSM in our region ito scale them:

```{python}
mystk = [0,3]

ii=0
for istk in mystk:
    subplot(1,2,ii+1)
    ii+=1
    plot(nus, dust.eval(nus) * s_dust_353GHz[istk], label='Dust')
    plot(nus, sync.eval(nus) * s_sync_70GHz[istk], label='Synchrotron')
    plot(nus, cmb.eval(nus) * s_CMB[istk], label='CMB')
    plot(nus, dbdust.eval(nus, 1.3, 1.54, 200) * s_dust_353GHz[istk], label='Double Beta Dust with beta_0={}, beta_1={}, nubreak={}'.format(beta0, beta1, nubreak))
    xlabel('Frequency [GHz]')
    ylabel(r'SED [$\mu K_{CMB}$]')
    yscale('log')
    xscale('log')
    title('Stokes '+stokes[istk]+' in clean QUBIC region {}%'.format(fsky*100))
    legend()
tight_layout()
```

```{python}
2*np.pi/(2.35**2)
```

```{python}

```

```{python}

```
