---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.4.1
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

```{python}
from importlib import reload
rc('figure',figsize=(16,4))
rc('font',size=12)


```

# CMB-S4 Description

```{python}
# # CMB-S4
# # https://indico.cmb-s4.org/event/3/attachments/5/51/PBDR_v0.1.pdf Page 80 (SAT)
# freqs = np.array([30., 40., 85., 145., 95., 155., 220., 270.])
# fwhm = np.array([72.8, 72.8, 25.5, 25.5, 22.7, 22.7, 13, 13])
# dnu_nu = np.array([0.3, 0.3, 0.24, 0.22, 0.24, 0.22, 0.22, 0.22])
# net = np.array([177., 224., 270., 309., 238., 331., 747., 1281.])  #muk.sqrt(s)
# ndet = np.array([576, 576, 21144, 21144, 21144, 21144, 33752, 33752])

# CMB-S4 - private comm from Josquin (unofficial)
#7 years - 12 tubes - nominal 3% sky coverage
freqs = np.array([20., 30., 40., 85., 95., 145., 155., 220., 270.])
bandwidth = np.array([5., 9., 12., 20.4, 22.8, 31.9, 34.1, 48.4, 59.4])
dnu_nu = bandwidth/freqs
beam_fwhm = np.array([11., 72.8, 72.8, 25.5, 25.5, 22.7, 22.7, 13., 13.])
mukarcmin_TT = np.array([16.5, 9.36, 11.85, 2.02, 1.78, 3.89, 4.16, 10.15, 17.4])
mukarcmin_EE = np.array([10.87, 6.2, 7.85, 1.34, 1.18, 1.8, 1.93, 4.71, 8.08])
mukarcmin_BB = np.array([10.23, 5.85, 7.4, 1.27, 1.12, 1.76, 1.89, 4.6, 7.89])
ell_min = np.array([30, 30, 30, 30, 30, 30, 30, 30, 30])
nside = np.array([512, 512, 512, 512, 512, 512, 512, 512, 512])
edges_min = freqs * (1. - dnu_nu/2)
edges_max = freqs * (1. + dnu_nu/2)
edges = [[edges_min[i], edges_max[i]] for i in range(len(freqs))]

s4_config = {
    'nbands': len(freqs),
    'frequency': freqs,
    'depth_p': 0.5*(muk_arcmin_EE + muk_arcmin_BB),
    'depth_i': mukarcmin_TT,
    'depth_e': mukarcmin_EE,
    'depth_b': mukarcmin_BB,
    'fwhm': beam_fwhm,
    'bandwidth': bandwidth,
    'dnu_nu': dnu_nu,
    'ell_min': ell_min,
    'nside': nside,
    'fsky': 0.03,
    'ntubes': 12,
    'nyears': 7.,
    'edges': edges,
    'effective_fraction': np.zeros(len(freqs))+1.
            }


for k in s4_config.keys():
    print('{}: {}'.format(k,s4_config[k]))

subplot(1,2,1)
errorbar(s4_config['frequency'], s4_config['depth_p'], xerr=s4_config['bandwidth']/2, fmt='ro')
xlabel('Frequency [GHz]')
ylabel(r'Depth_p [$\mu$K.arcmin]')
title('CMB-S4 Configuration')
subplot(1,2,2)
errorbar(s4_config['frequency'], s4_config['fwhm'], xerr=s4_config['bandwidth']/2, fmt='ro')
xlabel('Frequency [GHz]')
ylabel('FWHM [arcmin]')
title('CMB-S4 Configuration')
```

# QUBIC+ Description

```{python}
### QUBIC Sub-optimality : values from Louise Mousset's PhD thesis
def fct_subopt(nus):
    subnus = [150., 220]
    subval = [1.4, 1.2]
    fct_subopt = poly1d(polyfit(subnus, subval, 1))
    return fct_subopt(nus)

plot(subnus, subval, 'ro',label='QUBIC End2End')
plot(s4_config['frequency'], fct_subopt(s4_config['frequency']),'k.-', label='CMB-S4 extrapolation')
xlabel('Frequency [GHz]')
ylabel('Sub-optimality for Spectral Imaging')
legend()
```

```{python}
def qubicify(config, qp_nsubs, qp_effective_fraction):
    nbands = np.sum(qp_nsubs)
    qp_config = config.copy()
    for k in qp_config.keys():
        qp_config[k]=[]
    qp_config['nbands'] = nbands
    qp_config['fsky'] = config['fsky']
    qp_config['ntubes'] = config['ntubes']
    qp_config['nyears'] = config['nyears']
    qp_config['initial_band'] = []
    
    for i in range(len(config['frequency'])):
        newedges = np.linspace(config['edges'][i][0], config['edges'][i][1], qp_nsubs[i]+1)
        newfreqs = (newedges[0:-1]+newedges[1:])/2
        newbandwidth = newedges[1:] - newedges[0:-1]
        newdnu_nu = newbandwidth / newfreqs
        newfwhm = config['fwhm'][i] * config['frequency'][i]/newfreqs
        scalefactor_noise = np.sqrt(qp_nsubs[i]) * fct_subopt(config['frequency'][i]) / qp_effective_fraction[i]
        newdepth_p = config['depth_p'][i] * np.ones(qp_nsub[i]) * scalefactor_noise
        newdepth_i = config['depth_i'][i] * np.ones(qp_nsub[i]) * scalefactor_noise
        newdepth_e = config['depth_e'][i] * np.ones(qp_nsub[i]) * scalefactor_noise
        newdepth_b = config['depth_b'][i] * np.ones(qp_nsub[i]) * scalefactor_noise
        newell_min = np.ones(nsub[i]) * config['ell_min'][i]
        newnside = np.ones(nsub[i]) * config['nside'][i]
        neweffective_fraction = np.ones(nsub[i]) * qp_effective_fraction[i]
        initial_band = np.ones(nsub[i]) * config['frequency'][i]
        
        for k in range(qp_nsubs[i]):
            if qp_effective_fraction[i] != 0:
                qp_config['frequency'].append(newfreqs[k])
                qp_config['depth_p'].append(newdepth_p[k])
                qp_config['depth_i'].append(newdepth_i[k])
                qp_config['depth_e'].append(newdepth_e[k])
                qp_config['depth_b'].append(newdepth_b[k])
                qp_config['fwhm'].append(newfwhm[k])
                qp_config['bandwidth'].append(newbandwidth[k])
                qp_config['dnu_nu'].append(newdnu_nu[k])
                qp_config['ell_min'].append(newell_min[k])
                qp_config['nside'].append(newnside[k])
                qp_config['edges'].append(newedges[k])
                qp_config['effective_fraction'].append(neweffective_fraction[k])
                qp_config['initial_band'].append(initial_band[k])
    
    fields = ['frequency', 'depth_p', 'depth_i', 'depth_e', 'depth_b', 'fwhm', 'bandwidth', 
              'dnu_nu', 'ell_min', 'nside', 'edges', 'effective_fraction', 'initial_band']
    for j in range(len(fields)):
        qp_config[fields[j]] = np.array(qp_config[fields[j]])
        
    return qp_config

        
# for k in qp_config.keys():
#     print('{}: {}'.format(k,qp_config[k]))

# QUBIC+
qp_nsub = np.array([5, 5, 5, 5, 5, 5, 5, 5, 5, 5])
qp_effective_fraction = np.array([1., 1., 1., 1., 1., 1., 1., 1., 1.])

qp_config = qubicify(s4_config, qp_nsub, qp_effective_fraction)
print(qp_config['frequency'])
print(qp_config['depth_p'])
print(qp_config['bandwidth'])
    
subplot(1,2,1)
errorbar(s4_config['frequency'], s4_config['depth_p'], xerr=s4_config['bandwidth']/2, fmt='ro', label='CMB-S4')
errorbar(qp_config['frequency'], qp_config['depth_p'], xerr=qp_config['bandwidth']/2, fmt='bo', label='BI')
xlabel('Frequency [GHz]')
ylabel(r'Depth_p [$\mu$K.arcmin]')
title('CMB-S4 Configuration')
legend()
subplot(1,2,2)
errorbar(s4_config['frequency'], s4_config['fwhm'], xerr=s4_config['bandwidth']/2, fmt='ro', label='CMB-S4')
errorbar(qp_config['frequency'], qp_config['fwhm'], xerr=qp_config['bandwidth']/2, fmt='bo', label='BI')
xlabel('Frequency [GHz]')
ylabel('FWHM [arcmin]')
title('CMB-S4 Configuration')
legend()
```

# Foreground Models

```{python}
rc('figure',figsize=(16,8))
rc('font',size=12)

import fgbuster
from fgbuster import CMB, Dust, Synchrotron, AnalyticComponent, ModifiedBlackBody

#### Components
dust_ref_freq = 353.
sync_ref_freq = 70.
dust = Dust(dust_ref_freq, beta_d=1.6, temp=20)
cmb = CMB() 
sync = Synchrotron(sync_ref_freq, beta_pl=-3)

numin = np.min(qp_config['edges'])
numax = np.max(qp_config['edges'])
nnu = 1000
nus = np.linspace(numin, numax, nnu)

plot(nus, dust.eval(nus), label='Dust')
plot(nus, sync.eval(nus), label='Synchrotron')
plot(nus, cmb.eval(nus), label='CMB')
xlabel('Frequency [GHz]')
ylabel('SED')
yscale('log')
xscale('log')
legend()
title('All normalized to 1 at a ref frequency')
```

```{python}

myref = 200
dust = Dust(myref, temp=20)
print(dust.params)

numin = np.min(qp_config['edges'])
numax = np.max(qp_config['edges'])
nnu = 1000
nus = np.linspace(numin, numax, nnu)

plot(nus, dust.eval(nus, 1.9), label='Dust')
plot(nus, dust.eval(nus, 1.2), label='Dust')

```

# Realistic amplitudes

```{python}
import pysm3
import pysm3.units as u
import healpy as hp
import numpy as np
import warnings
warnings.filterwarnings("ignore")

import qubic
center = qubic.equ2gal(0., -57.)

sky_cmb = pysm3.Sky(nside=256, preset_strings=['c1'])
sky_dust = pysm3.Sky(nside=256, preset_strings=['d0'])
sky_sync = pysm3.Sky(nside=256, preset_strings=['s0'])
sky = pysm3.Sky(nside=256, preset_strings=['c1', 'd0', 's0'])

```

```{python}
# Mask
fsky = 0.03
uvcenter = np.array(hp.ang2vec(center[0], center[1], lonlat=True))
uvpix = np.array(hp.pix2vec(256, np.arange(12*256**2)))
ang = np.arccos(np.dot(uvcenter, uvpix))
indices = np.argsort(ang)
okpix = ang < -1
okpix[indices[0:int(fsky * 12*256**2)]] = True
mask = np.zeros(12*256**2)
mask[okpix] = 1

hp.gnomview(mask, rot=center, reso=15)
hp.mollview(mask)
```

```{python}
map_sync_70GHz[0:2,:].shape
```

```{python}
map_sync_70GHz = np.zeros((4, 12*256**2))
map_sync_70GHz[0:3,:] = sky_sync.get_emission(sync_ref_freq * u.GHz).to(u.uK_CMB, equivalencies=u.cmb_equivalencies(70*u.GHz))
map_sync_70GHz[3,:] = np.sqrt(map_sync_70GHz[1,:]**2 + map_sync_70GHz[2,:]**2)
map_sync_70GHz[:, ~okpix] = hp.UNSEEN

map_dust_353GHz = np.zeros((4, 12*256**2))
map_dust_353GHz[0:3,:] = sky_dust.get_emission(dust_ref_freq * u.GHz).to(u.uK_CMB, equivalencies=u.cmb_equivalencies(353*u.GHz))
map_dust_353GHz[3,:] = np.sqrt(map_dust_353GHz[1,:]**2 + map_dust_353GHz[2,:]**2)
map_dust_353GHz[:, ~okpix] = hp.UNSEEN

map_CMB = np.zeros((4, 12*256**2))
map_CMB[0:3,:] = sky_cmb.get_emission(150 * u.GHz).to(u.uK_CMB, equivalencies=u.cmb_equivalencies(150*u.GHz))
map_CMB[3,:] = np.sqrt(map_CMB[1,:]**2 + map_CMB[2,:]**2)
map_CMB[:, ~okpix] = hp.UNSEEN

m_sync_70GHz = np.mean(map_sync_70GHz[:,okpix], axis=1)
s_sync_70GHz = np.std(map_sync_70GHz[:,okpix], axis=1)

m_dust_353GHz = np.mean(map_dust_353GHz[:,okpix], axis=1)
s_dust_353GHz = np.std(map_dust_353GHz[:,okpix], axis=1)

m_CMB = np.mean(map_CMB[:,okpix], axis=1)
s_CMB = np.std(map_CMB[:,okpix], axis=1)

stokes = ['I', 'Q', 'U', 'P']
figure()
for istk in range(4):
    hp.gnomview(map_sync_70GHz[istk,:], rot=center, reso=15, 
                title='Synchrotron '+stokes[istk]+' at 70 GHz ($\mu$K$_{CMB}$)'+'\n {0:5.2g}+/-{1:5.2g}'.format(m_sync_70GHz[istk], s_sync_70GHz[istk]), sub=(1,4,istk+1))

figure()    
for istk in range(4):
    hp.gnomview(map_dust_353GHz[istk,:], rot=center, reso=15, 
                title='Dust '+stokes[istk]+' at 353 GHz ($\mu$K$_{CMB}$)'+'\n {0:5.2g}+/-{1:5.2g}'.format(m_dust_353GHz[istk], s_dust_353GHz[istk]), sub=(1,4,istk+1))

figure()    
for istk in range(4):
    hp.gnomview(map_CMB[istk,:], rot=center, reso=15, 
                title='CMB '+stokes[istk]+' ($\mu$K$_{CMB}$)'+'\n {0:5.2g}+/-{1:5.2g}'.format(m_CMB[istk], s_CMB[istk]), sub=(1,4,istk+1))


```

```{python}
mystk = [0,3]

ii=0
for istk in mystk:
    subplot(1,2,ii+1)
    ii+=1
    plot(nus, dust.eval(nus) * s_dust_353GHz[istk], label='Dust')
    plot(nus, sync.eval(nus) * s_sync_70GHz[istk], label='Synchrotron')
    plot(nus, cmb.eval(nus) * s_CMB[istk], label='CMB')
    xlabel('Frequency [GHz]')
    ylabel(r'SED [$\mu K_{CMB}$]')
    yscale('log')
    xscale('log')
    title('Stokes '+stokes[istk]+' in clean QUBIC region {}%'.format(fsky*100))
    legend()
tight_layout()
```

```{python}

```

```{python}
from fgbuster import AnalyticComponent
from sympy import Heaviside

analytic_expr = ('Heaviside(nu)*(nu/nu0)**beta_d')


test = AnalyticComponent(analytic_expr, nu0=150)
print(test.params)

xxx = np.linspace(100,200, 1000)
plot(xxx, test.eval(xxx, 1.54))

```

```{python}

```

```{python}

```

```{python}
from fgbuster import AnalyticComponent


#toto = lambda a : a + 10


#analytic_expr = ('(nu/nu0)**beta_d + toto(nu)')

#"IF(d == 0, 0, IF(d == 1, 1, 2))"
#analytic_expr = ('IF(nu<150, (nu/nu0)**beta_d, 1)')

analytic_expr = ('(nu/nu0)**beta_d')
#analytic_expr = ('0 if nu<150 else 1')

test = AnalyticComponent(analytic_expr, nu0=150)
print(test.params)

xxx = np.linspace(100,200, 1000)
plot(xxx, test.eval(xxx, 1.54))

```

```{python}

```

```{python}
from sympy.parsing.sympy_parser import parse_expr
x_str = "IF(c < 1, 0, 1)"
# c_str = "IF(d == 0, 0, IF(d == 1, 1, 2))"
c_str = "IF(d == 0, 0, 1)"
x = parse_expr(x_str)
c = parse_expr(c_str)
d = {"x": x, "c": c}
print("local dict:")
print(d)
x = parse_expr(x_str, local_dict=d)
c = parse_expr(c_str, local_dict=d)
```

```{python}
analytic_expr = ('(nu/nu0)**beta_d if nu<150 else 1')
truc = parse_expr(analytic_expr, local_dict={'nu':100, 'beta_d':1.54})
truc
```

```{python}

```
