---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.4.1
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

```{python}
import pysm3
import pysm3.units as u
import numpy as np
import numpy.ma as ma
import healpy as hp
import pickle
import matplotlib.pyplot as plt
from matplotlib.ticker import FuncFormatter
import pickle
from astropy.io import fits
import pandas as pd
from importlib import reload
from datetime import datetime

import warnings

warnings.filterwarnings("ignore")

import qubic
from qubic import NamasterLib as nam

center = qubic.equ2gal(0, -57)

rc('figure', figsize=(16, 10))
rc('font', size=15)

```

# Pumping

```{python}
# download the file from qubic-central
os.system("rsync -avzu qubicremoteAR:/home/qubic/data/temperature/broadcast/PRESSURE1.txt .")
```

```{python}
# read it
sec_read, press = np.loadtxt('PRESSURE1.txt', comments='\x00').T #seconds are in UTC time 
sec = sec_read.copy()

# t0
t0=datetime(2021, 8, 17, 0, 0, 0, 0)
t0_sec = t0.timestamp()
print('Zero time:',t0,t0_sec)

sec -= t0_sec
hours = sec/3600
```

```{python}

# # Fitting the last N minutes
# N=5
# okfit = (sec[-1]-sec) <= (N*60)


# hh = int(hours[-1])
# mm = int((hours[-1]-hh)*60)
# print(hh,mm)

# title('Last update {}:{:02d} - Pressure: {:3.1e} mb'.format(hh,mm,press[-1]))
# plot(hours,press, label='Data')
# plot(hours[okfit], press[okfit],'r', label='Data (5 last minutes)')
# xlabel('Time in hours (Argentinean)')
# ylabel('Pressure (mB)')
# ylim(1e-3, 1e2)
# yscale('log')
# grid()

# a = np.polyfit(hours[okfit], np.log10(press[okfit]), 1)
# print(a)
# xxx = np.linspace(hours[okfit][-1],20, 1000)
# plot(xxx, 10.**(a[1]+a[0]*(xxx)), 'k:', label='Extrapolation ({} last minutes)'.format(N))


# okPT = (10.**(a[1]+a[0]*(xxx))) < 0.01
# print(np.min(xxx[okPT]))

# hhPT = int(np.min(xxx[okPT]))
# mmPT = int((np.min(xxx[okPT])-hhPT)*60)
# axvline(x=np.min(xxx[okPT]), color='r', ls='--', label='Best guess for PT Start: {}:{:02d}'.format(hhPT,mmPT))

# xlim(9, np.min(xxx[okPT])+1)

# yscale('log')
# legend()



```

```{python}
date_ref = datetime(2021, 8, 31, 0, 0, 0, 0)
sec_ref = date_ref.timestamp()
hour_ref = (sec_ref - t0_sec)/3600
print('REF DATE: '+date_ref.strftime("%Y-%m-%d %H:%M"))

date_PUMP = datetime(2021, 8, 24, 8, 20, 0, 0)
sec_PUMP = date_PUMP.timestamp()
hour_PUMP = (sec_PUMP - t0_sec)/3600
print('PUMP DATE: '+date_PUMP.strftime("%Y-%m-%d %H:%M"))

date_PTC_ON = datetime(2021, 8, 24, 9, 10, 0, 0)
sec_PTC_ON = date_PTC_ON.timestamp()
hour_PTC_ON = (sec_PTC_ON - t0_sec)/3600
print('PTC ON: '+date_PTC_ON.strftime("%Y-%m-%d %H:%M"))

date_PUMP_BACK = datetime(2021, 8, 27, 9, 49, 0, 0)
sec_PUMP_BACK = date_PUMP_BACK.timestamp()
hour_PUMP_BACK = (sec_PUMP_BACK - t0_sec)/3600
print('PUMP_BACK: '+date_PUMP_BACK.strftime("%Y-%m-%d %H:%M"))

date_PTC_BACK = datetime(2021, 8, 27, 10, 6, 0, 0)
sec_PTC_BACK = date_PTC_BACK.timestamp()
hour_PTC_BACK = (sec_PTC_BACK - t0_sec)/3600
print('PTC_BACK: '+date_PTC_BACK.strftime("%Y-%m-%d %H:%M"))

```

```{python}
hh = int(hours[-1])
mm = int((hours[-1]-hh)*60)
print(hh,mm)

title('Last update {} : Pressure={}'.format(datetime.fromtimestamp(sec_read[-1]).strftime("%Y-%m-%d %H:%M"), press[-1]))
plot(hours-hour_ref,press,label='Data')
axvline(x=hour_PTC_ON-hour_ref, color='b', ls='--', label='PTC ON '+date_PTC_ON.strftime("%Y-%m-%d %H:%M"))
axvline(x=hour_PUMP-hour_ref, color='b', ls='--', label='Pump '+date_PUMP.strftime("%Y-%m-%d %H:%M"))
axvline(x=hour_PUMP_BACK-hour_ref,label='PUMP_BACK '+date_PUMP_BACK.strftime("%Y-%m-%d %H:%M"), color='k', ls='--')
axvline(x=hour_PTC_BACK-hour_ref,label='PTC_BACK '+date_PTC_BACK.strftime("%Y-%m-%d %H:%M"), color='k', ls='--')
xlabel('Time in hours since {} (French. Time)'.format(date_ref.strftime("%Y-%m-%d %H:%M")))
ylabel('Pressure (mB)')
yscale('log')
grid()
xlim(-100, np.max(hours-hour_ref)+1)
ylim (5e-7, 1e-4)
legend()


#xlim(35,36)
```

# Cooldown

```{python}
datanames_all = [['AVS47_1_ch0', 'Touch'],
['AVS47_1_ch1', '1K stage'],
['AVS47_1_ch2', 'TES stage'],
['AVS47_1_ch3', 'M1'],
['AVS47_1_ch4', '1K fridge CH'],
['AVS47_1_ch5', 'Film breaker'],
['AVS47_1_ch6', '0.3K fridge CH'],
['AVS47_1_ch7', 'M2'],
['AVS47_2_ch0', 'PT2 S2 CH'],
['AVS47_2_ch1', 'PT1 S2 CH'],
['AVS47_2_ch2', 'Fridge plate MHS'],
['AVS47_2_ch3', '1K HS'],
['AVS47_2_ch4', '4K shield Cu braids'],
['AVS47_2_ch5', 'AVS47_2 ch5'],
['AVS47_2_ch6', 'AVS47_2 ch6'],
['AVS47_2_ch7', 'AVS47_2 ch7'],
['TEMPERATURE01', '40K filters'],
['TEMPERATURE02', '40K sd'],
['TEMPERATURE03', '40K sr'],
['TEMPERATURE04', 'PT2 s1'],
['TEMPERATURE05', 'PT1 s1'],
['TEMPERATURE06', '4K filters'],
['TEMPERATURE07', 'HWP1'],
['TEMPERATURE08', 'HWP2'],
['TEMPERATURE09', '4K sd'],
['TEMPERATURE10', '4K PT2 CH'],
['TEMPERATURE11', 'PT1 s2'],
['TEMPERATURE12', 'PT2 s2'],
['TEMPERATURE13', '300mK-4CP-D-1'],
['TEMPERATURE14', '300mK-4HS-D-1'],
['TEMPERATURE15', '300mK-3CP-D-1'],
['TEMPERATURE16', '300mK-3HS-D-1'],
['TEMPERATURE17', '1K-4HS-D-1'],
['TEMPERATURE18', '1K-4CP-D-1'],
['PRESSURE1', 'PRESSURE']]

dn = np.array(datanames_all)
dnqubic = list(dn[:,0])
dnhuman = list(dn[:,1])
print(dnqubic)
print(dnhuman)
```

```{python}
### Update files
os.system("rsync -avzu qubicremoteAR:/home/qubic/data/temperature/broadcast/*.txt .")
```

```{python}
mydn_human = ['PRESSURE', '1K stage', 'TES stage', 'M1', '0.3K fridge CH', 'Fridge plate MHS',
            'PT2 S2 CH', 'PT1 S2 CH','PT2 s1']
mydn_qubic = []
for d in mydn_human:
    print(d, dnhuman[dnhuman.index(d)], dnqubic[dnhuman.index(d)])
    mydn_qubic.append(dnqubic[dnhuman.index(d)])

print(mydn_qubic)
```

```{python}
t0=datetime(2021, 8, 17, 0, 0, 0, 0)
t0_sec = t0.timestamp()
print('Zero time:',t0,t0_sec)

nn = 10000

dd = np.zeros((len(mydn_qubic), nn))
i = 0
for d in mydn_qubic:
    print(d)
    tt, val = np.loadtxt(d+'.txt', comments='\x00').T 
    print(d)
    tt -= t0_sec
    hours = tt/3600
    ok = hours > 0
    if i == 0:
        mini = np.min(hours[ok])
        maxi = np.max(hours[ok])
        mytime_init = np.linspace(mini, maxi, nn)
    dd[i,:] = np.interp(mytime_init, hours[ok], val[ok])
    i=i+1
```

```{python}
date_ref = datetime(2021, 9, 14, 12, 0, 0, 0)
sec_ref = date_ref.timestamp()
hour_ref = (sec_ref - t0_sec)/3600
print('REF DATE: '+date_ref.strftime("%Y-%m-%d %H:%M"))

date_PUMP = datetime(2021, 8, 24, 8, 20, 0, 0)
sec_PUMP = date_PUMP.timestamp()
hour_PUMP = (sec_PUMP - t0_sec)/3600
print('PUMP DATE: '+date_PUMP.strftime("%Y-%m-%d %H:%M"))

date_PTC_ON = datetime(2021, 8, 24, 9, 10, 0, 0)
sec_PTC_ON = date_PTC_ON.timestamp()
hour_PTC_ON = (sec_PTC_ON - t0_sec)/3600
print('PTC ON: '+date_PTC_ON.strftime("%Y-%m-%d %H:%M"))

date_PUMP_BACK = datetime(2021, 8, 27, 9, 49, 0, 0)
sec_PUMP_BACK = date_PUMP_BACK.timestamp()
hour_PUMP_BACK = (sec_PUMP_BACK - t0_sec)/3600
print('PUMP_BACK: '+date_PUMP_BACK.strftime("%Y-%m-%d %H:%M"))

date_PTC_BACK = datetime(2021, 8, 27, 10, 6, 0, 0)
sec_PTC_BACK = date_PTC_BACK.timestamp()
hour_PTC_BACK = (sec_PTC_BACK - t0_sec)/3600
print('PTC_BACK: '+date_PTC_BACK.strftime("%Y-%m-%d %H:%M"))

```

```{python}
rc('figure', figsize=(16, 10))
rc('font', size=15)

ispressure = 'PRESSURE' in mydn_human

# mytime -= hour_PTC_ON
mytime = mytime_init - hour_ref

ndays = int(np.max(mytime)/24)
for i in range(len(mydn_human)):
    if mydn_human[i]=='PRESSURE':
        subplot(2,1,2)
        ylabel('Pressure (mB)')
        yscale('log')
        ylim(5e-7, 1e-4)
        grid()
    else:
        subplot(2,1,1)
        ylabel('Temperature (K)')
        grid()
        ylim(0.1,5)
        yscale('log')
        axhline(y=0.3, color='k', ls='--')
        axhline(y=4, color='k', ls='--')
        
    plot(mytime, dd[i,:], label=mydn_human[i]+' ({})'.format(mydn_qubic[i]), lw=3)

for j in range(2):
    subplot(2,1,j+1)
    for i in range(ndays):
        axvline(x=i*24, ls=':', color='g')
    xlabel('Time in Hours since '+date_ref.strftime("%Y-%m-%d %H:%M") + ' (French. Time)')
    #xlim(-1,np.max(mytime))
    title(datetime.fromtimestamp(tt[-1]+t0_sec).strftime("%Y-%m-%d %H:%M"))
    #yscale('log')

    axvline(x=hour_PUMP-hour_ref,label='PUMP '+date_PUMP.strftime("%Y-%m-%d %H:%M"), color='k', ls='--')
    axvline(x=hour_PTC_ON-hour_ref,label='PTC ON '+date_PTC_ON.strftime("%Y-%m-%d %H:%M"), color='k', ls='--')
    axvline(x=hour_PUMP_BACK-hour_ref,label='PUMP_BACK '+date_PUMP_BACK.strftime("%Y-%m-%d %H:%M"), color='k', ls='--')
    axvline(x=hour_PTC_BACK-hour_ref,label='PTC_BACK '+date_PTC_BACK.strftime("%Y-%m-%d %H:%M"), color='k', ls='--')

    xlim(0, np.max(mytime)+1)
    legend(fontsize=10, loc='lower left')
tight_layout()

### Extrapolation
# hname = 'TES stage'
# tinterp_min = 10.
# mydd = dd[mydn_human.index(hname),:]
# ok = mytime >= (np.max(mytime)-tinterp_min/60)
# plot(mytime[ok], mydd[ok],'r.')

# a = np.polyfit(mytime[ok], mydd[ok], 1)
# print(a)
# xxx = np.linspace(mytime[-1],100,10000)
# #extrapot_vals = 
# plot(xxx, poly1d(a)(xxx), 'b:', label='Extrapolation ({} last minutes)'.format(tinterp_min))
# axhline(y=300,color='k', ls=':')
# target = 290.
# dmin = np.min(xxx[poly1d(a)(xxx) > target]) 
# print(dmin)
# print(int(dmin) % 24, int(((dmin-int(dmin))*60)))
# axvline(x=dmin, label='Reach {}K at {}h{}min'.format(target, int(dmin) % 24, int(((dmin-int(dmin))*60))))
# xlim(10,dmin+1)

#axhline(y=273.15, color='m', ls=':', label='0 Celsius')


```

```{python}

```

```{python}

```

```{python}

```
