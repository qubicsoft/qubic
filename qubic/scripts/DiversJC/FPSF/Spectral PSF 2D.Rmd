---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.4.1
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

Same as "Spectral PSF 1D" but with the 2D ideal synthesized beam.

```{python}
from matplotlib import rc
rc('figure',figsize=(16,8))
rc('font',size=12)
rc('text',usetex=False)

from qubicpack import qubicpack as qp
from qubicpack.utilities import Qubic_DataDir
import qubic

from pysimulators import FitsArray

import numpy as np
from matplotlib.pyplot import *
import matplotlib.mlab as mlab
import scipy.ndimage.filters as f
import glob
import string
import scipy.signal as scsig
from scipy import interpolate
import os
import healpy as hp
```

```{python}
### Synthesized beam
global_dir = Qubic_DataDir(datafile='instrument.py', datadir=os.environ['QUBIC_DATADIR'])

dictfilename = global_dir + '/dicts/BmodesNoDustNoSystPaper0_2020.dict'

d = qubic.qubicdict.qubicDict()
d.read_from_file(dictfilename)
d['nside'] = 256
d['filter_relative_bandwidth'] = 0.25


def give_sb(freq, nside):
    d['nside'] = nside
    d['filter_nu'] = freq * 1e9
    s = qubic.QubicScene(d)
    inst = qubic.QubicInstrument(d)
    # synthesized beam for a virtual detector located at the center of the focal plane: coordinates [0,0,-0.3]
    sb = inst.get_synthbeam(s, detpos=np.array([0,0,-0.3]))
    return sb

freqs=[150]
for ff in freqs:
    sb = give_sb(ff, 1024)
    hp.gnomview(sb/np.max(sb), reso=10, rot=[0,90],min=0, max=0.15,cmap='viridis',title='Frequency = {} GHz'.format(ff))
```

```{python}
dnu_nu = 0.25
nu0 = 150.
numin = nu0*(1-dnu_nu/2)
numax = nu0*(1+dnu_nu/2)
print(numin,numax)
nnu = 101
nus = np.linspace(numin, numax, nnu)

nside = 128

bmat = np.zeros((nnu, nnu))
for i in range(nnu):
    sbi = give_sb(nus[i], nside)
    for j in range(i, nnu):
        if (((i%10)==0) & ((j%10)==0)): print(i,j)
        sbj = give_sb(nus[j], nside)
        bmat[i,j] = np.sum(sbi * sbj)
        bmat[j,i] = bmat[i,j]
```

```{python}

```
