---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.6.0rc0
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

```{python}
# %matplotlib inline

import os
import sys
import glob
import time
from importlib import reload

# Specific science modules
import healpy as hp
import matplotlib.pyplot as plt
from matplotlib.legend_handler import HandlerLine2D, HandlerTuple
import matplotlib.ticker as mtick
import numpy as np

# Specific qubic modules
import qubic
from qubic.polyacquisition import compute_freq
from qubic import ReadMC as rmc
import ForegroundsSED as fsed
import qubic.AnalysisMC as amc

from pysimulators import FitsArray
import ForegroundsSED as fsed
from scipy.optimize import curve_fit
import scipy.constants
from qubic import mcmc
import pickle as pk

plt.rc('text',usetex=False)
plt.rc('font', size=16)
```

```{python}
nside = 64
savefigs = False
logscale = True
readdata = True
nreals = 43
component = "intensity"
# pixels used in paper:
if component == "intensity":
    #For Intensity
    pixQ_ud, pixG_ud = 47149, 26754
elif component == "polarization":
    # For Polarization
    pixQ_ud, pixG_ud = 42505, 27776
```

## Fit from data


Read data generated by Intensity_by_pixel.Rmd

```{python}
file = open("DataSED/FI-component_data.pk", 'rb')
dictionaries, centers = pk.load(file)
file.close()

file = open("DataSED/ForegroundMaps_{}nside{}.pk".format(dictionaries[0]["config"],
                                                              nside), "rb")
fgr_map_dust_ud, fgr_map_synch_ud, fgr_map_ud, maps_ud, cov_ud = pk.load(file)
file.close()
if readdata:
    bandreg = ["Qubic_Field150FI", "Qubic_Field220FI",
               "GalCen_Field150FI", "GalCen_Field220FI"]
    Cp_prime = []
    pixG_ud_, pixQ_ud_ = 27776, 42505
    for j, idict in enumerate(dictionaries):
        file = open("DataSED/SED_CovarMatrix_config{}_nside{}_nreals{}.pk".format(bandreg[j], 
                                                                                       nside,
                                                                                       nreals), "rb")
        Cp_prime.append(pk.load(file))
        file.close()
    
    file = open("DataSED/MCMC_run_{}nside{}_nreals{}_pixG{}_pixQ{}.pk".format(dictionaries[0]["config"],
                                                                  nside,
                                                                nreals,
                                                                pixG_ud_, pixQ_ud_), "rb")
    Mean_mcmc, Std_mcmc, xarr_mcmc, ySED_fit, Pmean, Perr, pixs_ud = pk.load(file)
    file.close()
elif not readdata:

    file = open("DataSED/data_torun_MCMC_nside64_nreals43_pixG27776_pixQ42505.pk", "rb")
    dictionaries, _, Cp_prime, nus_out, nus_edge, pixs_ud, pixs_red = pk.load(file)
    file.close()


nf_recon = dictionaries[0]['nf_recon']
_, nus_edge150, nus150, _, _, _ = qubic.compute_freq(dictionaries[0]['filter_nu'] / 1e9,  
                            nf_recon,
                            dictionaries[0]['filter_relative_bandwidth'])
_, nus_edge220, nus220, _, _, _ = qubic.compute_freq(dictionaries[1]['filter_nu'] / 1e9,  
                            nf_recon,
                            dictionaries[1]['filter_relative_bandwidth'])

```

```{python}

for i in range(4):
    hp.gnomview(fgr_map_dust_ud[i,0,:,0], rot = centers[i], reso = 12, sub = (2,2,i+1))
```

Define dust model to use with mcmc_old and fibtools_old

```{python}
reload(fsed)

if not readdata:
    def Bnu(nuGHz, temp):
        h = scipy.constants.h
        c = scipy.constants.c
        k = scipy.constants.k
        nu = nuGHz * 1e9
        return 2 * h * nu ** 3 / c ** 2 / (np.exp(h * nu / k / temp ) - 1 )
    def func353(x, a, b):
        #a = pars[0]
        #b = pars[1]
        Tdust = 19.6
        bnu = Bnu(x, Tdust)
        return a * 1e18 * bnu * (x / 353) ** (b / 2)

    past_mcmc = False
    if past_mcmc:
        FuncModel = func353
    else:
        FuncModel = fsed.ThermDust_Planck353

    p0 = np.array([1e3,3])

    Chi2Model = None
    
    flatprior = None#[np.array([1e1,1.5]), np.array([[0.3, 0.3], [0.3, 0.3]])]

    Mean_mcmc, Std_mcmc, xarr_mcmc, flat_samples = \
                fsed.foregrounds_run_mcmc(dictionaries, fgr_map_dust_ud, Cp_prime, 
                                                    FuncModel, nus_out, nus_edge, pixs_ud, 
                                                    pixs_red = pixs_red, chi2=Chi2Model, 
                                                    samples = 5000, verbose = False, initP0 = p0,
                                                    flatprior = None, )
    
    
    FuncPoint = fsed.ThermDust_Planck353_pointer
    initGuess = np.array([1, 3])
    
    xSED = [nus150, nus220, nus150, nus220]

    ySED_fit, Pmean, Perr = fsed.make_fit_SED(xSED, xarr_mcmc, 
                                                Mean_mcmc, Std_mcmc,
                                          FuncPoint, fgr_map_ud, pixs_ud, nf_recon, 
                                          initP0 = initGuess, 
                                          maxfev = 15000)
```

```{python}
external_covariance_diag=[np.array([[   7.47913173,   95.48016135],[  95.48016135, 1219.54366189]]),
                        np.array([[0.0406375 , 0.50749767],[0.50749767, 6.42548383]]), 
                        np.array([[2.52061945, 3.14743298],[3.14743298, 3.9474139 ]]),
                        np.array([[0.0047675 , 0.00544575],[0.00544575, 0.00638289]]),
                        np.array([[1.52384624e+00, 1.13692979e+02],[1.13692979e+02, 8.51638372e+03]]),
                        np.array([[4.21583082e-02, 4.95139310e+00],[4.95139310e+00, 5.91496679e+02]]), 
                        np.array([[ 2.05903162e-01, -1.27763235e+01],[-1.27763235e+01,  8.43795951e+02]]), 
                        np.array([[ 4.48555588e-03, -4.38410339e-01],[-4.38410339e-01,  4.42938253e+01]]), 
                        np.array([[ 8.07160494e-02, -5.16730619e+00],[-5.16730619e+00,  3.43941597e+02]]), 
                        np.array([[ 1.40846019e-02, -1.19818516e+00],[-1.19818516e+00,  1.05290323e+02]]),
                        np.array([[   1.88502435,   59.29184772],[  59.29184772, 1872.41942818]]),
                        np.array([[5.12098099e-03, 1.60204370e-01],[1.60204370e-01, 5.13183932e+00]])
                          ]


external_matrix_new = [np.array([[0.00327079, 0.04119676],[0.04119676, 0.52096453]]),
                      np.array([[0.00158881, 0.01915318],[0.01915318, 0.23300211]]),
                      np.array([[0.08568583, 0.10780785],[0.10780785, 0.13567425]]),
                      np.array([[0.0005416 , 0.00062671],[0.00062671, 0.00073348]]),
                      np.array([[4.49218135e-03, 4.93549406e-01],[4.93549406e-01, 5.44424227e+01]]),
                      np.array([[1.66046948e-03, 1.82126501e-01],[1.82126501e-01, 2.01406126e+01]]),
                      np.array([[1.34828123e-03, -1.48500217e-01],[-1.48500217e-01,  1.65540333e+01]]),
                      np.array([[4.67854600e-04, -4.61885304e-02],[-4.61885304e-02,  4.60904633e+00]]),
                      np.array([[1.93364458e-03, -1.51052302e-01],[-1.51052302e-01,  1.19115691e+01]]),
                      np.array([[9.20499767e-04, -7.40511946e-02],[-7.40511946e-02,  6.03017062e+00]]),
                      np.array([[0.00682632, 0.21502597],[0.21502597, 6.80033658]]),
                      np.array([[0.00057326, 0.01745101],[0.01745101, 0.53564246]])   ]


external_matrix_old = [np.array([[2.50692304e-05, 3.17124531e-04],[3.17124531e-04, 4.04001828e-03]]),
                        np.array([[0.00010975, 0.00134293],[0.00134293, 0.01672913]]),
                        np.array([[0.00292627, 0.00365206],[0.00365206, 0.00458563]]),
                        np.array([[0.00931016, 0.01083909],[0.01083909, 0.01292631]]),
                        np.array([[3.14095699e-07, 3.67453559e-05],[3.67453559e-05, 4.32749699e-03]]),
                        np.array([[9.45464848e-07, 1.06739404e-04],[1.06739404e-04, 1.23438268e-02]]),
                        np.array([[3.63430038e-07, -4.05881652e-05],[-4.05881652e-05,  4.56736628e-03]]),
                        np.array([[1.40401372e-06, -1.40328625e-04],[-1.40328625e-04,  1.43876148e-02]]),
                        np.array([[4.17638682e-07, -3.53425761e-05],[-3.53425761e-05,  3.01206364e-03]]),
                        np.array([[1.40020686e-06, -1.15836387e-04],[-1.15836387e-04,  9.84045768e-03]]),
                        np.array([[3.44300442e-06, 1.10819363e-04],[1.10819363e-04, 3.59408575e-03]]),
                        np.array([[1.37638309e-05, 4.26390949e-04],[4.26390949e-04, 1.35194414e-02]])   ]
```

```{python}
def is_pos_def(x):
    return np.all(np.linalg.eigvals(x) > 0)
diff_matrix = np.zeros((12))
for i in range(12):
    diff_matrix = external_matrix_new[i] - external_matrix_old[i]
    #print("new cov (minuit) - old cov (curve fir) is postive define? : " , is_pos_def(diff_matrix))
    
```

```{python}
#
#                  Intensity
#
# NEW (17 feb 2021)
savefigs = False
RESO = 15
capsize = 3
fonts = 16
plt.rc('font', size = fonts)

fig,ax = plt.subplots(nrows = 1, ncols = 4,figsize = (19,4.5), gridspec_kw = {'wspace': 0.4})
ax = ax.ravel()
plt.subplots_adjust(wspace = 0.1)
# Plotting
# Dust galactic center
t0, = ax[0].plot(nus150, fgr_map_dust_ud[2,:,pixs_ud[2],0], ls = '', 
           marker = 'd', color = 'g',alpha = 0.5, label = 'Dust')
ax[0].plot(nus220, fgr_map_dust_ud[3,:,pixs_ud[2],0], marker = 'd', ls = '', color = 'g', alpha = 0.5)
#Synch galactic center
t1, = ax[0].plot(nus150, fgr_map_synch_ud[2,:,pixs_ud[2],0], ls = '', 
           marker = 's', color = 'g', alpha = 0.5, label = 'Synchrotron')
ax[0].plot(nus220, fgr_map_synch_ud[3,:,pixs_ud[2],0], marker = 's', ls = '', color = 'g', alpha = 0.5)
#Two components
p1, = ax[0].plot(nus150, fgr_map_ud[2, :, pixs_ud[2], 0], 'ro', label = 'Input sky')
p2, = ax[0].plot(nus220, fgr_map_ud[3, :, pixs_ud[2], 0], 'bo')


e1 = ax[0].fill_between(xarr_mcmc[2,:], y1 = ySED_fit[2,:,0] - Std_mcmc[2, :, 0], 
                                y2 = ySED_fit[2, :, 0] + Std_mcmc[2, :, 0], 
                 color = 'r', alpha = 0.3, label = '68% C.L.')
e2 = ax[0].fill_between(xarr_mcmc[3, :], y1 = ySED_fit[3, :, 0] - Std_mcmc[3, :, 0], 
                        y2 = ySED_fit[3, :, 0] + Std_mcmc[3, :, 0], 
                   color = 'b', alpha = 0.3)

# Dust galactic center
ax[2].plot(nus150, fgr_map_dust_ud[0,:,pixs_ud[0],0], ls = '', 
           marker = 'd', color = 'g',alpha = 0.5, label = 'Dust')
ax[2].plot(nus220, fgr_map_dust_ud[1,:,pixs_ud[0],0], marker = 'd', ls = '', color = 'g', alpha = 0.5)
#Synch galactic center
ax[2].plot(nus150, fgr_map_synch_ud[0,:,pixs_ud[0],0], ls = '', 
           marker = 's', color = 'g', alpha = 0.5, label = 'Synchrotron')
ax[2].plot(nus220, fgr_map_synch_ud[1,:,pixs_ud[0],0], marker = 's', ls = '', color = 'g', alpha = 0.5)

ax[2].plot(nus150, fgr_map_ud[0, :, pixs_ud[0], 0], 'ro')
ax[2].plot(nus220, fgr_map_ud[1, :, pixs_ud[0], 0], 'bo')
ax[2].fill_between(xarr_mcmc[0, :], y1 = ySED_fit[0, :, 0] - Std_mcmc[0, :, 0], 
                   y2 = ySED_fit[0, :, 0] + Std_mcmc[0, :, 0], 
                   color = 'r', alpha = 0.3)
ax[2].fill_between(xarr_mcmc[1, :], y1 = ySED_fit[1, :, 0] - Std_mcmc[1, :, 0], 
                   y2 = ySED_fit[1, :, 0] + Std_mcmc[1, :, 0], 
                   color = 'b', alpha = 0.3)

# Settings
greyscale = 0.1

ax[2].axvspan(nus_edge150[-1], nus_edge220[0],color='k',alpha = greyscale)
ax[0].axvspan(nus_edge150[-1], nus_edge220[0],color='k',alpha = greyscale)
xlim = ax[0].get_xlim()
ylim = ax[0].get_ylim()
xlim2 = ax[2].get_xlim()
ylim2 = ax[2].get_ylim()
ax[0].axvspan(xlim[0], nus_edge150[0], color = 'k', alpha = greyscale)
ax[0].axvspan(nus_edge220[-1], xlim[-1], color = 'k', alpha = greyscale)

ax[2].axvspan(xlim2[0], nus_edge150[0], color = 'k', alpha = greyscale)
ax[2].axvspan(nus_edge220[-1], xlim2[-1], color = 'k', alpha = greyscale)

if logscale:
    ax[0].set_yscale("log")
    ax[2].set_yscale("log")
    ax[0].set_xscale("log")
    ax[2].set_xscale("log")


ax[0].set_xticks([150, 220], ['150','220'])
ax[0].xaxis.set_major_formatter(mtick.FormatStrFormatter('%.1f'))
ax[0].xaxis.set_minor_formatter(mtick.ScalarFormatter())
ax[0].tick_params(axis = "both", which = "both",
                  direction='in',width=1.3,)
ax[0].set_xlim(xlim)
ax[0].set_ylim(ylim)

ax[2].set_xticks([150, 220], ['150','220'])
ax[2].xaxis.set_major_formatter(mtick.FormatStrFormatter('%.1f'))
ax[2].xaxis.set_minor_formatter(mtick.ScalarFormatter())
ax[2].tick_params(axis = "both", which = "both",
                  direction='in',width=1.3,)
ax[2].set_xlim(xlim2)
ax[2].set_ylim(ylim2)

ax[0].grid(which="both")
ax[2].grid(which='both')
l = ax[0].legend([(t0,t1), (p1, p2), (e1, e2)], ["Dust - Synch", 'Input sky ', '68% C.L.'], numpoints=1, 
                 loc = "best", fontsize = 12,
               handler_map={tuple: HandlerTuple(ndivide=None)})

ax[0].set_title('GC patch - {} year'.format(dictionaries[0]['effective_duration']),fontsize=fonts)
ax[0].set_ylabel(r'$I(\nu)$ [$\mu$K$_{CMB}$]',fontsize=fonts)
ax[0].set_xlabel(r'$\nu$[GHz]',fontsize=fonts)

ax[2].set_title('QUBIC patch - {} years'.format(dictionaries[0]['effective_duration']),fontsize=fonts)
ax[2].set_ylabel(r'$I(\nu)$ [$\mu$K$_{CMB}$]',fontsize=fonts)
ax[2].set_xlabel(r'$\nu$[GHz]',fontsize=fonts)

# Displaying maps
ax[1].cla()
plt.axes(ax[1])
hp.gnomview(maps_ud[2, -1, :, 0], reso = 15,hold = True, 
            notext = True, title = ' ',
            min = 0,
            max = 0.4*np.max(maps_ud[2, -1, :, 0]), 
            unit = r'$\mu$K$_{CMB}$',
            rot = centers[2])
hp.projscatter(hp.pix2ang(nside, pixs_ud[2]), marker = '*', color = 'r', s = 180)
dpar = 10
dmer = 20
#Watch out, the names are wrong (change it)
mer_coordsG = [centers[2][0] - dmer, centers[2][0], centers[2][0] + dmer]
long_coordsG = [centers[2][1] - 2*dpar, centers[2][1] - dpar, 
                centers[2][1], centers[2][1] + dpar, centers[2][1] + 2 * dpar]
#paralels
for ilong in long_coordsG:
    plt.text(np.deg2rad(mer_coordsG[0] - 14), 1.1*np.deg2rad(ilong), 
             r'{}$\degree$'.format(ilong))
#meridians
for imer in mer_coordsG:
    if imer < 0:
        jmer = imer + 360
        ip, dp = divmod(jmer/15,1)
    else:
        ip, dp = divmod(imer/15,1)
    if imer == 0:
        plt.text(-np.deg2rad(imer + 3), np.deg2rad(long_coordsG[-1] + 6), 
             r'{}$\degree$'.format(int(ip) ))
    else:
        plt.text(-np.deg2rad(imer + 3), np.deg2rad(long_coordsG[-1] + 6), 
             r'{}$\degree$'.format(imer))
             #r'{}h{}m'.format(int(ip), int(round(dp*60))))
#hp.projtext(mer_coordsG[1] + 2, long_coordsG[0] - 6, '$l$',  color = 'k', lonlat=True)
#hp.projtext(mer_coordsG[2] + 13.5, long_coordsG[2] - 1, '$b$', rotation = 0, color = 'k', lonlat=True)
plt.text(0.5,0.13, '$l$', transform=ax[1].transAxes)
plt.text(-0.3,0.57, '$b$', transform=ax[1].transAxes)

ax[3].cla()
plt.axes(ax[3])
hp.gnomview(maps_ud[1, -1, :, 0], reso = 15, hold = True, 
            notext = True, title = ' ',
            unit = r'$\mu$K$_{CMB}$',
            min = 0,
            max = 0.4*np.max(maps_ud[1, -1, :, 0]), 
            rot = centers[0])
hp.projscatter(hp.pix2ang(nside, pixQ_ud),marker = '*', color = 'r', s = 180)

mer_coordsQ = [centers[0][0] - dmer, centers[0][0]+0, centers[0][0] + dmer]
long_coordsQ = [centers[0][1] - 2*dpar, centers[0][1] - dpar, centers[0][1], 
                centers[0][1] + dpar, centers[0][1] + 2 * dpar]
#paralels
for ilong in long_coordsQ:
    plt.text(np.deg2rad(mer_coordsQ[0]-360+29), 1.1*np.deg2rad(ilong+58), r'{:.0f}$\degree$'.format(ilong),)
#meridians
for imer in mer_coordsQ:
    ip, dp = divmod(imer/15,1)
    plt.text(-np.deg2rad(imer-360+48), np.deg2rad(long_coordsQ[-1]+58+7), 
         r'{:.1f}$\degree$'.format(imer))

plt.text(0.5,0.13, '$l$', transform=ax[3].transAxes)
plt.text(-0.3,0.57, '$b$', transform=ax[3].transAxes)

#hp.projtext(mer_coordsQ[0] , long_coordsQ[0] - 6, '$l$',  color = 'k', lonlat=True)
#hp.projtext(mer_coordsQ[2] - 360, long_coordsQ[2] + 10, '$b$', rotation = 0, color = 'k', lonlat=True)
#hp.projtext(-330, -60, '$b$', rotation = 0, color = 'k', lonlat=True)

hp.graticule(dpar = dpar, dmer = dmer, alpha = 0.6, verbose = False)

#plt.tight_layout()
if savefigs:
    plt.savefig('Fig-FI-SED/March2021/NSIDE{}/{}_nrec{}_nside{}_pixQ{}_pixG{}_Intensity_log.svg'.format(nside,
                                                                            "ThermDust",
                                                                            dictionaries[0]['nf_recon'],
                                                                                nside,
                                                           pixQ_ud, pixG_ud), 
            format = 'svg', bbox_inches='tight')
    plt.savefig('Fig-FI-SED/March2021/NSIDE{}/{}_nrec{}_nside{}_pixQ{}_pixG{}_Intensity_log.pdf'.format(nside,
                                                                                "ThermDust",
                                                                               dictionaries[0]['nf_recon'],
                                                                            nside,
                                                           pixQ_ud, pixG_ud), 
            format = 'pdf', bbox_inches='tight')
    plt.savefig('Fig-FI-SED/March2021/NSIDE{}/{}_nrec{}_nside{}_pixQ{}_pixG{}_Intensity_log'.format(nside,
                                                                        "ThermDust", 
                                                                           dictionaries[0]['nf_recon'],
                                                                           nside,pixQ_ud, pixG_ud),
           bbox_inches='tight')
else:
    plt.show()
```

```{python}
#
#                  Polarization
#
fig,ax = plt.subplots(nrows = 1,ncols = 4, figsize = (19,4.5), gridspec_kw = {'wspace': 0.4})
ax = ax.ravel()
plt.subplots_adjust(wspace=0.1)

# Dust galactic center
t0, = ax[0].plot(nus150, np.sqrt(fgr_map_dust_ud[2,:,pixs_ud[2],1] ** 2 + \
                 fgr_map_dust_ud[2,:,pixs_ud[2],2] **2),
           ls = '', marker = 'd', color = 'g',alpha = 0.5, label = 'Dust')
ax[0].plot(nus220, np.sqrt(fgr_map_dust_ud[3,:,pixs_ud[2],1] ** 2 + \
                 fgr_map_dust_ud[3,:,pixs_ud[2],2] **2), 
           marker = 'd', ls = '', color = 'g', alpha = 0.5)
#Synch galactic center
t1, = ax[0].plot(nus150, np.sqrt(fgr_map_synch_ud[2,:,pixs_ud[2],1] ** 2 + \
                                    fgr_map_synch_ud[2,:,pixs_ud[2],2] ** 2), 
                 ls = '', marker = 's', color = 'g', alpha = 0.5, label = 'Synchrotron')
ax[0].plot(nus220, np.sqrt(fgr_map_synch_ud[3,:,pixs_ud[2],1] ** 2 + \
                                    fgr_map_synch_ud[3,:,pixs_ud[2],2] ** 2),
           marker = 's', ls = '', color = 'g', alpha = 0.5)

# Plotting
p1, = ax[0].plot(nus150, 
               np.sqrt(fgr_map_ud[2,:,pixs_ud[2],1] ** 2 + fgr_map_ud[2,:,pixs_ud[2],2] ** 2),
               'ro', lw = 3, label = 'Input sky')
p2, = ax[0].plot(nus220, 
               np.sqrt(fgr_map_ud[3,:,pixs_ud[3],1] ** 2 + fgr_map_ud[3,:,pixs_ud[3],2] ** 2),
               'bo', lw = 3)

e1 = ax[0].fill_between(xarr_mcmc[2], y1 = ySED_fit[2, :, 1] - Perr[2], 
                        y2 = ySED_fit[2, :, 1] + Perr[2], 
                   color = 'r', alpha = 0.3, label = '68% C.L. ')
e2 = ax[0].fill_between(xarr_mcmc[3], y1 = ySED_fit[3, :, 1] - Perr[3], 
                        y2 = ySED_fit[3, :, 1] + Perr[3], 
                   color = 'b', alpha = 0.3)

# Dust galactic center
ax[2].plot(nus150, np.sqrt(fgr_map_dust_ud[0,:,pixs_ud[0],1] ** 2 + \
                 fgr_map_dust_ud[0,:,pixs_ud[0],2] **2),
           ls = '', marker = 'd', color = 'g',alpha = 0.5, label = 'Dust')
ax[2].plot(nus220, np.sqrt(fgr_map_dust_ud[1,:,pixs_ud[0],1] ** 2 + \
                 fgr_map_dust_ud[1,:,pixs_ud[0],2] **2), 
           marker = 'd', ls = '', color = 'g', alpha = 0.5)
#Synch galactic center
ax[2].plot(nus150, np.sqrt(fgr_map_synch_ud[0,:,pixs_ud[0],1] ** 2 + \
                                    fgr_map_synch_ud[0,:,pixs_ud[0],2] ** 2), 
                 ls = '', marker = 's', color = 'g', alpha = 0.5, label = 'Synchrotron')
ax[2].plot(nus220, np.sqrt(fgr_map_synch_ud[1,:,pixs_ud[0],1] ** 2 + \
                                    fgr_map_synch_ud[1,:,pixs_ud[0],2] ** 2),
           marker = 's', ls = '', color = 'g', alpha = 0.5)

ax[2].plot(nus150, 
               np.sqrt(fgr_map_ud[0,:,pixs_ud[0],1] ** 2 + fgr_map_ud[0, :, pixs_ud[0], 2] ** 2),
               'ro', lw = 3)
ax[2].plot(nus220, 
               np.sqrt(fgr_map_ud[1, :, pixs_ud[1], 1] ** 2 + fgr_map_ud[1, :, pixs_ud[1], 2] ** 2),
               'bo', lw = 3)
ax[2].fill_between(xarr_mcmc[0], y1 = ySED_fit[0, :, 1] - Perr[0], 
                   y2 = ySED_fit[0, :, 1] + Perr[0], 
                   color = 'r', alpha = 0.3)
ax[2].fill_between(xarr_mcmc[1], y1 = ySED_fit[1, :, 1] - Perr[1], 
                   y2 = ySED_fit[1, :, 1] + Perr[1], 
                   color = 'b', alpha = 0.3)

# Setting
ax[0].set_title('GC patch - {} year'.format(dictionaries[0]['effective_duration']), fontsize = fonts)
ax[0].set_ylabel(r'$P(\nu)~[\mu$K$_{CMB}$]', fontsize = fonts)
ax[0].set_xlabel(r'$\nu~[GHz]$', fontsize = fonts)
#ax[0].legend(loc = "best", fontsize = 12)
l = ax[0].legend([(t0,t1), (p1, p2), (e1, e2)], ["Dust - Synch", 'Input sky ', '68% C.L.'], numpoints=1, 
                 loc = "best", fontsize = 12,
               handler_map={tuple: HandlerTuple(ndivide=None)})

ax[2].set_xlabel(r'$\nu~[GHz]$', fontsize = fonts)
ax[2].set_ylabel(r'$P(\nu)~[\mu$K$_{CMB}$]', fontsize = fonts)
ax[2].set_title('QUBIC patch - {} years'.format(dictionaries[0]['effective_duration']),fontsize=fonts)

xlim = ax[0].get_xlim()
ylim = ax[0].get_ylim()
xlim2 = ax[2].get_xlim()
ylim2 = ax[2].get_ylim()
ax[0].axvspan(nus_edge150[-1], nus_edge220[0], color = 'k', alpha = greyscale)
ax[0].axvspan(xlim2[0], nus_edge150[0], color = 'k', alpha = greyscale)
ax[0].axvspan(nus_edge220[-1], xlim2[-1], color = 'k', alpha = greyscale)
ax[2].axvspan(nus_edge150[-1], nus_edge220[0], color = 'k', alpha = greyscale)
ax[2].axvspan(xlim2[0], nus_edge150[0], color = 'k', alpha = greyscale)
ax[2].axvspan(nus_edge220[-1], xlim2[-1], color = 'k', alpha = greyscale)

#logscale = True
if logscale:
    ax[0].set_yscale("log")
    ax[2].set_yscale("log")
    ax[0].set_xscale("log")
    ax[2].set_xscale("log")


ax[0].set_xticks([150, 220], ['150','220'])
ax[0].xaxis.set_major_formatter(mtick.FormatStrFormatter('%.1f'))
ax[0].xaxis.set_minor_formatter(mtick.ScalarFormatter())
ax[0].tick_params(axis = "both", which = "both",
                  direction='in',width=1.3,)
ax[0].set_xlim(xlim)
ax[0].set_ylim(ylim)

ax[2].set_xticks([150, 220], ['150','220'])
ax[2].xaxis.set_major_formatter(mtick.FormatStrFormatter('%.1f'))
ax[2].xaxis.set_minor_formatter(mtick.ScalarFormatter())
ax[2].tick_params(axis = "both", which = "both",
                  direction='in',width=1.3,)
ax[2].set_xlim(xlim2)
ax[2].set_ylim(ylim2)

ax[0].grid(which="both")
ax[2].grid(which='both')

# Displaying maps    
plt.axes(ax[1])
auxmapG = np.sqrt(maps_ud[2, 0, :, 1] ** 2 + maps_ud[2, 0, :, 2] ** 2)
auxmapG[~cov_ud[2]] = hp.UNSEEN
hp.gnomview(auxmapG,
            reso = 15, hold = True, notext = True, 
            title = ' ',
            min = 0,
            cbar = True,
            unit = r'$\mu$K$_{CMB}$',
            rot = centers[2])
hp.projscatter(hp.pix2ang(nside, pixs_ud[2]),marker = '*',color = 'r', s = 180)
dpar = 10
dmer = 20
#Watch out, the names are wrong (change it)
mer_coordsG = [centers[2][0] - dmer, centers[2][0], centers[2][0] + dmer]
long_coordsG = [centers[2][1] - 2*dpar, centers[2][1] - dpar, 
                centers[2][1], centers[2][1] + dpar, centers[2][1] + 2 * dpar]
#paralels
for ilong in long_coordsG:
    plt.text(np.deg2rad(mer_coordsG[0] - 14), 1.1*np.deg2rad(ilong), 
             r'{}$\degree$'.format(ilong))
#meridians
for imer in mer_coordsG:
    if imer < 0:
        jmer = imer + 360
        ip, dp = divmod(jmer/15,1)
    else:
        ip, dp = divmod(imer/15,1)
    if imer == 0:
        plt.text(-np.deg2rad(imer + 3), np.deg2rad(long_coordsG[-1] + 6), 
             r'{}$\degree$'.format(int(ip) ))
    else:
        plt.text(-np.deg2rad(imer + 3), np.deg2rad(long_coordsG[-1] + 6), 
             r'{}$\degree$'.format(imer))
             #r'{}h{}m'.format(int(ip), int(round(dp*60))))
#hp.projtext(mer_coordsG[1] + 2, long_coordsG[0] - 6, '$l$',  color = 'k', lonlat=True)
#hp.projtext(mer_coordsG[2] + 13.5, long_coordsG[2] - 1, '$b$', rotation = 0, color = 'k', lonlat=True)
plt.text(0.5,0.13, '$l$', transform=ax[1].transAxes)
plt.text(-0.3,0.57, '$b$', transform=ax[1].transAxes)

plt.axes(ax[3])
auxmapQ = np.sqrt(maps_ud[0, 0, :, 1] ** 2 + maps_ud[0, 0, :, 2] ** 2)
auxmapQ[~cov_ud[0]] = hp.UNSEEN
hp.gnomview(auxmapQ,
            reso = 15, hold = True, notext = True, 
            max = 7,
            min = 0,
            title = ' ',
            cbar = True,
            unit = r'$\mu$K$_{CMB}$',
            rot = centers[0])
hp.projscatter(hp.pix2ang(nside, pixs_ud[0]), marker = '*', color = 'r', s = 180)
mer_coordsQ = [centers[0][0] - dmer, centers[0][0]+0, centers[0][0] + dmer]
long_coordsQ = [centers[0][1] - 2*dpar, centers[0][1] - dpar, 
                centers[0][1], centers[0][1] + dpar, centers[0][1] + 2 * dpar]
#paralels
for ilong in long_coordsQ:
    plt.text(np.deg2rad(mer_coordsQ[0] - 360 + 29), 1.1 * np.deg2rad(ilong + 58), 
             r'{:.0f}$\degree$'.format(ilong),)
#meridians
for imer in mer_coordsQ:
    ip, dp = divmod(imer/15,1)
    plt.text( - np.deg2rad(imer - 360 + 48), np.deg2rad(long_coordsQ[-1] + 58 + 7), 
         r'{:.1f}$\degree$'.format(imer))

hp.graticule(dpar = dpar, dmer = dmer, alpha = 0.6, verbose = False)
plt.text(0.5,0.13, '$l$', transform=ax[3].transAxes)
plt.text(-0.3,0.57, '$b$', transform=ax[3].transAxes)

plt.tight_layout()#plt.tight_layout()

if savefigs: 
    plt.savefig('Fig-FI-SED/March2021/NSIDE{}/{}_nrec{}_nside{}_pixQ{}_pixG{}_Polarization_log.svg'.format(nside,
                                                                "ThermDust",
                                                                dictionaries[0]['nf_recon'], nside,
                                                           pixQ_ud, pixG_ud), 
            format = 'svg', bbox_inches='tight')
    plt.savefig('Fig-FI-SED/March2021/NSIDE{}/{}_nrec{}_nside{}_pixQ{}_pixG{}_Polarization_log.pdf'.format(nside,
                                                                "ThermDust",
                                                                dictionaries[0]['nf_recon'], nside,
                                                           pixQ_ud, pixG_ud), 
            format = 'pdf', bbox_inches='tight')
    plt.savefig('Fig-FI-SED/March2021/NSIDE{}/{}_nrec{}_nside{}_pixQ{}_pixG{}_Polarization_log'.format(nside,
                                                                           "ThermDust",
                                                                            dictionaries[0]['nf_recon'], 
                                                                           nside,pixQ_ud, pixG_ud),
           bbox_inches='tight')
else:
    plt.show()
```

## Compare contours

```{python}
#
#                  Intensity
#
# NEW (17 feb 2021)
two_contours = True
RESO = 15
capsize = 3
plt.rc('font', size = 14)

fig,ax = plt.subplots(nrows = 1, ncols = 4,figsize = (19,4.5), gridspec_kw = {'wspace': 0.4})
ax = ax.ravel()
plt.subplots_adjust(wspace = 0.1)
# Plotting
# Dust galactic center
t0, = ax[0].plot(nus150, fgr_map_dust_ud[2,:,pixs_ud[2],0], ls = '', 
           marker = 'd', color = 'g',alpha = 0.5, label = 'Dust')
#ax[0].plot(nus220, fgr_map_dust_ud[3,:,pixs_ud[2],0], marker = 'd', ls = '', color = 'g', alpha = 0.5)
#Synch galactic center
t1, = ax[0].plot(nus150, fgr_map_synch_ud[2,:,pixs_ud[2],0], ls = '', 
           marker = 's', color = 'g', alpha = 0.5, label = 'Synchrotron')
#ax[0].plot(nus220, fgr_map_synch_ud[3,:,pixs_ud[2],0], marker = 's', ls = '', color = 'g', alpha = 0.5)
#Two components
p1, = ax[0].plot(nus150, fgr_map_ud[2, :, pixs_ud[2], 0], 'ro', label = 'Input sky')
p2, = ax[0].plot(nus220, fgr_map_ud[3, :, pixs_ud[2], 0], 'ro')


e1 = ax[0].fill_between(xarr_mcmc[2,:], y1 = ySED_fit[2,:,0] - Std_mcmc[2, :, 0], 
                                y2 = ySED_fit[2, :, 0] + Std_mcmc[2, :, 0], 
                 color = 'r', alpha = 0.4, label = '68% C.L.')
ax[0].fill_between(xarr_mcmc[3, :], y1 = ySED_fit[3, :, 0] - Std_mcmc[3, :, 0], 
                        y2 = ySED_fit[3, :, 0] + Std_mcmc[3, :, 0], 
                   color = 'r', alpha = 0.4)

if two_contours:
    e2 = ax[0].fill_between(xarr_mcmc[2,:], y1 = ySED_fit2[2,:,0] - Std_mcmc2[2, :, 0], 
                                y2 = ySED_fit2[2, :, 0] + Std_mcmc2[2, :, 0], 
                 color = 'b', alpha = 0.4, label = '68% C.L.')
    ax[0].fill_between(xarr_mcmc[3, :], y1 = ySED_fit2[3, :, 0] - Std_mcmc2[3, :, 0], 
                            y2 = ySED_fit2[3, :, 0] + Std_mcmc2[3, :, 0], 
                       color = 'b', alpha = 0.4)

    #e3 = ax[0].fill_between(xarr_mcmc[2,:], y1 = ySED_fit_nsig2[2,:,0] - Std_mcmc_nsig2[2, :, 0], 
    #                            y2 = ySED_fit_nsig2[2, :, 0] + Std_mcmc_nsig2[2, :, 0], 
    #             color = 'g', alpha = 0.4, label = '68% C.L.')
    #ax[0].fill_between(xarr_mcmc[3, :], y1 = ySED_fit_nsig2[3, :, 0] - Std_mcmc_nsig2[3, :, 0], 
    #                        y2 = ySED_fit_nsig2[3, :, 0] + Std_mcmc_nsig2[3, :, 0], 
    #                   color = 'g', alpha = 0.4)

    #e2 = ax[0].fill_between(xarr_mcmc[2,:], y1 = ySED_fit_nsigp1[2,:,0] - Std_mcmc_nsigp1[2, :, 0], 
    #                            y2 = ySED_fit_nsigp1[2, :, 0] + Std_mcmc_nsigp1[2, :, 0], 
    #             color = 'b', alpha = 0.4, label = '68% C.L.')
    #ax[0].fill_between(xarr_mcmc[3, :], y1 = ySED_fit_nsigp1[3, :, 0] - Std_mcmc_nsigp1[3, :, 0], 
    #                        y2 = ySED_fit_nsigp1[3, :, 0] + Std_mcmc_nsigp1[3, :, 0], 
    #                   color = 'b', alpha = 0.4)

# Dust galactic center
#ax[2].plot(nus150, fgr_map_dust_ud[0,:,pixs_ud[0],0], ls = '', 
#           marker = 'd', color = 'g',alpha = 0.5, label = 'Dust')
#ax[2].plot(nus220, fgr_map_dust_ud[1,:,pixs_ud[0],0], marker = 'd', ls = '', color = 'g', alpha = 0.5)
#Synch galactic center
#ax[2].plot(nus150, fgr_map_synch_ud[0,:,pixs_ud[0],0], ls = '', 
#           marker = 's', color = 'g', alpha = 0.5, label = 'Synchrotron')
#ax[2].plot(nus220, fgr_map_synch_ud[1,:,pixs_ud[0],0], marker = 's', ls = '', color = 'g', alpha = 0.5)

ax[2].plot(nus150, fgr_map_ud[0, :, pixs_ud[0], 0], 'ro')
ax[2].plot(nus220, fgr_map_ud[1, :, pixs_ud[0], 0], 'ro')
ax[2].fill_between(xarr_mcmc[0, :], y1 = ySED_fit[0, :, 0] - Std_mcmc[0, :, 0], 
                   y2 = ySED_fit[0, :, 0] + Std_mcmc[0, :, 0], 
                   color = 'r', alpha = 0.4)
ax[2].fill_between(xarr_mcmc[1, :], y1 = ySED_fit[1, :, 0] - Std_mcmc[1, :, 0], 
                   y2 = ySED_fit[1, :, 0] + Std_mcmc[1, :, 0], 
                   color = 'r', alpha = 0.4)

if two_contours:
    ax[2].fill_between(xarr_mcmc[0, :], y1 = ySED_fit2[0, :, 0] - Std_mcmc2[0, :, 0], 
                   y2 = ySED_fit2[0, :, 0] + Std_mcmc2[0, :, 0], 
                   color = 'b', alpha = 0.4)
    ax[2].fill_between(xarr_mcmc[1, :], y1 = ySED_fit2[1, :, 0] - Std_mcmc2[1, :, 0], 
                       y2 = ySED_fit2[1, :, 0] + Std_mcmc2[1, :, 0], 
                       color = 'b', alpha = 0.4)

    #ax[2].fill_between(xarr_mcmc[0, :], y1 = ySED_fit_nsig2[0, :, 0] - Std_mcmc_nsig2[0, :, 0], 
    #               y2 = ySED_fit_nsig2[0, :, 0] + Std_mcmc_nsig2[0, :, 0], 
    #               color = 'g', alpha = 0.4)
    #ax[2].fill_between(xarr_mcmc[1, :], y1 = ySED_fit_nsig2[1, :, 0] - Std_mcmc_nsig2[1, :, 0], 
    #                   y2 = ySED_fit_nsig2[1, :, 0] + Std_mcmc_nsig2[1, :, 0], 
    #                   color = 'g', alpha = 0.4)

    #ax[2].fill_between(xarr_mcmc[0, :], y1 = ySED_fit_nsigp1[0, :, 0] - Std_mcmc_nsigp1[0, :, 0], 
    #               y2 = ySED_fit_nsigp1[0, :, 0] + Std_mcmc_nsigp1[0, :, 0], 
    #               color = 'b', alpha = 0.4)
    #ax[2].fill_between(xarr_mcmc[1, :], y1 = ySED_fit_nsigp1[1, :, 0] - Std_mcmc_nsigp1[1, :, 0], 
    #                   y2 = ySED_fit_nsigp1[1, :, 0] + Std_mcmc_nsigp1[1, :, 0], 
    #                   color = 'b', alpha = 0.4)

# Settings
greyscale = 0.1
ax[2].axvspan(nus_edge150[-1], nus_edge220[0],color='k',alpha = greyscale)
ax[0].axvspan(nus_edge150[-1], nus_edge220[0],color='k',alpha = greyscale)
xlim = ax[0].get_xlim()
ylim = ax[0].get_ylim()
xlim2 = ax[2].get_xlim()
ylim2 = ax[2].get_ylim()
ax[0].axvspan(xlim[0], nus_edge150[0], color = 'k', alpha = greyscale)
ax[0].axvspan(nus_edge220[-1], xlim[-1], color = 'k', alpha = greyscale)

ax[2].axvspan(xlim2[0], nus_edge150[0], color = 'k', alpha = greyscale)
ax[2].axvspan(nus_edge220[-1], xlim2[-1], color = 'k', alpha = greyscale)

ax[0].set_xlim(xlim)
ax[0].set_ylim(ylim)
ax[2].set_xlim(xlim2)
ax[2].set_ylim(ylim2)

ax[2].grid(which='both')
l = ax[0].legend([(t0,t1), (p1, p2), (e1, e2)], ["Dust - Synch", 'Input sky ', 'Minuit ext. matr. - CF'], numpoints=1, 
                 loc = 2, fontsize = 12,
               handler_map={tuple: HandlerTuple(ndivide=None)})

ax[0].grid()
ax[0].set_title('GC patch - {} year'.format(dictionaries[0]['effective_duration']),fontsize=16)
ax[0].set_ylabel(r'$I(\nu)$ [$\mu$K]',fontsize=16)
ax[0].set_xlabel(r'$\nu$[GHz]',fontsize=16)

ax[2].set_title('QUBIC patch - {} years'.format(dictionaries[0]['effective_duration']),fontsize=16)
ax[2].set_ylabel(r'$I(\nu)$ [$\mu$K]',fontsize=16)
ax[2].set_xlabel(r'$\nu$[GHz]',fontsize=16)

# Displaying maps
ax[1].cla()
plt.axes(ax[1])
hp.gnomview(maps_ud[2, -1, :, 0], reso = 15,hold = True, 
            notext = True, title = ' ',
            min = 0,
            max = 0.4*np.max(maps_ud[2, -1, :, 0]), 
            unit = r'$\mu$K',
            rot = centers[2])
hp.projscatter(hp.pix2ang(nside, pixs_ud[2]), marker = '*', color = 'r', s = 180)
dpar = 10
dmer = 20
#Watch out, the names are wrong (change it)
mer_coordsG = [centers[2][0] - dmer, centers[2][0], centers[2][0] + dmer]
long_coordsG = [centers[2][1] - 2*dpar, centers[2][1] - dpar, 
                centers[2][1], centers[2][1] + dpar, centers[2][1] + 2 * dpar]
#paralels
for ilong in long_coordsG:
    plt.text(np.deg2rad(mer_coordsG[0] - 12), 1.1*np.deg2rad(ilong), 
             r'{}$\degree$'.format(ilong))
#meridians
for imer in mer_coordsG:
    if imer < 0:
        jmer = imer + 360
        ip, dp = divmod(jmer/15,1)
    else:
        ip, dp = divmod(imer/15,1)
    if imer == 0:
        plt.text(-np.deg2rad(imer + 3), np.deg2rad(long_coordsG[-1] + 6), 
             r'{}$\degree$'.format(int(ip) ))
    else:
        plt.text(-np.deg2rad(imer + 3), np.deg2rad(long_coordsG[-1] + 6), 
             r'{}$\degree$'.format(imer))
hp.projtext(mer_coordsG[1] + 2, long_coordsG[0] - 6, '$l$',  color = 'k', lonlat=True)
hp.projtext(mer_coordsG[2] + 12.5, long_coordsG[2] - 1, '$b$', rotation = 90, color = 'k', lonlat=True)

ax[3].cla()
plt.axes(ax[3])
hp.gnomview(maps_ud[1, -1, :, 0], reso = 15, hold = True, 
            notext = True, title = ' ',
            unit = r'$\mu$K',
            min = 0,
            max = 0.4*np.max(maps_ud[1, -1, :, 0]), 
            rot = centers[0])
hp.projscatter(hp.pix2ang(nside, pixQ_ud),marker = '*', color = 'r', s = 180)

mer_coordsQ = [centers[1][0] - dmer, centers[0][0]+0, centers[0][0] + dmer]
long_coordsQ = [centers[0][1] - 2*dpar, centers[0][1] - dpar, centers[0][1], 
                centers[0][1] + dpar, centers[0][1] + 2 * dpar]
#paralels
for ilong in long_coordsQ:
    plt.text(np.deg2rad(mer_coordsQ[0]-360+31), 1.1*np.deg2rad(ilong+58), r'{:.0f}$\degree$'.format(ilong),)
#meridians
for imer in mer_coordsQ:
    ip, dp = divmod(imer/15,1)
    plt.text(-np.deg2rad(imer-360+48), np.deg2rad(long_coordsQ[-1]+58+7), 
         r'{:.1f}$\degree$'.format(imer))

hp.graticule(dpar = dpar, dmer = dmer, alpha = 0.6, verbose = False)

plt.tight_layout()
plt.show()
#if savefigs:
#    plt.savefig('Figs-FI-SED/March2021/NSIDE{}/{}_nrec{}_nside{}_pixQ{}_pixG{}_Intensity_grat.svg'.format(nside,
#                                                                            FuncModel.__name__,
#                                                                            d150Q['nf_recon'],nside,
#                                                           pixQ_ud, pixG_ud), 
#            format = 'svg', bbox_inches='tight')
#    plt.savefig('Figs-FI-SED/March2021/NSIDE{}/{}_nrec{}_nside{}_pixQ{}_pixG{}_Intensity_grat.pdf'.format(nside,
#                                                                                FuncModel.__name__,
#                                                                               d150Q['nf_recon'],nside,
#                                                           pixQ_ud, pixG_ud), 
#            format = 'pdf', bbox_inches='tight')
#    plt.savefig('Figs-FI-SED/March2021/NSIDE{}/{}_nrec{}_nside{}_pixQ{}_pixG{}_Intensity'.format(nside,
#                                                                        FuncModel.__name__, 
#                                                                           d150Q['nf_recon'],
#                                                                           nside,pixQ_ud, pixG_ud),
#           bbox_inches='tight')
#else:
#    plt.show()
```

```{python}
#
#                  Polarization
#

fig,ax = plt.subplots(nrows = 1,ncols = 4, figsize = (19,4.5), gridspec_kw = {'wspace': 0.4})
ax = ax.ravel()
plt.subplots_adjust(wspace=0.1)

# Dust galactic center
#t0, = ax[0].plot(nus150, np.sqrt(fgr_map_dust_ud[2,:,pixs_ud[2],1] ** 2 + \
#                 fgr_map_dust_ud[2,:,pixs_ud[2],2] **2),
#           ls = '', marker = 'd', color = 'g',alpha = 0.5, label = 'Dust')
#ax[0].plot(nus220, np.sqrt(fgr_map_dust_ud[3,:,pixs_ud[2],1] ** 2 + \
#                 fgr_map_dust_ud[3,:,pixs_ud[2],2] **2), 
#           marker = 'd', ls = '', color = 'g', alpha = 0.5)
#Synch galactic center
#t1, = ax[0].plot(nus150, np.sqrt(fgr_map_synch_ud[2,:,pixs_ud[2],1] ** 2 + \
#                                    fgr_map_synch_ud[2,:,pixs_ud[2],2] ** 2), 
#                 ls = '', marker = 's', color = 'g', alpha = 0.5, label = 'Synchrotron')
#ax[0].plot(nus220, np.sqrt(fgr_map_synch_ud[3,:,pixs_ud[2],1] ** 2 + \
#                                    fgr_map_synch_ud[3,:,pixs_ud[2],2] ** 2),
#           marker = 's', ls = '', color = 'g', alpha = 0.5)

# Plotting
p1, = ax[0].plot(nus150, 
               np.sqrt(fgr_map_ud[2,:,pixs_ud[2],1] ** 2 + fgr_map_ud[2,:,pixs_ud[2],2] ** 2),
               'ro', lw = 3, label = 'Input sky')
p2, = ax[0].plot(nus220, 
               np.sqrt(fgr_map_ud[3,:,pixs_ud[3],1] ** 2 + fgr_map_ud[3,:,pixs_ud[3],2] ** 2),
               'ro', lw = 3)

e1 = ax[0].fill_between(xarr_mcmc[2], y1 = ySED_fit[2, :, 1] - Perr[2], 
                        y2 = ySED_fit[2, :, 1] + Perr[2], 
                   color = 'r', alpha = 0.4, label = '68% C.L. ')
ax[0].fill_between(xarr_mcmc[3], y1 = ySED_fit[3, :, 1] - Perr[3], 
                        y2 = ySED_fit[3, :, 1] + Perr[3], 
                   color = 'r', alpha = 0.4)

if two_contours:
    e2 = ax[0].fill_between(xarr_mcmc[2], y1 = ySED_fit2[2, :, 1] - Perr2[2], 
                            y2 = ySED_fit2[2, :, 1] + Perr2[2], 
                       color = 'b', alpha = 0.4, label = '68% C.L. ')
    ax[0].fill_between(xarr_mcmc[3], y1 = ySED_fit2[3, :, 1] - Perr2[3], 
                            y2 = ySED_fit2[3, :, 1] + Perr2[3], 
                       color = 'b', alpha = 0.4)

    #e3 = ax[0].fill_between(xarr_mcmc[2], y1 = ySED_fit_nsig2[2, :, 1] - Perr_nsig2[2], 
    #                        y2 = ySED_fit_nsig2[2, :, 1] + Perr_nsig2[2], 
    #                   color = 'g', alpha = 0.4, label = '68% C.L. ')
    #ax[0].fill_between(xarr_mcmc[3], y1 = ySED_fit_nsig2[3, :, 1] - Perr_nsig2[3], 
    #                        y2 = ySED_fit_nsig2[3, :, 1] + Perr_nsig2[3], 
    #                   color = 'g', alpha = 0.4)

    #e2 = ax[0].fill_between(xarr_mcmc[2], y1 = ySED_fit_nsigp1[2, :, 1] - Perr_nsigp1[2], 
    #                        y2 = ySED_fit_nsigp1[2, :, 1] + Perr_nsigp1[2], 
    #                   color = 'b', alpha = 0.4, label = '68% C.L. ')
    #ax[0].fill_between(xarr_mcmc[3], y1 = ySED_fit_nsigp1[3, :, 1] - Perr_nsigp1[3], 
    #                        y2 = ySED_fit_nsigp1[3, :, 1] + Perr_nsigp1[3], 
    #                   color = 'b', alpha = 0.4)
    
# Dust galactic center
#ax[2].plot(nus150, np.sqrt(fgr_map_dust_ud[0,:,pixs_ud[0],1] ** 2 + \
#                 fgr_map_dust_ud[0,:,pixs_ud[0],2] **2),
#           ls = '', marker = 'd', color = 'g',alpha = 0.5, label = 'Dust')
#ax[2].plot(nus220, np.sqrt(fgr_map_dust_ud[1,:,pixs_ud[0],1] ** 2 + \
#                 fgr_map_dust_ud[1,:,pixs_ud[0],2] **2), 
#           marker = 'd', ls = '', color = 'g', alpha = 0.5)
#Synch galactic center
#ax[2].plot(nus150, np.sqrt(fgr_map_synch_ud[0,:,pixs_ud[0],1] ** 2 + \
#                                    fgr_map_synch_ud[0,:,pixs_ud[0],2] ** 2), 
#                 ls = '', marker = 's', color = 'g', alpha = 0.5, label = 'Synchrotron')
#ax[2].plot(nus220, np.sqrt(fgr_map_synch_ud[1,:,pixs_ud[0],1] ** 2 + \
#                                    fgr_map_synch_ud[1,:,pixs_ud[0],2] ** 2),
#           marker = 's', ls = '', color = 'g', alpha = 0.5)

ax[2].plot(nus150, 
               np.sqrt(fgr_map_ud[0,:,pixs_ud[0],1] ** 2 + fgr_map_ud[0, :, pixs_ud[0], 2] ** 2),
               'ro', lw = 3)
ax[2].plot(nus220, 
               np.sqrt(fgr_map_ud[1, :, pixs_ud[1], 1] ** 2 + fgr_map_ud[1, :, pixs_ud[1], 2] ** 2),
               'ro', lw = 3)
ax[2].fill_between(xarr_mcmc[0], y1 = ySED_fit[0, :, 1] - Perr[0], 
                   y2 = ySED_fit[0, :, 1] + Perr[0], 
                   color = 'r', alpha = 0.4)
ax[2].fill_between(xarr_mcmc[1], y1 = ySED_fit[1, :, 1] - Perr[1], 
                   y2 = ySED_fit[1, :, 1] + Perr[1], 
                   color = 'r', alpha = 0.4)

if two_contours:
    ax[2].fill_between(xarr_mcmc[0], y1 = ySED_fit2[0, :, 1] - Perr2[0], 
                       y2 = ySED_fit2[0, :, 1] + Perr2[0], 
                       color = 'b', alpha = 0.4)
    ax[2].fill_between(xarr_mcmc[1], y1 = ySED_fit2[1, :, 1] - Perr2[1], 
                       y2 = ySED_fit2[1, :, 1] + Perr2[1], 
                       color = 'b', alpha = 0.4)
    #ax[2].fill_between(xarr_mcmc[0], y1 = ySED_fit_nsig2[0, :, 1] - Perr_nsig2[0], 
    #                   y2 = ySED_fit_nsig2[0, :, 1] + Perr_nsig2[0], 
    #                   color = 'g', alpha = 0.4)
    #ax[2].fill_between(xarr_mcmc[1], y1 = ySED_fit_nsig2[1, :, 1] - Perr_nsig2[1], 
    #                   y2 = ySED_fit_nsig2[1, :, 1] + Perr_nsig2[1], 
    #                   color = 'g', alpha = 0.4)
    #ax[2].fill_between(xarr_mcmc[0], y1 = ySED_fit_nsigp1[0, :, 1] - Perr_nsigp1[0], 
    #                   y2 = ySED_fit_nsigp1[0, :, 1] + Perr_nsigp1[0], 
    #                   color = 'b', alpha = 0.4)
    #ax[2].fill_between(xarr_mcmc[1], y1 = ySED_fit_nsigp1[1, :, 1] - Perr_nsigp1[1], 
    #                   y2 = ySED_fit_nsigp1[1, :, 1] + Perr_nsigp1[1], 
    #                   color = 'b', alpha = 0.4)

# Setting
ax[0].set_title('GC patch - {} year'.format(dictionaries[0]['effective_duration']), fontsize = 14)
ax[0].set_ylabel(r'$P(\nu)~[\mu$K]', fontsize = 14)
ax[0].set_xlabel(r'$\nu~[GHz]$', fontsize = 14)
ax[0].legend(loc = 2, fontsize = 12)
ax[0].grid()
ax[2].set_xlabel(r'$\nu~[GHz]$', fontsize = 14)
ax[2].set_ylabel(r'$P(\nu)~[\mu$K]', fontsize = 14)
ax[2].set_title('QUBIC patch - {} years'.format(dictionaries[0]['effective_duration']),fontsize=14)
ax[2].grid()

xlim = ax[0].get_xlim()
ylim = ax[0].get_ylim()
xlim2 = ax[2].get_xlim()
ylim2 = ax[2].get_ylim()

ax[0].axvspan(nus_edge150[-1], nus_edge220[0], color = 'k', alpha = greyscale)
ax[0].axvspan(xlim2[0], nus_edge150[0], color = 'k', alpha = greyscale)
ax[0].axvspan(nus_edge220[-1], xlim2[-1], color = 'k', alpha = greyscale)
ax[2].axvspan(nus_edge150[-1], nus_edge220[0], color = 'k', alpha = greyscale)
ax[2].axvspan(xlim2[0], nus_edge150[0], color = 'k', alpha = greyscale)
ax[2].axvspan(nus_edge220[-1], xlim2[-1], color = 'k', alpha = greyscale)

ax[0].set_xlim(xlim)
ax[0].set_ylim(ylim)
ax[0].text(xlim[0]+(xlim[1]-xlim[0])*0.1, ylim[-1]*0.8, '150 GHz \n band', fontsize = 10)
ax[0].text(xlim[0]+(xlim[1]-xlim[0])*0.6, ylim[-1]*0.8, '220 GHz \n band', fontsize = 10)
ax[2].set_xlim(xlim2)
ax[2].set_ylim(ylim2)
ax[2].text(xlim2[0]+(xlim2[1]-xlim2[0])*0.1, ylim2[-1]*0.8, '150 GHz \n band', fontsize = 10)
ax[2].text(xlim2[0]+(xlim2[1]-xlim2[0])*0.6, ylim2[-1]*0.8, '220 GHz \n band', fontsize = 10)

# Displaying maps    
plt.axes(ax[1])
auxmapG = np.sqrt(maps_ud[2, 0, :, 1] ** 2 + maps_ud[2, 0, :, 2] ** 2)
auxmapG[~cov_ud[2]] = hp.UNSEEN
hp.gnomview(auxmapG,
            reso = 15, hold = True, notext = True, 
            title = ' ',
            min = 0,
            cbar = True,
            unit = r'$\mu$K',
            rot = centers[2])
hp.projscatter(hp.pix2ang(nside, pixs_ud[2]),marker = '*',color = 'r', s = 180)
dpar = 10
dmer = 20
#Watch out, the names are wrong (change it)
mer_coordsG = [centers[2][0] - dmer, centers[2][0], centers[2][0] + dmer]
long_coordsG = [centers[2][1] - 2*dpar, centers[2][1] - dpar, 
                centers[2][1], centers[2][1] + dpar, centers[2][1] + 2 * dpar]
#paralels
for ilong in long_coordsG:
    plt.text(np.deg2rad(mer_coordsG[0] - 12), 1.1*np.deg2rad(ilong), 
             r'{}$\degree$'.format(ilong))
#meridians
for imer in mer_coordsG:
    if imer < 0:
        jmer = imer + 360
        ip, dp = divmod(jmer/15,1)
    else:
        ip, dp = divmod(imer/15,1)
    if imer == 0:
        plt.text(-np.deg2rad(imer + 3), np.deg2rad(long_coordsG[-1] + 6), 
             r'{}$\degree$'.format(int(ip) ))
    else:
        plt.text(-np.deg2rad(imer + 3), np.deg2rad(long_coordsG[-1] + 6), 
             r'{}$\degree$'.format(imer))
             #r'{}h{}m'.format(int(ip), int(round(dp*60))))
hp.projtext(mer_coordsG[1] + 2, long_coordsG[0] - 6, '$l$',  color = 'k', lonlat=True)
hp.projtext(mer_coordsG[2] + 12.5, long_coordsG[2] - 1, '$b$', rotation = 90, color = 'k', lonlat=True)

plt.axes(ax[3])
auxmapQ = np.sqrt(maps_ud[0, 0, :, 1] ** 2 + maps_ud[0, 0, :, 2] ** 2)
auxmapQ[~cov_ud[0]] = hp.UNSEEN
hp.gnomview(auxmapQ,
            reso = 15, hold = True, notext = True, 
            max = 7,
            min = 0,
            title = ' ',
            cbar = True,
            unit = r'$\mu$K',
            rot = centers[0])
hp.projscatter(hp.pix2ang(nside, pixs_ud[0]), marker = '*', color = 'r', s = 180)
mer_coordsQ = [centers[0][0] - dmer, centers[0][0]+0, centers[0][0] + dmer]
long_coordsQ = [centers[0][1] - 2*dpar, centers[0][1] - dpar, 
                centers[0][1], centers[0][1] + dpar, centers[0][1] + 2 * dpar]
#paralels
for ilong in long_coordsQ:
    plt.text(np.deg2rad(mer_coordsQ[0]-360+31), 1.1*np.deg2rad(ilong+58), r'{:.0f}$\degree$'.format(ilong),)
#meridians
for imer in mer_coordsQ:
    ip, dp = divmod(imer/15,1)
    plt.text( - np.deg2rad(imer - 360 + 48), np.deg2rad(long_coordsQ[-1] + 58 + 7), 
         r'{:.1f}$\degree$'.format(imer))

hp.graticule(dpar = dpar, dmer = dmer, alpha = 0.6, verbose = False)
#l = ax[0].legend([(p1, p2), (e1, e2)], ['Input sky', '68% C.L.'], numpoints=1, loc = 4, fontsize = 12,
#               handler_map={tuple: HandlerTuple(ndivide=None)})
#l = ax[0].legend([(t0,t1), (p1, p2), (e1, e2, e3)], ["Dust - Synch", 'Input sky', 'new - old - nsiginit = 2'], numpoints=1, 
l = ax[0].legend([(t0,t1), (p1, p2), (e1, e2)], ["Dust - Synch", 'Input sky ', 'Minuit ext. matr. - CF'], numpoints=1, 
                 loc = 2, fontsize = 12,
               handler_map={tuple: HandlerTuple(ndivide=None)})

plt.tight_layout()#plt.tight_layout()
plt.show()
#if savefigs: 
#    plt.savefig('Figs-FI-SED/March2021/NSIDE{}/{}_nrec{}_nside{}_pixQ{}_pixG{}_Polarization_grat.svg'.format(nside,
#                                                                FuncModel.__name__,
#                                                                d150Q['nf_recon'], nside,
#                                                           pixQ_ud, pixG_ud), 
#            format = 'svg', bbox_inches='tight')
#    plt.savefig('Figs-FI-SED/March2021/NSIDE{}/{}_nrec{}_nside{}_pixQ{}_pixG{}_Polarization_grat.pdf'.format(nside,
#                                                                                                             FuncModel.__name__,
#                                                                d150Q['nf_recon'], nside,
#                                                           pixQ_ud, pixG_ud), 
#            format = 'pdf', bbox_inches='tight')
#    plt.savefig('Figs-FI-SED/March2021/NSIDE{}/{}_nrec{}_nside{}_pixQ{}_pixG{}_Polarization_grat'.format(nside,
#                                                                            FuncModel.__name__,
#                                                                           d150Q['nf_recon'], 
#                                                                           nside,pixQ_ud, pixG_ud),
#           bbox_inches='tight')
#else:
#    plt.show()
```

```{python}
flat_samples.shape, flat_samples2.shape
```

```{python}
data, _, _, _ = plt.hist2d(flat_samples[0,:,0], flat_samples[0,:,1], bins = 50)
data2, _, _, _ = plt.hist2d(flat_samples2[0,:,0], flat_samples2[0,:,1], bins = 50)
```

```{python}
plt.title("Sample parameters 150GHz - QUBIC FOV")
#plt.contour(data.T, levels = 4)
plt.contour(data2.T, levels = 4)
```

```{python}

```
