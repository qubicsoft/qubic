---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.4.1
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

```{python}
import healpy as hp
import matplotlib.pyplot as plt
import matplotlib as mp
from qubicpack.utilities import Qubic_DataDir
import qubic
import os
import sys
import numpy as np
import glob
from astropy.io import fits

from importlib import reload
```

```{python}
def get_maps(file):
    simu = fits.open(file)

    maps_recon = simu['MAPS_RECON'].data
    maps_convo = simu['MAPS_CONVOLVED'].data
    coverage=simu['coverage'].data
    print('coverage shape', coverage.shape)
    diff = maps_recon - maps_convo

    return maps_recon, maps_convo, diff,coverage

def get_maps_many_files(rep_simu, name, verbose=True):
    all_fits = glob.glob(rep_simu + name)
    nfiles = len(all_fits)
    if verbose:
        print('{} files have been found.'.format(nfiles))

    all_maps_recon = []
    all_maps_convo = []
    all_maps_diff = []

    for i, fits in enumerate(all_fits):
        map_recon, map_convo, map_diff,coverage = get_maps(fits)
        if i == 0:
            right_shape = map_recon.shape
        else:
            if map_recon.shape != right_shape:
                raise ValueError('You should take maps with identical shapes.')
        all_maps_recon.append(map_recon)
        all_maps_convo.append(map_convo)
        all_maps_diff.append(map_diff)

    return all_fits, np.asarray(all_maps_recon), \
           np.asarray(all_maps_convo), np.asarray(all_maps_diff), coverage

def read_run(name, repo=None, fixpar=True):
    #repo = os.environ['QUBIC_DATADIR']+'scripts/Spectroimagery_paper/output_paper/nersc/{}/'.format(jobid)
    repo = os.environ['QUBIC_DATADIR']+'scripts/Spectroimagery_paper/output_paper/extended-source/'+name
    repodict = glob.glob(repo+'*.dict')[0]

    d = qubic.qubicdict.qubicDict()
    d.read_from_file(repodict)
    center = qubic.equ2gal(d['RA_center'], d['DEC_center'])
    #if fixpar:
    d['nf_sub']=15
    if name=='':
        d['nf_recon'] = [3,]
    else:
        d['nf_recon'] = [1,] 
    
    _,_,nus_in,_,_,_=qubic.compute_freq(150,d['nf_sub'],0.25)
    
    print("Working with nf_sub = {} and nfrec = {}".format(d['nf_sub'], d['nf_recon']))
    mapsrec={}
    mapsconv={}
    nusfull = {}
    nusfulledge = {}
    for isub in d['nf_recon']:
        _, maprec, mapconv, mapdif,coverage = get_maps_many_files(repo,'*extended*.fits')
        _,inusedge,inus,_,_,_=qubic.compute_freq(150,isub,0.25)
        mapsrec.update({'{}'.format(isub): maprec})
        mapsconv.update({'{}'.format(isub): mapconv})
        nusfull.update({'{}'.format(isub):inus})    
        nusfulledge.update({'{}'.format(isub):inusedge})    
    

    return mapsrec, mapsconv,nusfull,nusfulledge, nus_in, center,d,coverage
```

```{python}
mapsrec, mapsconv, nus, nus_edge, nus_in, center, d, coverage = read_run('', fixpar=False)
mapsrec_im, mapsconv_im, nus_im, nus_edge_im, nus_in_im, _, _,_ = read_run('imager-like/', fixpar=False)

```

Reduce dimenssions of maps

```{python}
hp.mollview(coverage,rot=center)
mask=coverage>0.1*max(coverage)

```

```{python}
maprec=mapsrec['3'][0]
mapconv=mapsconv['3'][0]
nusrec=nus['3']
nusedge=nus_edge['3']
for i in range(3):
    maprec[i,mask,0]*=5
    mapconv[i,mask,0]*=5
    maprec[i,~mask,0]=hp.UNSEEN
    mapconv[i,~mask,0]=hp.UNSEEN
```

```{python}
maprec_im=mapsrec_im['1'][0]
mapconv_im=mapsconv_im['1'][0]
nusrec_im=nus_im['1']
nusedge_im=nus_edge_im['1']
```

```{python}
from matplotlib import cm
import matplotlib as mp
```

```{python}
plt.figure(figsize=(10,10))
plt.rc('font', size=8)
hp.gnomview(maprec[0,:,0],reso=13,rot=center,min=-1e5,max=1e5,cmap='jet')
```

```{python}
137-11.5/2
```

```{python}
plt.figure(figsize=(8,8))
vmin=-1e5
vmax=1e5
plt.rc('font', size=16)
reso=12
fig,ax=plt.subplots(nrows=3,ncols=3,figsize=(16,16), sharex=True,
                    gridspec_kw={'hspace': 0.01,'wspace': 0.0})
cmap='jet'
ax=ax.ravel()
for i in range(3):
    ax[3*i].cla()
    plt.axes(ax[3*i])
    hp.gnomview(mapconv[i,:,0],  rot= center,reso=12,notext=True,hold=True,
                max=vmax,
                min=vmin,
                cmap=cmap,
                cbar= True if i ==3 else False,
               title='Convolved' if i == 0 else ' ')
    ax[3*i+1].cla()
    plt.axes(ax[3*i+1])
    hp.gnomview(maprec[i,:,0], rot= center,reso=12,notext=True,hold=True,
                max= vmax,
                min =vmin,
                cmap=cmap,
                cbar= True if i ==3 else False,
               title = 'Reconstructed' if i == 0 else ' ')
    ax[3*i+2].cla()
    plt.axes(ax[3*i+2])
    auxmap=(mapconv-maprec)[i,:,0]
    auxmap[~mask]=hp.UNSEEN
    hp.gnomview(auxmap, rot= center,reso=12,notext=True,hold=True,
                max= vmax,
                min =vmin,
                cmap=cmap,
                cbar= True if i ==3 else False,
               title = 'Difference' if i == 0 else ' ')
    if i == 0:
        ax[3*i].text(-100,100, 'lala',)
plt.text(-2,1.33,'{:.0f}GHz'.format(nusrec[0]),fontsize=16)
plt.text(-2,0.66,'{:.0f}GHz'.format(nusrec[1]),fontsize=16)
plt.text(-2,0,'{:.0f}GHz'.format(nusrec[2]),fontsize=16)

#fig.colorbar(cm.ScalarMappable(), ax=ax[-1])
#plt.savefig('extsource',)#format='pdf')
```

```{python}
_,edGe,NuS, _,_,_ = qubic.compute_freq(150,15,0.25)
```

```{python}
NuS[4],NuS[11]
```

```{python}
nus
```

```{python}
np.diff(nus_edge['3'])
```

```{python}
11-5/2+137
```

```{python}

```
