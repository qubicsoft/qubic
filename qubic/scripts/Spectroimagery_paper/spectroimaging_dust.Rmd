---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.1'
      jupytext_version: 1.2.1
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

# QUBIC spectroimaging

#### Editing by Martin Gamboa, Louise Mousset, 2019/09/02

This notebook is part of a set of notebooks with the idea to show spectroimaging capabilities of qubicsoft. There are 2 notebooks:
* spectroimaging_pointsource.Rmd: Test map-making for two point source emmiting in monochromatic frecuency and superimpose two signals in different frecuency and see how the reconstruction works
* spectroimaging_dust.Rmd: test map-making using cmb+dust signal

```{python}
# %matplotlib inline
from pylab import *
import os
import sys

# Specific science modules
import healpy as hp
import numpy as np

# Specific qubic modules
from qubicpack.utilities import Qubic_DataDir
from pysimulators import FitsArray
import qubic
from qubic import SpectroImLib as si
from pysm.nominal import models

rc('figure', figsize=(13, 10))
rc('font', size=15)
```

```{python}
# Repository for dictionary and input maps
global_dir = Qubic_DataDir(datafile='instrument.py', datadir=os.environ['QUBIC_DATADIR'])
dictfilename = global_dir + '/dicts/spectroimaging_article.dict'

# Read dictionary chosen
d = qubic.qubicdict.qubicDict()
d.read_from_file(dictfilename)
print(d['nf_sub'])
# Center of the patch observed in galactic coordinates
d['DEC_center'] = 0.
d['latitude'] = 90.
d['longitude'] = 90.
d['nside'] = 8
d['npointings'] = 100
center = qubic.equ2gal(d['RA_center'], d['DEC_center'])
print(d)
```

# Input sky (to change)
* two point source
* two superimpose signals
* cmb+dust

```{python}
# Make a sky using PYSM
sky_config = {'dust': models('d1', d['nside'])}
Qubic_sky = si.Qubic_sky(sky_config, d)
x0 = Qubic_sky.get_simple_sky_map()

# Load a CMB map
# x0 = FitsArray(dictmaps + 'CMB_nside64_nfsub14.fits')
    
print('Input Map with shape (nf_sub, #pixels, #stokes) : ', np.shape(x0))

# Check size map
if hp.get_nside(x0[0,:,0]) == d['nside']:
    print('Good size')
    y0=x0
else:
    print('Bad size')
    y0 = np.empty((d['nf_sub'], 12 * d['nside'] ** 2, 3))
    for i in range(d['nf_sub']):
        for j in range(3):
            y0[i, :, j] = hp.ud_grade(x0[i, :, j], d['nside'])

```

```{python}
# Look at the input sky maps using Healpy

istokes = 0 # Stokes parameter (I, Q, U)
imap = 2 # Frequency subband, should be smaller than nf_sub
rr=9 # Resolution in arcmin

plt.figure(figsize=(13,8))
for istk in range(3):
    plt.subplots_adjust(wspace=0.9)
    hp.mollview(y0[imap,:,istk], cmap='jet', sub = (3,2,2*istk+1), 
                title = 'Mollview {0} Stokes parameter, map {1}'.format(d['kind'][istk], imap))
    hp.gnomview(y0[imap,:,istk], cmap ='jet', sub = (3,2,2*istk+2), rot=center, reso=rr, 
                title = 'Gnomview {0} Stokes parameter, map {1}'.format(d['kind'][istk], imap))
    
```

```{python}
istk = 1
plt.figure(figsize=(13,8))
for band in range(d['nf_sub']):
    plt.subplots_adjust(wspace=0.9)
    hp.gnomview(y0[band, :, istk], 
                rot=0.,
                reso=10,
                cmap='jet', 
                sub = (4, 4, band+1),
                min=0.,
#                 max=1e3,
                title = '{} Band {}'.format(d['kind'][istk], band))

```

# TOD simulation

```{python}
# Pointing strategy
p = qubic.get_pointing(d)
print('=== Pointing DONE! ===')

# ==== TOD making ====
TOD, maps_convolved = si.create_TOD(d, p, x0)
print('--------- Noiseless TOD with shape: {} - Done ---------'.format(np.shape(TOD)))
```

```{python}
q = qubic.QubicMultibandInstrument(d)
s = qubic.QubicScene(d)
rot_beams = si.get_hitmap(q[0], s, p)
```

```{python}
rot_beams.shape
hp.mollview(np.sum(rot_beams, axis=0))
```

```{python}
TOD.shape
```

# Map-Making

```{python}
nf_sub_rec = d['nf_recon'][1]
d['tol']=1e-5
maps_recon, cov, nus, nus_edge, maps_convolved = si.reconstruct_maps(TOD, d, p,
                                                                    nf_sub_rec, x0=x0)
```

```{python}
# Look at the coverage of the sky
cov = np.sum(cov, axis=0)
maxcov = np.max(cov)
unseen = cov < maxcov * 0.1
maps_convolved[:, unseen, :] = hp.UNSEEN
maps_recon[:, unseen, :] = hp.UNSEEN

cov
```

```{python}
maps_recon.shape
hp.mollview(maps_recon[1, :, 0])
```

```{python}
imr = 1
plt.figure(figsize=(12,12))
for istk in range(3):
    plt.subplots_adjust(wspace=0.9)
    #hp.mollview(maps_recon[imr,:,istk], cmap='jet', sub = (3,3,3*istk+1), 
    #            title = 'Mollview {0} Stokes parameter, map {1}'.format(d['kind'][istk], imap))
    hp.gnomview(maps_recon[imr,:,istk], cmap ='jet', sub = (3,3,3*istk+1), rot=center, reso=rr, 
                title = '{0} rec {1}'.format(d['kind'][istk], imr))
    hp.gnomview(maps_convolved[imr,:,istk], cmap ='jet', sub = (3,3,3*istk+2), rot=center, reso=rr, 
                title = '{0} conv {1}'.format(d['kind'][istk], imr))
    hp.gnomview((maps_convolved-maps_recon)[imr,:,istk], cmap ='jet', sub = (3,3,3*istk+3), rot=center, reso=rr, 
                title = '{0} diff {1}'.format(d['kind'][istk], imr))

```

```{python}

```
