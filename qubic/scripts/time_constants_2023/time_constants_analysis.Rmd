---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.14.5
  kernelspec:
    display_name: Python 3 (ipykernel)
    language: python
    name: python3
---

```{python}
import os
import glob
import numpy as np

from qubic import time_constants_tools as tct

thedatadir = '/sps/qubic/Data/Calib-TD/2023-04-17/2023-04-17_13.41.41__dome-open_carbon-fiber_0.2Hz_sq_duty33_2vpp_Vbias3.0'

fmod = 0.2
dc = 33

base_save_path = '/sps/qubic/Users/nahuelmg'
save_path = base_save_path + '/time_constants_results/alldatasets_to_may_2023/'

d = tct.compute_tc_squaremod( thedatadir, fmod = fmod, dutycycle = dc, save_path = save_path )
```

```{python}
import os
import glob
import numpy as np

from qubic import time_constants_tools as tct

thedatadir = '/home/nahue/Downloads/2023-04-17/2023-04-17_13.41.41__dome-open_carbon-fiber_0.2Hz_sq_duty33_2vpp_Vbias3.0'

fmod = 0.2
dc = 33

save_path = '/home/nahue/Downloads/2023-04-17/results/'

d = tct.compute_tc_squaremod( thedatadir, fmod = fmod, dutycycle = dc, save_path = save_path )
```

```{python}
import os
import glob
import gc
from numpy import *
import numpy as np
from importlib import reload

from matplotlib.pyplot import *
from matplotlib import pyplot as plt
# from IPython.display import display, HTML
# display(HTML("<style>.container { width:97% !important; }</style>"))

# # %matplotlib notebook
# rc('figure',figsize=(11,6))
# rc('font',size=12)

# from qubicpack.qubicfp import qubicfp
# from qubic import time_domain_tools as tdt
from qubic import time_constants_tools as tct
```

# Directories

```{python}
## Select a dataset corresponding to the TC measurement thorugh square modulation (external calsource or carbon fibres)
day = '2023-04-17'
base_dir = '/home/nahue/Downloads/'
data_dir = base_dir + day + '/'
thedirs = np.sort(glob.glob(data_dir+'*carbon*'))

print('Here are all the available files')
for i in range(len(thedirs)):
    print(i,thedirs[i])
```

# Computing the time constants

```{python}
reload(tct)
close('all')
```

```{python}
## To plot the raw timelines

a = qubicfp()
a.assign_verbosity(0)
a.read_qubicstudio_dataset(thedatadir)

tt, alltod = a.tod()

figure()
for i in [22]:#np.arange(256)[21:24]:
    plot(tt,alltod[i])
```

```{python}
only_overview = False
doplot = False
doplot_onebyone = False
lowcut = None
highcut = None
notch = None
params_spl = 4
params_poly = 1
typefit = 'just_exp'

fmod = 0.2
dc = 33
# numfile = 0
# thedatadir = thedirs[numfile]

# print('We will analyse:')
# print(numfile, thedatadir)

# base_save_path = os.getcwd()
base_save_path = data_dir
save_path = base_save_path+'results/'
if not os.path.exists(save_path):
    os.mkdir(save_path)
    
print(save_path)
```

```{python}
# d = tct.compute_tc_squaremod(thedatadir, doplot=doplot, doplot_onebyone = doplot_onebyone,verbose = False,
#                              highcut=highcut,lowcut=lowcut,notch=notch,typefit=typefit,fmod=0.2,dutycycle=33,
#                              save_path=save_path,only_overview = only_overview,nparams_ext_spl=params_spl,
#                              nparams_ext_poly=params_poly)

for thedatadir in thedirs:
    d = tct.compute_tc_squaremod(thedatadir, doplot=doplot, doplot_onebyone = doplot_onebyone,verbose = False,
                                 highcut=highcut,lowcut=lowcut,notch=notch,typefit=typefit,fmod=fmod,dutycycle=dc,
                                 save_path=save_path)
```

```{python}

```

```{python}
os.chdir(save_path)
alldic = {}
for i,thedatadir in enumerate(thedirs):
    alldic['{}'.format(i+1)] = np.load('d__{}.npy'.format(str.split(thedatadir,'/')[-1]),allow_pickle=True).item()
```

```{python}
figure()
title('Histograms risetime - datasets from {}'.format(day))
ylabel('Counts')
xlabel('Risetime [ ms ]')

rt_mean = np.zeros(len(thedirs))
rt_mean_error = np.zeros(len(thedirs))
ft_mean = np.zeros(len(thedirs))
ft_mean_error = np.zeros(len(thedirs))
Vbias = np.zeros(len(thedirs))

for i in np.arange(len(thedirs)):
    ok_cuts_rt = (alldic['{}'.format(i+1)]['alltod_folded_nonorm']['risetime']>0)&(alldic['{}'.format(i+1)]['alltod_folded_nonorm']['risetime']<0.6)
    ok_cuts_ft = (alldic['{}'.format(i+1)]['alltod_folded_nonorm']['falltime']>0)&(alldic['{}'.format(i+1)]['alltod_folded_nonorm']['falltime']<0.6)
    ok = ok_cuts_ft * ok_cuts_rt * d['ok']['Residuals_combined']
    rt_mean[i] = np.mean(alldic['{}'.format(i+1)]['alltod_folded_nonorm']['risetime'][ok])
    rt_mean_error[i] = np.sum(alldic['{}'.format(i+1)]['alltod_folded_nonorm']['risetime_error'][ok])/(np.sum(ok))
    ft_mean[i] = np.mean(alldic['{}'.format(i+1)]['alltod_folded_nonorm']['falltime'][ok])
    ft_mean_error[i] = np.sum(alldic['{}'.format(i+1)]['alltod_folded_nonorm']['falltime_error'][ok])/(np.sum(ok))
    Vbias[i] = alldic['{}'.format(i+1)]['Vbias'] 

    hist(alldic['{}'.format(i+1)]['alltod_folded_nonorm']['risetime'][ok],30,alpha=0.5,label='Vbias {:.1f}'.format(Vbias[i]))

grid()
legend()

figure()
title('Histograms falltime - datasets from {}'.format(day))
ylabel('Counts')
xlabel('Falltime [ ms ]')

for i in np.arange(len(thedirs)):
    hist(1e3*alldic['{}'.format(i+1)]['alltod_folded_nonorm']['falltime'][ok],30,alpha=0.5,label='Vbias {:.1f}'.format(Vbias[i]))

grid()
legend()

tight_layout


figure()
title('Mean time constants - datasets from {}'.format(day))
ylabel('Mean time constant [ ms ]')
xlabel('Vbias [V]')
errorbar(Vbias,1e3*rt_mean,yerr = 1e3*rt_mean_error,fmt='bo',alpha=0.5,label='Risetime')
errorbar(Vbias,1e3*ft_mean,yerr = 1e3*ft_mean_error,fmt='ro',alpha=0.5,label='Falltime')
grid()
legend()
tight_layout
```

```{python}
rt_nonorm = alldic['1']['alltod_folded_nonorm']['risetime']
rt_norm = alldic['1']['alltod_folded_norm']['risetime']
b = np.abs(rt_nonorm-rt_norm)

# figure()
# plot(b,'.')


results = np.array([b]).T
labels = tct.run_DBSCAN(results, doplot=True, parnames = ['Risetime diff'],eps_cpar=0.01,min_samples_cpar = 10)
```

```{python}
# # print(alldic['1'])#['alltod_folded_nonorm']['amplitude'])
# amps_1 = np.abs(alldic['1']['alltod_folded_nonorm']['amplitude'])
# ok = alldic['1']['ok']['Residuals'] & (amps_1<20000) & (amps_1>0)

# figure()
# hist(amps_1[ok],15)
```

```{python}
# figure()
# plot(d['alltod_folded_norm']['residuals_fit_folded_median'],d['alltod_folded_norm']['residuals_folded_median'],'.')
# plot(d['alltod_folded_norm']['residuals_fit_folded_median'],d['alltod_folded_norm']['residuals_fit_folded_median'])
# # show()
```

```{python}
# print(d['dataset_info'])
# print(d['Vbias'])
```
