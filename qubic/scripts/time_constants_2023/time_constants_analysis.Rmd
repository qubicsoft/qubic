---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.14.5
  kernelspec:
    display_name: Python 3 (ipykernel)
    language: python
    name: python3
---

```{python}
import os
import glob
import gc
from numpy import *
import numpy as np
from importlib import reload

from matplotlib.pyplot import *
from matplotlib import pyplot as plt
# %config InlineBackend.figure_format='retina'
from IPython.display import display, HTML
display(HTML("<style>.container { width:95% !important; }</style>"))

# %matplotlib notebook
rc('figure',figsize=(11,6))
rc('font',size=12)

from qubicpack.qubicfp import qubicfp
from qubic import time_domain_tools as tdt
from qubic import time_constants_tools as tct
```

# Directories

```{python}
day = '2023-04-17'
data_dir = '/home/nahue/Downloads/' + day + '/'
thedirs = np.sort(glob.glob(data_dir+'*carbon*'))

print('Here are all the available files')
for i in range(len(thedirs)):
    print(i,thedirs[i])
```

# Computing the time constants

```{python}
reload(tct)
close('all')
```

```{python}
# a = qubicfp()
# a.assign_verbosity(0)
# a.read_qubicstudio_dataset(thedatadir)

# tt, alltod = a.tod()
```

```{python}
# figure()
# for i in np.arange(256)[50:70]:
#     plot(tt,alltod[i])
```

```{python}
doplot = True
doplot_onebyone = False
lowcut = None
highcut = None
notch = None
typefit = 'just_exp'

numfile = 0
thedatadir = thedirs[numfile]

print('We will analyse:')
print(numfile, thedatadir)

d = tct.compute_tc_squaremod(thedatadir, doplot=doplot, doplot_onebyone = doplot_onebyone,verbose = False,highcut=highcut,lowcut=lowcut,notch=notch,typefit=typefit,fmod=0.2,dutycycle=33)
dictname = 'd__{}.npy'.format(d['dataset_info'])
np.save(dictname,d)

# for thedatadir in thedirs:
#     d = tct.compute_tc_squaremod(thedatadir, doplot=doplot, doplot_onebyone = doplot_onebyone,verbose = False,highcut=highcut,lowcut=lowcut,notch=notch,typefit=typefit,fmod=0.2,dutycycle=33)
#     dictname = 'd__{}.npy'.format(d['dataset_info'])
#     np.save(dictname,d)
```

```{python}

```

```{python}
alldic = {}
for i,thedatadir in enumerate(thedirs):
    alldic['{}'.format(i+1)] = np.load('/home/nahue/Downloads/2023-04-17/results/d__{}.npy'.format(str.split(thedatadir,'/')[-1]),allow_pickle=True).item()
```

```{python}
figure()
title('Histograms risetime - all datasets CF 2023-04-17')
ylabel('Counts')
xlabel('Risetime [ ms ]')

rt_mean = np.zeros(len(thedirs))
rt_mean_error = np.zeros(len(thedirs))
ft_mean = np.zeros(len(thedirs))
ft_mean_error = np.zeros(len(thedirs))
Vbias = np.zeros(len(thedirs))

for i in np.arange(len(thedirs)):
    ok_cuts_rt = (alldic['{}'.format(i+1)]['alltod_folded_nonorm']['risetime']>0)&(alldic['{}'.format(i+1)]['alltod_folded_nonorm']['risetime']<0.6)
    ok_cuts_ft = (alldic['{}'.format(i+1)]['alltod_folded_nonorm']['falltime']>0)&(alldic['{}'.format(i+1)]['alltod_folded_nonorm']['falltime']<0.6)
    ok = ok_cuts_ft * ok_cuts_rt * d['ok']['Residuals']
    rt_mean[i] = np.mean(alldic['{}'.format(i+1)]['alltod_folded_nonorm']['risetime'][ok])
    rt_mean_error[i] = np.sum(alldic['{}'.format(i+1)]['alltod_folded_nonorm']['risetime_error'][ok])/(np.sum(ok))
    ft_mean[i] = np.mean(alldic['{}'.format(i+1)]['alltod_folded_nonorm']['falltime'][ok])
    ft_mean_error[i] = np.sum(alldic['{}'.format(i+1)]['alltod_folded_nonorm']['falltime_error'][ok])/(np.sum(ok))
    Vbias[i] = alldic['{}'.format(i+1)]['Vbias'] 

    hist(alldic['{}'.format(i+1)]['alltod_folded_nonorm']['risetime'][ok],30,alpha=0.5,label='Vbias {:.1f}'.format(Vbias[i]))

grid()
legend()

figure()
title('Histograms falltime - all datasets CF 2023-04-17')
ylabel('Counts')
xlabel('Falltime [ ms ]')

for i in np.arange(len(thedirs)):
    hist(1e3*alldic['{}'.format(i+1)]['alltod_folded_nonorm']['falltime'][ok],30,alpha=0.5,label='Vbias {:.1f}'.format(Vbias[i]))

grid()
legend()

tight_layout


figure()
title('Mean time constants - all datasets CF 2023-04-17')
ylabel('Mean time constant [ ms ]')
xlabel('Vbias [V]')
errorbar(Vbias,1e3*rt_mean,yerr = 1e3*rt_mean_error,fmt='bo',alpha=0.5,label='Risetime')
errorbar(Vbias,1e3*ft_mean,yerr = 1e3*ft_mean_error,fmt='ro',alpha=0.5,label='Falltime')
grid()
legend()
tight_layout
```

```{python}
# print(alldic['1'])#['alltod_folded_nonorm']['amplitude'])
amps_1 = np.abs(alldic['1']['alltod_folded_nonorm']['amplitude'])
ok = alldic['1']['ok']['Residuals'] & (amps_1<20000) & (amps_1>0)

figure()
hist(amps_1[ok],15)
```

```{python}

```

```{python}
figure()
plot(d['alltod_folded_norm']['residuals_fit_folded_median'],d['alltod_folded_norm']['residuals_folded_median'],'.')
plot(d['alltod_folded_norm']['residuals_fit_folded_median'],d['alltod_folded_norm']['residuals_fit_folded_median'])
# show()
```

```{python}
print(d['dataset_info'])
print(d['Vbias'])
```

```{python}
1/0.01
```

```{python}

```
