---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.14.5
  kernelspec:
    display_name: Python 3 (ipykernel)
    language: python
    name: python3
---

```{python}
import os
import glob
import gc
from numpy import *
import numpy as np
from pathlib import Path
from importlib import reload

from matplotlib.pyplot import *
from matplotlib import pyplot as plt
from IPython.display import display, HTML
display(HTML("<style>.container { width:97% !important; }</style>"))

# %matplotlib notebook
rc('figure',figsize=(11,6))
rc('font',size=12)

# from qubicpack.qubicfp import qubicfp
from qubic import time_constants_tools as tct
```

# Directories

```{python}
## Select a dataset corresponding to the TC measurement thorugh square modulation (external calsource or carbon fibres)
day = '2023-03-02'
# day = '2023-04-17'
# base_dir = '/home/nahue/Downloads/'
base_dir = '/media/nahue/files_hdd/heavy-data/'
data_dir = base_dir + day + '/'
thedirs = np.sort(glob.glob(data_dir+'*calsource*'))

print('Here are all the available files')
for i in range(len(thedirs)):
    print(i,thedirs[i])
```

# Computing the time constants

```{python}
## To plot the raw timelines

# a = qubicfp()
# a.assign_verbosity(0)
# a.read_qubicstudio_dataset(thedatadir)

# tt, alltod = a.tod()

# figure()
# for i in [22]:#np.arange(256)[21:24]:
#     plot(tt,alltod[i])
```

```{python}
# lowcut = None
# highcut = None
# notch = None
# params_spl = 4
# params_poly = 1
# typefit = 'just_exp'

numfile = 2
thedatadir = thedirs[numfile]

print('We will analyse:')
print(numfile, thedatadir)

# base_save_path = os.getcwd()
base_save_path = data_dir
save_path = base_save_path+'results'

Path(save_path).mkdir( parents=True, exist_ok=True )
    
print(save_path)
```

```{python}
reload(tct)

only_overview = False
doplot = None
saveplot = ['folded_data','focal_plane']#None
save_dict = True
force_sync = True
fmod = 0.2 #None
dutycycle = 66 #None

d = tct.compute_tc_squaremod(thedatadir, save_path = save_path, only_overview = only_overview, doplot = doplot,
                             saveplot = saveplot, save_dict = save_dict, fmod_explicit = fmod, dutycycle_explicit = dutycycle, force_sync = force_sync)

# d = tct.compute_tc_squaremod(thedatadir, save_path = save_path, fmod = fmod, dutycycle = dc)

# for thedatadir in thedirs:
#     d = tct.compute_tc_squaremod(thedatadir, save_path = save_path, fmod = fmod, dutycycle = dc)
```

```{python}

```

```{python}
# os.chdir(save_path)
# alldic = {}
# for i,thedatadir in enumerate(thedirs):
#     alldic['{}'.format(i+1)] = np.load('d__{}.npy'.format(str.split(thedatadir,'/')[-1]),allow_pickle=True).item()
```

```{python}
# figure()
# title('Histograms risetime - datasets from {}'.format(day))
# ylabel('Counts')
# xlabel('Risetime [ ms ]')

# rt_mean = np.zeros(len(thedirs))
# rt_mean_error = np.zeros(len(thedirs))
# ft_mean = np.zeros(len(thedirs))
# ft_mean_error = np.zeros(len(thedirs))
# Vbias = np.zeros(len(thedirs))

# for i in np.arange(len(thedirs)):
#     ok_cuts_rt = (alldic['{}'.format(i+1)]['alltod_folded_nonorm']['risetime']>0)&(alldic['{}'.format(i+1)]['alltod_folded_nonorm']['risetime']<0.6)
#     ok_cuts_ft = (alldic['{}'.format(i+1)]['alltod_folded_nonorm']['falltime']>0)&(alldic['{}'.format(i+1)]['alltod_folded_nonorm']['falltime']<0.6)
#     ok = ok_cuts_ft * ok_cuts_rt * d['ok']['Residuals_combined']
#     rt_mean[i] = np.mean(alldic['{}'.format(i+1)]['alltod_folded_nonorm']['risetime'][ok])
#     rt_mean_error[i] = np.sum(alldic['{}'.format(i+1)]['alltod_folded_nonorm']['risetime_error'][ok])/(np.sum(ok))
#     ft_mean[i] = np.mean(alldic['{}'.format(i+1)]['alltod_folded_nonorm']['falltime'][ok])
#     ft_mean_error[i] = np.sum(alldic['{}'.format(i+1)]['alltod_folded_nonorm']['falltime_error'][ok])/(np.sum(ok))
#     Vbias[i] = alldic['{}'.format(i+1)]['Vbias'] 

#     hist(alldic['{}'.format(i+1)]['alltod_folded_nonorm']['risetime'][ok],30,alpha=0.5,label='Vbias {:.1f}'.format(Vbias[i]))

# grid()
# legend()

# figure()
# title('Histograms falltime - datasets from {}'.format(day))
# ylabel('Counts')
# xlabel('Falltime [ ms ]')

# for i in np.arange(len(thedirs)):
#     hist(1e3*alldic['{}'.format(i+1)]['alltod_folded_nonorm']['falltime'][ok],30,alpha=0.5,label='Vbias {:.1f}'.format(Vbias[i]))

# grid()
# legend()

# tight_layout


# figure()
# title('Mean time constants - datasets from {}'.format(day))
# ylabel('Mean time constant [ ms ]')
# xlabel('Vbias [V]')
# errorbar(Vbias,1e3*rt_mean,yerr = 1e3*rt_mean_error,fmt='bo',alpha=0.5,label='Risetime')
# errorbar(Vbias,1e3*ft_mean,yerr = 1e3*ft_mean_error,fmt='ro',alpha=0.5,label='Falltime')
# grid()
# legend()
# tight_layout
```

```{python}
# rt_nonorm = alldic['1']['alltod_folded_nonorm']['risetime']
# rt_norm = alldic['1']['alltod_folded_norm']['risetime']
# b = np.abs(rt_nonorm-rt_norm)

# # figure()
# # plot(b,'.')


# results = np.array([b]).T
# labels = tct.run_DBSCAN(results, doplot=True, parnames = ['Risetime diff'],eps_cpar=0.01,min_samples_cpar = 10)
```

```{python}
# # print(alldic['1'])#['alltod_folded_nonorm']['amplitude'])
# amps_1 = np.abs(alldic['1']['alltod_folded_nonorm']['amplitude'])
# ok = alldic['1']['ok']['Residuals'] & (amps_1<20000) & (amps_1>0)

# figure()
# hist(amps_1[ok],15)
```

```{python}
# figure()
# plot(d['alltod_folded_norm']['residuals_fit_folded_median'],d['alltod_folded_norm']['residuals_folded_median'],'.')
# plot(d['alltod_folded_norm']['residuals_fit_folded_median'],d['alltod_folded_norm']['residuals_fit_folded_median'])
# # show()
```

```{python}
# print(d['dataset_info'])
# print(d['Vbias'])
```
